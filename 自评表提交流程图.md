# 自评表提交到手动评分流程图

## 完整流程图

```
┌─────────────────────────────────────────────────────────────────┐
│                         教研室端操作                              │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌──────────────────┐
                    │  访问自评表页面   │
                    │  /self-evaluation │
                    └──────────────────┘
                              │
                              ▼
                    ┌──────────────────┐
                    │   填写新评分表    │
                    │  - 常规教学工作   │
                    │  - 特色亮点项目   │
                    │  - 负面清单      │
                    └──────────────────┘
                              │
                              ▼
                    ┌──────────────────┐
                    │  点击"提交表单"   │
                    └──────────────────┘
                              │
                              ▼
                    ┌──────────────────┐
                    │   确认提交对话框  │
                    └──────────────────┘
                              │
                              ▼
                    ┌──────────────────┐
                    │  保存自评表数据   │
                    │  POST /api/      │
                    │  teaching-office/ │
                    │  self-evaluation  │
                    └──────────────────┘
                              │
                              ▼
                    ┌──────────────────┐
                    │  提交并锁定表单   │
                    │  POST /api/      │
                    │  teaching-office/ │
                    │  self-evaluation/ │
                    │  {id}/submit     │
                    └──────────────────┘
                              │
                              ▼
                    ┌──────────────────┐
                    │ 状态: locked     │
                    └──────────────────┘
                              │
                              ▼
                    ┌──────────────────┐
                    │ 询问是否触发AI评分│
                    └──────────────────┘
                              │
                    ┌─────────┴─────────┐
                    │                   │
                   是                  否
                    │                   │
                    ▼                   ▼
          ┌──────────────────┐  ┌──────────────┐
          │  触发AI评分       │  │  稍后评分     │
          │  POST /api/      │  └──────────────┘
          │  teaching-office/ │
          │  trigger-ai-     │
          │  scoring         │
          └──────────────────┘
                    │
                    ▼
          ┌──────────────────┐
          │  AI评分处理中     │
          │  (后台任务)       │
          └──────────────────┘
                    │
                    ▼
          ┌──────────────────┐
          │  AI评分完成       │
          │  状态: ai_scored  │
          └──────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────┐
│                        考评小组端操作                             │
└─────────────────────────────────────────────────────────────────┘
                    │
                    ▼
          ┌──────────────────┐
          │  访问手动评分页面 │
          │  /manual-scoring  │
          └──────────────────┘
                    │
                    ▼
          ┌──────────────────┐
          │  获取待评分列表   │
          │  GET /api/       │
          │  scoring/        │
          │  evaluations-for-│
          │  scoring         │
          └──────────────────┘
                    │
                    ▼
          ┌──────────────────┐
          │  显示AI已评分的   │
          │  自评表列表       │
          │  - 教研室名称     │
          │  - 考评年度       │
          │  - 状态标签       │
          │  - 提交时间       │
          └──────────────────┘
                    │
                    ▼
          ┌──────────────────┐
          │  选择教研室       │
          │  点击"开始评分"   │
          └──────────────────┘
                    │
                    ▼
          ┌──────────────────┐
          │  显示评分表单     │
          │  ManualScoring   │
          │  Form组件        │
          └──────────────────┘
                    │
                    ▼
          ┌──────────────────┐
          │  填写评分         │
          │  - 各项指标评分   │
          │  - 评分说明       │
          └──────────────────┘
                    │
                    ▼
          ┌──────────────────┐
          │  提交评分         │
          │  POST /api/      │
          │  scoring/        │
          │  manual-score    │
          └──────────────────┘
                    │
                    ▼
          ┌──────────────────┐
          │  评分记录保存     │
          │  状态: manually_ │
          │  scored          │
          └──────────────────┘
                    │
                    ▼
          ┌──────────────────┐
          │  返回待评分列表   │
          └──────────────────┘
```

## 数据状态流转

```
draft (草稿)
  │
  │ 用户点击提交
  ▼
submitted (已提交)
  │
  │ 自动锁定
  ▼
locked (已锁定)
  │
  │ 触发AI评分
  ▼
ai_scored (AI已评分)
  │
  │ 考评小组评分
  ▼
manually_scored (已手动评分)
  │
  │ 考评办公室确定
  ▼
finalized (已确定最终得分)
  │
  │ 公示
  ▼
published (已公示)
```

## API调用时序图

```
教研室端                    后端API                    数据库
   │                         │                         │
   │  POST /self-evaluation  │                         │
   ├────────────────────────>│                         │
   │                         │  INSERT evaluation      │
   │                         ├────────────────────────>│
   │                         │<────────────────────────┤
   │<────────────────────────┤  evaluation_id          │
   │                         │                         │
   │  POST /{id}/submit      │                         │
   ├────────────────────────>│                         │
   │                         │  UPDATE status=locked   │
   │                         ├────────────────────────>│
   │                         │<────────────────────────┤
   │<────────────────────────┤  success                │
   │                         │                         │
   │  POST /trigger-ai-scoring│                        │
   ├────────────────────────>│                         │
   │                         │  启动后台任务            │
   │<────────────────────────┤  task_id                │
   │                         │                         │
   │                         │  (后台任务执行)          │
   │                         │  UPDATE status=ai_scored│
   │                         ├────────────────────────>│
   │                         │<────────────────────────┤
   │                         │                         │

考评小组端                  后端API                    数据库
   │                         │                         │
   │  GET /evaluations-for-  │                         │
   │  scoring?status=ai_scored│                        │
   ├────────────────────────>│                         │
   │                         │  SELECT evaluations     │
   │                         ├────────────────────────>│
   │                         │<────────────────────────┤
   │<────────────────────────┤  evaluation list        │
   │                         │                         │
   │  POST /manual-score     │                         │
   ├────────────────────────>│                         │
   │                         │  INSERT manual_score    │
   │                         ├────────────────────────>│
   │                         │<────────────────────────┤
   │<────────────────────────┤  score_record_id        │
   │                         │                         │
```

## 关键技术点

### 1. 表单数据结构
```typescript
{
  regularTeaching: {
    teachingPlan: { score: 10, evidence: "..." },
    teachingImplementation: { score: 10, evidence: "..." },
    // ... 8个指标
  },
  highlights: {
    honors: [{ name: "...", level: "...", score: 5 }],
    competitions: [...],
    innovations: [...],
    reforms: [...]
  },
  negativeList: {
    teachingAccidents: 0,
    studentComplaints: 0,
    violations: 0,
    other: 0
  }
}
```

### 2. 权限控制
- 教研室端：只能操作自己的自评表
- 考评小组/办公室：可以查看和评分所有自评表
- JWT token认证
- 角色基础访问控制（RBAC）

### 3. 状态锁定
- 提交后自动锁定（status: locked）
- 锁定后无法修改
- 只有管理端可以解锁（打回）

### 4. 异步处理
- AI评分使用后台任务（BackgroundTasks）
- 立即返回任务ID
- 不阻塞用户操作

## 测试检查清单

- [ ] 教研室端可以填写自评表
- [ ] 教研室端可以提交自评表
- [ ] 提交后自评表被锁定
- [ ] 可以触发AI评分
- [ ] AI评分完成后状态更新
- [ ] 考评小组端可以看到待评分列表
- [ ] 列表显示正确的教研室信息
- [ ] 可以选择教研室开始评分
- [ ] 可以填写并提交评分
- [ ] 评分记录正确保存
- [ ] 权限控制正常工作
- [ ] 错误处理正确显示

## 访问地址

- 教研室端自评表: http://localhost:3000/self-evaluation
- 考评小组端评分: http://localhost:3000/manual-scoring
- 后端API文档: http://localhost:8000/docs
