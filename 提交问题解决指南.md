# 提交问题解决指南

## 问题描述
无法提交表单到考评小组端的手动评分页面。

## 问题原因分析

### 1. 认证问题（主要原因）
- **现象**: 后端返回 401 Unauthorized
- **原因**: 用户没有登录或token无效
- **影响**: 所有需要认证的API都无法访问

### 2. 附件要求问题（已修复）
- **现象**: 提示"请先上传附件后再提交"
- **原因**: 后端强制要求必须有附件
- **解决**: 已修改为可选，不再强制要求附件

## 解决方案

### 方案1: 创建测试用户并登录（推荐）

#### 步骤1: 创建测试用户
```bash
cd backend
python ../create_test_user.py
```

这将创建以下测试账号：
- **教研室端**: test_teaching_office / password123
- **考评小组**: test_eval_team / password123
- **考评办公室**: test_eval_office / password123

#### 步骤2: 在前端登录
1. 访问 http://localhost:3000/login
2. 使用测试账号登录：
   - 用户名: `test_teaching_office`
   - 密码: `password123`
3. 登录成功后会获得token

#### 步骤3: 提交自评表
1. 访问 http://localhost:3000/self-evaluation
2. 填写自评表
3. 点击"提交表单"按钮
4. 确认提交

#### 步骤4: 验证结果
1. 退出登录
2. 使用考评小组账号登录：
   - 用户名: `test_eval_team`
   - 密码: `password123`
3. 访问 http://localhost:3000/manual-scoring
4. 应该能看到刚提交的自评表

### 方案2: 使用API测试脚本

#### 运行测试脚本
```bash
python test_login_and_submit.py
```

这个脚本会：
1. 登录获取token
2. 创建自评表
3. 提交自评表
4. 查看待评分列表

## 已修复的问题

### 1. 移除附件强制要求

**修改文件**: `backend/app/api/v1/endpoints/self_evaluation.py`

#### 提交自评表函数
```python
# 修改前
if attachments_count == 0:
    raise HTTPException(
        status_code=status.HTTP_400_BAD_REQUEST,
        detail="请先上传附件后再提交"
    )

# 修改后
# 注意：附件不是必需的，允许没有附件的情况下提交
# if attachments_count == 0:
#     raise HTTPException(
#         status_code=status.HTTP_400_BAD_REQUEST,
#         detail="请先上传附件后再提交"
#     )
```

#### AI评分函数
```python
# 修改前
if attachments_count == 0:
    raise HTTPException(
        status_code=status.HTTP_400_BAD_REQUEST,
        detail="自评表没有附件，无法进行AI评分"
    )

# 修改后
# 注意：附件不是必需的，允许没有附件的情况下进行AI评分
# if attachments_count == 0:
#     raise HTTPException(
#         status_code=status.HTTP_400_BAD_REQUEST,
#         detail="自评表没有附件，无法进行AI评分"
#     )
```

## 完整的提交流程

### 用户操作流程
```
1. 登录系统
   ↓
2. 访问自评表页面
   ↓
3. 填写自评表
   ↓
4. 点击"提交表单"
   ↓
5. 确认提交
   ↓
6. 系统处理（保存、提交、锁定）
   ↓
7. 选择是否触发AI评分
   ↓
8. 完成
```

### 系统处理流程
```
前端提交
    ↓
POST /api/teaching-office/self-evaluation
    ↓ (保存数据，获得 evaluation_id)
POST /api/teaching-office/self-evaluation/{id}/submit
    ↓ (提交并锁定，状态: locked)
POST /api/teaching-office/trigger-ai-scoring (可选)
    ↓ (AI评分，状态: ai_scored)
GET /api/scoring/evaluations-for-scoring
    ↓ (考评小组端获取列表)
显示在手动评分页面
```

## 测试步骤

### 1. 准备工作
```bash
# 确保服务运行
# 前端: http://localhost:3000
# 后端: http://localhost:8000
# 数据库: localhost:3306

# 创建测试用户
cd backend
python ../create_test_user.py
```

### 2. 测试登录
```bash
# 访问登录页面
http://localhost:3000/login

# 使用测试账号
用户名: test_teaching_office
密码: password123
```

### 3. 测试提交
```bash
# 访问自评表页面
http://localhost:3000/self-evaluation

# 填写表单并提交
点击"提交表单"按钮
```

### 4. 验证结果
```bash
# 切换到考评小组账号
用户名: test_eval_team
密码: password123

# 访问手动评分页面
http://localhost:3000/manual-scoring

# 应该能看到提交的自评表
```

## 常见问题

### Q1: 提示"Could not validate credentials"
**原因**: 没有登录或token过期

**解决**:
1. 访问登录页面
2. 使用测试账号登录
3. 重新提交

### Q2: 提示"请先上传附件后再提交"
**原因**: 使用的是旧版本的后端代码

**解决**:
1. 确保后端代码已更新
2. 重启后端服务
3. 刷新浏览器

### Q3: 在手动评分页面看不到提交的数据
**原因**: 
- 状态不是 `locked` 或 `ai_scored`
- 使用的账号角色不对
- 数据没有正确保存

**解决**:
1. 检查自评表状态
2. 使用考评小组或考评办公室账号登录
3. 查看数据库确认数据是否保存

### Q4: 提交后没有反应
**原因**: 
- 表单验证失败
- 网络连接问题
- 后端服务未启动

**解决**:
1. 打开浏览器控制台（F12）查看错误
2. 检查所有必填项是否填写
3. 确认后端服务运行正常

## 数据库验证

### 查看自评表
```sql
SELECT id, teaching_office_id, evaluation_year, status, submitted_at 
FROM self_evaluations 
ORDER BY created_at DESC 
LIMIT 5;
```

### 查看用户
```sql
SELECT id, username, name, role 
FROM users 
WHERE username LIKE 'test_%';
```

### 查看教研室
```sql
SELECT id, name 
FROM teaching_offices 
WHERE id = 'test-office-001';
```

## 后端日志检查

### 查看后端输出
```bash
# 查看进程ID: 1 的输出
# 应该能看到API请求日志
```

### 正常的日志示例
```
INFO: POST /api/auth/login - 200 OK
INFO: POST /api/teaching-office/self-evaluation - 201 Created
INFO: POST /api/teaching-office/self-evaluation/{id}/submit - 200 OK
INFO: GET /api/scoring/evaluations-for-scoring - 200 OK
```

### 错误的日志示例
```
INFO: POST /api/teaching-office/self-evaluation - 401 Unauthorized
```

## 创建的文件

1. **create_test_user.py** - 创建测试用户脚本
2. **test_login_and_submit.py** - 测试登录和提交流程脚本
3. **提交问题解决指南.md** - 本文档

## 修改的文件

1. **backend/app/api/v1/endpoints/self_evaluation.py**
   - 移除了附件强制要求
   - 允许没有附件的情况下提交和AI评分

## 下一步操作

### 立即执行
1. 创建测试用户：
   ```bash
   cd backend
   python ../create_test_user.py
   ```

2. 登录前端：
   - 访问 http://localhost:3000/login
   - 用户名: test_teaching_office
   - 密码: password123

3. 提交自评表：
   - 访问 http://localhost:3000/self-evaluation
   - 填写并提交

4. 验证结果：
   - 切换到考评小组账号
   - 访问 http://localhost:3000/manual-scoring
   - 查看提交的数据

### 如果还有问题
1. 查看浏览器控制台错误
2. 查看后端日志
3. 查看数据库数据
4. 运行测试脚本验证API

## 总结

### 问题根源
- ✅ 认证问题（需要登录）
- ✅ 附件要求（已修改为可选）

### 解决方案
- ✅ 创建测试用户
- ✅ 登录获取token
- ✅ 移除附件强制要求

### 验证方法
- ✅ 使用测试脚本
- ✅ 手动测试流程
- ✅ 查看数据库数据

现在应该可以正常提交表单到考评小组端了！🎉
