# 最终解决方案 - 403错误修复

## 问题总结

从截图看到的所有错误都源于同一个根本原因：

**MySQL数据库未正确配置** → 表不存在 → 后端无法验证用户 → 所有API返回403错误

---

## 一键解决方案

### 步骤1：设置MySQL密码并初始化数据库

**右键点击** `setup_mysql_password.bat` → **以管理员身份运行**

这个脚本会：
1. ✅ 提示你输入当前MySQL密码
2. ✅ 将密码设置为 'root'
3. ✅ 创建所有数据库表
4. ✅ 初始化测试数据

### 步骤2：重启后端服务

1. 找到运行后端的命令行窗口
2. 按 `Ctrl + C` 停止服务
3. 重新运行：
   ```bash
   cd backend
   python -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
   ```

### 步骤3：验证修复

1. 刷新浏览器（`Ctrl + F5`）
2. 使用测试账号登录：
   - 教研室端: `director1` / `password123`
   - 评教小组: `evaluator1` / `password123`
   - 办公室: `office1` / `password123`
   - 校长办公会: `president1` / `password123`

---

## 手动解决方案（如果自动脚本失败）

### 1. 设置MySQL密码

打开命令提示符（管理员），执行：

```bash
# 连接MySQL（输入当前密码）
mysql -u root -p

# 在MySQL命令行中执行：
ALTER USER 'root'@'localhost' IDENTIFIED BY 'root';
FLUSH PRIVILEGES;
EXIT;

# 验证新密码
mysql -u root -proot -e "SELECT 1;"
```

### 2. 创建数据库表

```bash
cd backend
Get-Content create_tables.sql | mysql -u root -proot
```

### 3. 初始化测试数据

```bash
Get-Content init_test_data.sql | mysql -u root -proot
```

### 4. 验证数据库

```bash
cd ..
python verify_database_setup.py
```

应该看到：
```
✅ 找到 3 个教研室
✅ 找到 7 个用户
✅ 数据库设置完成
```

---

## 验证修复成功

### 后端验证

访问 http://localhost:8000/docs

应该能看到API文档页面，不再有数据库错误。

### 前端验证

1. 访问 http://localhost:3000
2. 登录 `director1` / `password123`
3. 进入"填写自评表"页面
4. 填写表单内容
5. 点击"提交表单"
6. **不应该再看到403错误**

### 手动评分验证

1. 登录 `evaluator1` / `password123`
2. 进入"手动评分"页面
3. 应该能看到待评分的自评表
4. 填写评分
5. 提交评分
6. **不应该再看到403或404错误**

---

## 常见问题

### Q1: 运行脚本后还是403错误

**检查清单：**
- [ ] MySQL密码已设置为 'root'
  ```bash
  mysql -u root -proot -e "SELECT 1;"
  ```
- [ ] 数据库表已创建
  ```bash
  mysql -u root -proot -e "USE teaching_office_evaluation; SHOW TABLES;"
  ```
- [ ] 测试数据已初始化
  ```bash
  python verify_database_setup.py
  ```
- [ ] 后端服务已重启
- [ ] 浏览器缓存已清除

### Q2: 找不到MySQL命令

MySQL可能没有添加到系统PATH。

**解决方法：**
```bash
# 找到MySQL安装目录，通常在：
C:\Program Files\MySQL\MySQL Server 8.0\bin\

# 使用完整路径执行命令
"C:\Program Files\MySQL\MySQL Server 8.0\bin\mysql.exe" -u root -p
```

### Q3: 后端启动时报数据库连接错误

检查 `backend/.env` 文件：
```properties
MYSQL_PASSWORD=root
```

确保密码是 'root'。

### Q4: 表已存在的错误

这是正常的，SQL脚本使用了 `IF NOT EXISTS`，不会重复创建表。

---

## 技术细节

### 为什么会出现403错误？

1. 数据库表不存在
2. 后端无法查询用户信息
3. 用户认证失败
4. 所有需要认证的API返回403

### 修复做了什么？

1. ✅ 设置MySQL密码为 'root'（与配置文件匹配）
2. ✅ 创建所有数据库表（使用MySQL兼容的SQL）
3. ✅ 初始化测试用户和教研室数据
4. ✅ 重启后端服务使配置生效

### 为什么不用Alembic迁移？

Alembic迁移脚本使用了PostgreSQL的UUID类型，在MySQL中不兼容。

我们直接使用SQL脚本创建表，使用 `CHAR(36)` 存储UUID，这在MySQL中完全兼容。

---

## 成功标志

修复成功后，你应该能够：

✅ 教研室端填写并提交自评表
✅ 上传附件
✅ 评教小组进行手动评分
✅ 办公室查看评分结果
✅ 校长办公会审批结果

所有功能都应该正常工作，不再出现403或404错误。

---

## 需要帮助？

如果以上步骤都无法解决问题，请提供：

1. `setup_mysql_password.bat` 的完整输出
2. `verify_database_setup.py` 的完整输出
3. 后端服务启动时的完整日志
4. 浏览器控制台的完整错误信息

这将帮助我们更快地定位问题。
