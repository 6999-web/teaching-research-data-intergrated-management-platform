# 文件上传问题修复完成

## 修复时间
2026-02-13

## 🐛 问题描述
用户无法上传文件，返回422错误（Unprocessable Content）。

## 🔍 问题根因

### 问题1: 参数命名不匹配
- **前端**: 发送`evaluationId`（驼峰命名）
- **后端**: 期望`evaluation_id`（蛇形命名）
- **影响**: FastAPI无法解析Form参数，返回422错误

### 问题2: evaluation_id值无效
- **前端**: 使用硬编码字符串`'eval-001'`
- **后端**: 期望UUID格式
- **影响**: 即使参数名正确，UUID验证也会失败

## ✅ 修复方案

### 1. 修改前端参数名为蛇形命名

**文件**: `frontend/src/components/AttachmentUpload.vue`

```typescript
// 修改前
const uploadData = computed(() => {
  return {
    evaluationId: props.evaluationId,
    indicator: uploadForm.indicator
  }
})

// 修改后
const uploadData = computed(() => {
  return {
    evaluation_id: props.evaluationId,  // 使用蛇形命名
    indicator: uploadForm.indicator
  }
})
```

### 2. 使用实际的evaluation_id

**文件**: `frontend/src/views/TeachingOfficeHome.vue`

#### 2.1 添加状态变量
```typescript
// 保存当前的evaluation_id，用于附件上传
const currentEvaluationId = ref<string>('')
```

#### 2.2 在提交自评表时保存ID
```typescript
const evaluationId = saveResponse.data.evaluation_id

// 保存evaluation_id供附件上传使用
currentEvaluationId.value = evaluationId
```

#### 2.3 切换到附件页面时自动创建草稿
```typescript
const selectMenu = async (index: number) => {
  activeMenu.value = index
  activeTab.value = 0
  
  // 如果切换到材料提交页面，且还没有evaluation_id，先创建草稿
  if (index === 1 && !currentEvaluationId.value) {
    try {
      const saveResponse = await selfEvaluationApi.save({
        teaching_office_id: authStore.teachingOfficeId || 'a1b2c3d4-e5f6-4a5b-8c9d-111111111111',
        evaluation_year: new Date().getFullYear(),
        content: {} // 空内容，创建草稿
      })
      currentEvaluationId.value = saveResponse.data.evaluation_id
    } catch (error) {
      console.error('Failed to create draft evaluation:', error)
      ElMessage.error('无法创建自评表草稿，请先填写自评表')
      activeMenu.value = 0 // 返回到自评表页面
    }
  }
}
```

#### 2.4 使用实际的evaluation_id
```vue
<AttachmentUpload
  v-if="activeMenu === 1"
  :evaluation-id="currentEvaluationId || 'a1b2c3d4-e5f6-4a5b-8c9d-000000000000'"
  :evaluation-year="new Date().getFullYear()"
  :is-locked="false"
  @submit="handleAttachmentSubmit"
  @back="handleAttachmentBack"
/>
```

## 📝 修改的文件列表

1. ✅ `frontend/src/components/AttachmentUpload.vue` - 修改参数名
2. ✅ `frontend/src/views/TeachingOfficeHome.vue` - 添加evaluation_id管理

## 🧪 测试步骤

### 方案A: 先提交自评表，再上传附件

1. **登录系统**
   - 访问: http://localhost:3000
   - 用户名: `123`, 密码: `123123`

2. **填写并提交自评表**
   - 点击"填写自评表"
   - 填写表单内容
   - 点击"提交"按钮
   - ✅ 提交成功

3. **上传附件**
   - 点击"材料提交"
   - 选择考核指标（如"荣誉表彰"）
   - 拖拽或点击上传文件
   - ✅ 文件应该成功上传

### 方案B: 直接上传附件（自动创建草稿）

1. **登录系统**
   - 访问: http://localhost:3000
   - 用户名: `123`, 密码: `123123`

2. **直接进入材料提交**
   - 点击"材料提交"
   - 系统自动创建自评表草稿
   - 选择考核指标
   - 上传文件
   - ✅ 文件应该成功上传

## 🎯 预期结果

- ✅ 文件上传不再返回422错误
- ✅ 上传进度正常显示
- ✅ 上传成功后显示在"已上传附件"列表
- ✅ "提交附件"按钮变为可点击状态
- ✅ 可以成功提交附件

## ⚠️ 注意事项

1. **刷新页面**: 修改后需要刷新浏览器（F5）
2. **清除缓存**: 如果问题仍存在，清除浏览器缓存
3. **重新登录**: 建议退出后重新登录
4. **后端运行**: 确保后端服务正在运行

## 🔍 调试信息

### 检查后端日志
```bash
# 查看后端进程输出
# 应该看到类似这样的成功日志：
INFO: 127.0.0.1:xxxxx - "POST /api/teaching-office/attachments HTTP/1.1" 201 Created
```

### 检查浏览器控制台
- 打开开发者工具（F12）
- 查看Network标签
- 找到attachments请求
- 检查Request Payload是否包含正确的`evaluation_id`和`indicator`

## 📊 后端期望的数据格式

```python
@router.post("/attachments")
async def upload_attachments(
    evaluation_id: UUID = Form(...),  # 必需，UUID格式
    indicator: str = Form(...),        # 必需，字符串
    files: List[UploadFile] = File(...) # 必需，文件列表
):
```

## 🎉 修复完成

所有文件上传相关的问题已修复：
- ✅ 参数命名匹配
- ✅ evaluation_id格式正确
- ✅ 自动创建草稿功能
- ✅ 上传流程完整

现在可以正常上传文件了！
