# 问题诊断和解决方案

## 问题1：教研室端无法提交考评表 ✅ 已修复

### 原因
`TeachingOfficeHome.vue` 使用的是旧的 `SelfEvaluationForm` 组件，该组件有"请先保存表单后再提交"的逻辑。

### 解决方案
已将 `TeachingOfficeHome.vue` 中的组件替换为 `NewSelfEvaluationForm`，并添加了完整的提交逻辑。

### 修改的文件
- `frontend/src/views/TeachingOfficeHome.vue`

### 修改内容
1. 导入 `NewSelfEvaluationForm` 替代 `SelfEvaluationForm`
2. 添加 `handleSubmit` 函数，实现自动保存→提交→AI评分
3. 移除旧的 `handleSave` 和 `handlePreview` 函数

## 问题2：考评小组端无法显示考评表

### 可能的原因

1. **后端服务未启动**
   - 检查后端是否在运行
   - 访问 http://localhost:8000/docs 查看API文档

2. **认证问题**
   - API需要JWT token
   - 检查是否正确登录

3. **数据库中没有数据**
   - 检查是否有已提交的自评表

4. **API路由问题**
   - 检查后端路由配置

### 诊断步骤

#### 步骤1：检查后端服务

打开浏览器访问：
```
http://localhost:8000/docs
```

如果无法访问，说明后端未启动。启动命令：
```bash
cd backend
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

#### 步骤2：检查登录状态

1. 打开浏览器开发者工具（F12）
2. 切换到 Console 标签
3. 输入：
```javascript
localStorage.getItem('token')
```

如果返回 `null`，说明未登录。

#### 步骤3：检查API调用

1. 在手动评分页面，打开开发者工具（F12）
2. 切换到 Network 标签
3. 刷新页面
4. 查找 `evaluations-for-scoring` 请求
5. 查看响应状态和数据

**可能的错误**：
- 401 Unauthorized - 未登录或token过期
- 403 Forbidden - 权限不足
- 404 Not Found - API路由不存在
- 500 Internal Server Error - 后端错误

#### 步骤4：检查数据库

在MySQL中执行：
```sql
USE teaching_office_evaluation;

-- 查看所有自评表
SELECT 
    se.id,
    to.name as teaching_office_name,
    se.evaluation_year,
    se.status,
    se.submitted_at,
    se.created_at
FROM self_evaluations se
LEFT JOIN teaching_offices to ON se.teaching_office_id = to.id
ORDER BY se.created_at DESC;

-- 查看待评分的自评表
SELECT 
    se.id,
    to.name as teaching_office_name,
    se.status
FROM self_evaluations se
LEFT JOIN teaching_offices to ON se.teaching_office_id = to.id
WHERE se.status IN ('locked', 'ai_scored');
```

### 快速修复方案

#### 方案1：重新登录

1. 退出登录
2. 清除浏览器缓存
3. 重新登录考评小组账号：
   - 用户名：`test_eval_team`
   - 密码：`password123`

#### 方案2：检查后端日志

查看后端控制台输出，查找错误信息。

#### 方案3：手动测试API

使用浏览器或Postman测试API：

1. 先登录获取token：
```bash
POST http://localhost:8000/api/auth/login
Content-Type: application/json

{
  "username": "test_eval_team",
  "password": "password123",
  "role": "evaluation_team"
}
```

2. 使用token调用API：
```bash
GET http://localhost:8000/api/scoring/evaluations-for-scoring
Authorization: Bearer {your_token_here}
```

## 完整测试流程

### 1. 启动服务

**后端**：
```bash
cd backend
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

**前端**（已启动）：
```bash
cd frontend
npm run dev
```

### 2. 测试教研室端提交

1. 访问：http://localhost:3000/login
2. 登录教研室端：
   - 用户名：`test_teaching_office`
   - 密码：`password123`
3. 点击左侧"填写自评表"
4. 填写所有必填项
5. 点击"提交表单"
6. **预期**：显示"提交成功！数据已上传到考评小组端"

### 3. 测试考评小组端查看

1. 退出登录
2. 登录考评小组：
   - 用户名：`test_eval_team`
   - 密码：`password123`
3. 访问手动评分页面
4. **预期**：看到刚提交的表单

## 调试技巧

### 浏览器控制台

打开F12，查看：
- Console：JavaScript错误
- Network：API请求和响应
- Application：localStorage中的token

### 后端日志

查看后端控制台输出：
- API请求日志
- 错误堆栈
- SQL查询日志

### 数据库查询

直接查询数据库确认数据：
```sql
-- 查看用户
SELECT * FROM users WHERE username LIKE 'test_%';

-- 查看教研室
SELECT * FROM teaching_offices;

-- 查看自评表
SELECT * FROM self_evaluations ORDER BY created_at DESC LIMIT 5;
```

## 常见错误及解决

### 错误1：401 Unauthorized

**原因**：未登录或token过期

**解决**：
1. 重新登录
2. 检查token是否存在：`localStorage.getItem('token')`

### 错误2：403 Forbidden

**原因**：权限不足，使用了错误的角色

**解决**：
1. 确认使用考评小组或考评办公室账号
2. 检查用户角色：`localStorage.getItem('userRole')`

### 错误3：No Data

**原因**：数据库中没有待评分的自评表

**解决**：
1. 先在教研室端提交一个表单
2. 检查数据库中是否有 status='locked' 或 'ai_scored' 的记录

### 错误4：Network Error

**原因**：后端服务未启动或无法连接

**解决**：
1. 检查后端是否运行
2. 访问 http://localhost:8000/docs
3. 检查防火墙设置

## 下一步

1. 确认后端服务正常运行
2. 确认已正确登录
3. 测试完整流程
4. 如果仍有问题，提供：
   - 浏览器控制台错误信息
   - 后端日志
   - 数据库查询结果
