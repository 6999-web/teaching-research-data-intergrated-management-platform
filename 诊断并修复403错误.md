# 诊断并修复403错误

## 问题
提交自评表时出现403 Forbidden错误，发生在保存自评表的步骤。

## 快速修复步骤

### 步骤1：完全清除浏览器数据
在浏览器控制台（F12）中执行：
```javascript
// 清除所有存储
localStorage.clear()
sessionStorage.clear()

// 清除所有cookies
document.cookie.split(";").forEach(function(c) { 
  document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
});

// 刷新页面
location.reload()
```

### 步骤2：重新登录
1. 访问 http://localhost:3000
2. 点击"教研室端"卡片
3. 输入：
   - 用户名：`office1`
   - 密码：`password123`
4. 点击"登录"

### 步骤3：验证登录状态
在控制台执行：
```javascript
// 检查token
const token = localStorage.getItem('token')
console.log('Token存在:', !!token)
console.log('Token长度:', token ? token.length : 0)

// 检查用户信息
console.log('User ID:', localStorage.getItem('userId'))
console.log('User Name:', localStorage.getItem('userName'))
console.log('User Role:', localStorage.getItem('userRole'))
console.log('Teaching Office ID:', localStorage.getItem('teachingOfficeId'))

// 验证token是否有效
fetch('/api/auth/verify', {
  headers: {
    'Authorization': `Bearer ${token}`
  }
})
.then(res => {
  console.log('Token验证状态:', res.status)
  return res.json()
})
.then(data => console.log('Token验证结果:', data))
.catch(err => console.error('Token验证失败:', err))
```

### 步骤4：测试API访问
```javascript
// 测试保存自评表API
const token = localStorage.getItem('token')
const teachingOfficeId = localStorage.getItem('teachingOfficeId')

fetch('/api/teaching-office/self-evaluation', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    teaching_office_id: teachingOfficeId || 'a1b2c3d4-e5f6-4a5b-8c9d-111111111111',
    evaluation_year: 2026,
    content: {
      test: 'test'
    }
  })
})
.then(res => {
  console.log('API响应状态:', res.status)
  return res.json()
})
.then(data => console.log('API响应数据:', data))
.catch(err => console.error('API调用失败:', err))
```

## 可能的原因和解决方案

### 原因1：Token无效或过期
**症状**: 
- localStorage中有token
- 但API调用返回403

**解决方案**:
```javascript
// 清除并重新登录
localStorage.clear()
location.reload()
```

### 原因2：用户角色不匹配
**症状**:
- userRole不是"teaching_office"
- 或者userRole为空

**解决方案**:
1. 确保从"教研室端"入口登录
2. 不要从"管理端"入口登录

### 原因3：Teaching Office ID缺失
**症状**:
- teachingOfficeId为null或undefined

**解决方案**:
检查数据库中用户的teaching_office_id字段：
```sql
SELECT id, username, role, teaching_office_id
FROM users
WHERE username = 'office1';
```

如果为空，更新它：
```sql
UPDATE users
SET teaching_office_id = 'a1b2c3d4-e5f6-4a5b-8c9d-111111111111'
WHERE username = 'office1';
```

### 原因4：后端服务问题
**症状**:
- 所有API都返回403
- 或者后端没有响应

**解决方案**:
1. 检查后端是否运行：
```bash
netstat -ano | findstr ":8000"
```

2. 重启后端服务：
```bash
cd backend
# 停止现有进程（Ctrl+C）
# 重新启动
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

## 详细诊断

### 检查1：浏览器Network标签
1. 打开开发者工具（F12）
2. 切换到Network标签
3. 提交表单
4. 找到失败的请求
5. 查看：
   - Request Headers中的Authorization
   - Request Payload
   - Response内容

### 检查2：后端日志
```bash
cd backend
tail -f error.log
```

查找包含403或Forbidden的行。

### 检查3：数据库连接
```bash
cd backend
python check_database.py
```

## 完整的重置流程

如果上述方法都不行，执行完整重置：

### 1. 停止所有服务
```bash
# 停止前端（Ctrl+C）
# 停止后端（Ctrl+C）
```

### 2. 清除浏览器数据
```javascript
localStorage.clear()
sessionStorage.clear()
// 清除cookies
// 关闭浏览器
```

### 3. 重启后端
```bash
cd backend
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

### 4. 重启前端
```bash
cd frontend
npm run dev
```

### 5. 重新登录测试
1. 打开新的浏览器窗口
2. 访问 http://localhost:3000
3. 登录
4. 测试提交

## 预期的正确状态

### LocalStorage应该包含
```
token: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." (长字符串)
userId: "a1b2c3d4-e5f6-4a5b-8c9d-111111111111"
userName: "office1"
userRole: "teaching_office"
teachingOfficeId: "a1b2c3d4-e5f6-4a5b-8c9d-111111111111"
```

### Token验证应该返回
```json
{
  "valid": true,
  "userId": "a1b2c3d4-e5f6-4a5b-8c9d-111111111111",
  "role": "teaching_office"
}
```

### API调用应该返回
```json
{
  "evaluation_id": "uuid",
  "status": "draft",
  "created_at": "2026-02-14T..."
}
```

## 如果问题仍然存在

请提供以下信息：
1. LocalStorage的完整内容（截图）
2. Network标签中失败请求的详细信息（截图）
3. 后端error.log的最后50行
4. 数据库中users表的office1用户信息

## 相关文档
- `快速修复-登录和提交问题.md`
- `登录问题诊断和修复.md`
- `提交到考评小组问题修复.md`
