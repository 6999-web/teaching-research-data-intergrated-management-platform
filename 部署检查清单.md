# 部署检查清单

## 服务器信息
- **IP 地址**: 101.33.211.98
- **操作系统**: Linux (Ubuntu/Debian 推荐)
- **数据库**: SQLite

---

## 部署前检查

### 1. 服务器环境
- [ ] 服务器可以通过 SSH 访问
- [ ] 服务器有足够的磁盘空间 (至少 10GB)
- [ ] 服务器有足够的内存 (至少 2GB)
- [ ] 服务器可以访问互联网

### 2. 必需软件
- [ ] Python 3.8+ 已安装
- [ ] Node.js 16+ 已安装
- [ ] Nginx 已安装（或准备安装）
- [ ] Git 已安装

### 3. 端口检查
- [ ] 端口 80 (HTTP) 可用
- [ ] 端口 443 (HTTPS) 可用（如果使用 HTTPS）
- [ ] 端口 8000 (后端 API) 可用
- [ ] 端口 3000 (前端，可选) 可用

### 4. 防火墙配置
- [ ] 防火墙允许端口 80
- [ ] 防火墙允许端口 443（如果使用 HTTPS）
- [ ] 防火墙允许端口 8000

---

## 快速部署步骤

### 方法 A：使用自动部署脚本（推荐）

```bash
# 1. 上传代码到服务器
scp -r ./* root@101.33.211.98:/opt/teaching-office/

# 2. SSH 登录服务器
ssh root@101.33.211.98

# 3. 进入项目目录
cd /opt/teaching-office

# 4. 运行部署脚本
chmod +x deploy-simple.sh
bash deploy-simple.sh
```

### 方法 B：手动部署

#### 1. 部署后端

```bash
# 进入后端目录
cd backend

# 创建虚拟环境
python3 -m venv venv
source venv/bin/activate

# 安装依赖
pip install -r requirements.txt

# 初始化数据库
python init_sqlite.py

# 启动后端（测试）
uvicorn app.main:app --host 0.0.0.0 --port 8000

# 或使用 Gunicorn（生产环境）
gunicorn app.main:app -w 4 -k uvicorn.workers.UvicornWorker --bind 0.0.0.0:8000
```

#### 2. 部署前端

```bash
# 进入前端目录
cd frontend

# 安装依赖
npm install

# 构建生产版本
npm run build

# 将 dist 目录复制到 Nginx 目录
sudo cp -r dist/* /var/www/teaching-office/
```

#### 3. 配置 Nginx

```bash
# 创建 Nginx 配置文件
sudo nano /etc/nginx/sites-available/teaching-office

# 粘贴以下配置：
```

```nginx
server {
    listen 80;
    server_name 101.33.211.98;

    # 前端静态文件
    location / {
        root /var/www/teaching-office;
        index index.html;
        try_files $uri $uri/ /index.html;
    }

    # 后端 API 代理
    location /api/ {
        proxy_pass http://127.0.0.1:8000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 文件上传
    location /api/teaching-office/attachments {
        client_max_body_size 500M;
        proxy_pass http://127.0.0.1:8000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
    }
}
```

```bash
# 启用站点
sudo ln -s /etc/nginx/sites-available/teaching-office /etc/nginx/sites-enabled/
sudo rm /etc/nginx/sites-enabled/default

# 测试配置
sudo nginx -t

# 重启 Nginx
sudo systemctl restart nginx
```

---

## 部署后检查

### 1. 服务状态检查
```bash
# 检查后端服务
systemctl status teaching-office-backend

# 检查 Nginx 服务
systemctl status nginx

# 查看后端日志
journalctl -u teaching-office-backend -f
```

### 2. 功能测试

#### 后端 API 测试
```bash
# 健康检查
curl http://101.33.211.98:8000/health

# API 文档
curl http://101.33.211.98:8000/docs
```

访问浏览器：
- API 文档: http://101.33.211.98:8000/docs
- API 健康检查: http://101.33.211.98:8000/health

#### 前端测试
访问浏览器：
- 前端首页: http://101.33.211.98
- 登录页面: http://101.33.211.98/login
- 数据大屏: http://101.33.211.98/data-dashboard

### 3. 登录测试

使用默认账号登录：

**教研室端**
- 用户名: `director1`
- 密码: `password123`

**管理端 - 评教小组**
- 用户名: `evaluator1`
- 密码: `password123`

**管理端 - 评教小组办公室**
- 用户名: `office1`
- 密码: `password123`

**管理端 - 校长办公会**
- 用户名: `president1`
- 密码: `password123`

### 4. 数据库检查
```bash
# 查看数据库文件
ls -lh backend/teaching_office_evaluation.db

# 查看数据库内容
sqlite3 backend/teaching_office_evaluation.db "SELECT * FROM users;"
```

---

## 常见问题排查

### 问题 1: 无法访问前端
**检查**:
```bash
# 检查 Nginx 状态
systemctl status nginx

# 检查 Nginx 错误日志
tail -f /var/log/nginx/error.log

# 检查文件权限
ls -la /var/www/teaching-office/
```

**解决**:
```bash
# 重启 Nginx
systemctl restart nginx

# 检查防火墙
ufw status
ufw allow 80/tcp
```

### 问题 2: API 请求失败
**检查**:
```bash
# 检查后端服务状态
systemctl status teaching-office-backend

# 查看后端日志
journalctl -u teaching-office-backend -n 50

# 测试后端直接访问
curl http://127.0.0.1:8000/health
```

**解决**:
```bash
# 重启后端服务
systemctl restart teaching-office-backend

# 检查端口占用
netstat -tlnp | grep 8000
```

### 问题 3: 数据库错误
**检查**:
```bash
# 查看数据库文件
ls -lh backend/teaching_office_evaluation.db

# 检查文件权限
chmod 644 backend/teaching_office_evaluation.db
```

**解决**:
```bash
# 重新初始化数据库
cd backend
rm teaching_office_evaluation.db
python init_sqlite.py
```

### 问题 4: CORS 错误
**检查**: 查看浏览器控制台错误信息

**解决**: 确保 `backend/app/core/config.py` 中的 CORS 配置包含你的域名：
```python
BACKEND_CORS_ORIGINS: List[str] = [
    "http://101.33.211.98",
    "http://101.33.211.98:80",
    # ... 其他地址
]
```

---

## 性能优化建议

### 1. 启用 Gzip 压缩
在 Nginx 配置中添加：
```nginx
gzip on;
gzip_types text/plain text/css application/json application/javascript text/xml application/xml;
```

### 2. 启用缓存
```nginx
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
}
```

### 3. 使用 Gunicorn 多进程
```bash
gunicorn app.main:app -w 4 -k uvicorn.workers.UvicornWorker --bind 0.0.0.0:8000
```

### 4. 定期备份数据库
```bash
# 创建备份脚本
cat > /opt/backup-db.sh << 'EOF'
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
cp /opt/teaching-office/backend/teaching_office_evaluation.db \
   /opt/backups/teaching_office_evaluation_$DATE.db
find /opt/backups/ -name "*.db" -mtime +7 -delete
EOF

chmod +x /opt/backup-db.sh

# 添加到 crontab（每天凌晨 2 点备份）
crontab -e
# 添加: 0 2 * * * /opt/backup-db.sh
```

---

## 安全建议

### 1. 修改默认密码
登录后立即修改所有默认账号的密码。

### 2. 配置 HTTPS
```bash
# 安装 Certbot
apt-get install certbot python3-certbot-nginx

# 获取 SSL 证书
certbot --nginx -d your-domain.com
```

### 3. 配置防火墙
```bash
# 启用 UFW
ufw enable

# 只允许必要的端口
ufw allow 22/tcp   # SSH
ufw allow 80/tcp   # HTTP
ufw allow 443/tcp  # HTTPS
```

### 4. 定期更新
```bash
# 更新系统包
apt-get update && apt-get upgrade -y

# 更新 Python 依赖
cd backend
source venv/bin/activate
pip install --upgrade -r requirements.txt
```

---

## 监控和日志

### 查看日志
```bash
# 后端日志
journalctl -u teaching-office-backend -f

# Nginx 访问日志
tail -f /var/log/nginx/access.log

# Nginx 错误日志
tail -f /var/log/nginx/error.log
```

### 监控资源使用
```bash
# CPU 和内存使用
htop

# 磁盘使用
df -h

# 数据库文件大小
du -h backend/teaching_office_evaluation.db
```

---

## 联系支持

如果遇到问题，请检查：
1. 服务器日志
2. 浏览器控制台
3. 网络连接
4. 防火墙设置

---

**文档版本**: v1.0  
**更新日期**: 2024年  
**服务器 IP**: 101.33.211.98
