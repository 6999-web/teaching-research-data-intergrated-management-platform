# 403 错误根本原因分析和完整修复方案

## 问题现象

- **错误**: 403 Forbidden
- **接口**: `POST /api/teaching-office/self-evaluation`
- **用户**: director1 (teaching_office 角色)
- **状态**: 登录成功，但提交自评表时被拒绝

## 根本原因分析

### 问题 1: 权限检查逻辑问题

后端的权限检查使用了 `RoleChecker` 类，但可能存在以下问题：

1. **用户角色不匹配** - 数据库中的用户角色可能不是 `teaching_office`
2. **Token 中的角色信息不正确** - Token 可能包含错误的角色
3. **权限检查没有正确执行** - `RoleChecker` 的实现可能有问题

### 问题 2: 数据库初始化问题

初始化脚本 `init_test_data.sql` 中定义了 `director1` 用户，但：

1. 脚本可能没有被执行
2. 数据库中可能没有这个用户
3. 用户的角色可能被错误地设置

## 完整修复方案

### 步骤 1: 添加调试日志

**文件**: `backend/app/core/deps.py`

在 `RoleChecker.__call__()` 方法中添加日志：

```python
def __call__(self, current_user: User = Depends(get_current_user)) -> User:
    import logging
    logger = logging.getLogger(__name__)
    logger.info(f"RoleChecker: Checking user {current_user.username} with role {current_user.role} against allowed roles {self.allowed_roles}")
    
    if current_user.role not in self.allowed_roles:
        logger.error(f"RoleChecker: Access denied for user {current_user.username}. Role {current_user.role} not in {self.allowed_roles}")
        raise HTTPException(
            status_code=status.HTTP_403_FORBIDDEN,
            detail=f"Access denied. Required roles: {', '.join(self.allowed_roles)}. Your role: {current_user.role}"
        )
    logger.info(f"RoleChecker: Access granted for user {current_user.username}")
    return current_user
```

### 步骤 2: 检查数据库中的用户

执行以下 SQL 查询来检查用户角色：

```sql
SELECT username, role, name FROM users WHERE username = 'director1';
```

**预期结果**:
```
username | role | name
---------|------|------
director1 | teaching_office | 张主任
```

如果用户不存在或角色不正确，执行以下 SQL 来修复：

```sql
-- 如果用户不存在，插入新用户
INSERT INTO users (id, username, password_hash, role, teaching_office_id, name, email, created_at, updated_at) 
VALUES (
    UUID(),
    'director1',
    '$2b$12$LQv3c1yqBWVHxkd0LHAkCOYz6TtxMQJqhN8/LewY5GyYIr.oPfHiq',  -- password123
    'teaching_office',
    UUID(),
    '张主任',
    'director1@example.com',
    NOW(),
    NOW()
);

-- 如果用户存在但角色不正确，更新角色
UPDATE users SET role = 'teaching_office' WHERE username = 'director1';
```

### 步骤 3: 验证 Token 中的角色信息

在浏览器控制台中执行以下代码来检查 Token：

```javascript
// 获取 Token
const token = localStorage.getItem('token');
console.log('Token:', token);

// 解码 Token（使用 jwt.io 或以下代码）
const parts = token.split('.');
const payload = JSON.parse(atob(parts[1]));
console.log('Token payload:', payload);
console.log('Role in token:', payload.role);
```

**预期结果**:
```
Token payload: {
  sub: "director1",
  user_id: "...",
  role: "teaching_office",
  exp: ...
}
```

### 步骤 4: 检查后端日志

重启后端后，查看日志中的权限检查信息：

```
INFO:     RoleChecker: Checking user director1 with role teaching_office against allowed roles ['teaching_office']
INFO:     RoleChecker: Access granted for user director1
```

如果看到以下日志，说明权限检查失败：

```
ERROR:    RoleChecker: Access denied for user director1. Role evaluation_team not in ['teaching_office']
```

这表示用户的角色不是 `teaching_office`。

## 可能的解决方案

### 解决方案 A: 修复数据库中的用户角色

如果数据库中的用户角色不正确，执行以下 SQL：

```sql
UPDATE users SET role = 'teaching_office' WHERE username = 'director1';
```

### 解决方案 B: 重新初始化数据库

如果数据库中没有用户，执行初始化脚本：

```bash
# 在 MySQL 中执行
mysql -u root -p teaching_office_evaluation < backend/init_test_data.sql
```

### 解决方案 C: 修改权限检查逻辑

如果权限检查逻辑有问题，可以临时禁用权限检查来测试：

```python
# 修改前
@router.post("/self-evaluation")
def create_self_evaluation(
    evaluation_data: SelfEvaluationCreate,
    db: Session = Depends(get_db),
    current_user: User = Depends(require_teaching_office),  # 需要 teaching_office 角色
):
    ...

# 修改后（临时禁用权限检查）
@router.post("/self-evaluation")
def create_self_evaluation(
    evaluation_data: SelfEvaluationCreate,
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_user),  # 任何已认证用户
):
    ...
```

## 测试步骤

### 步骤 1: 清除浏览器缓存

1. 打开浏览器开发者工具 (F12)
2. 进入 Application 标签页
3. 清除 LocalStorage 和 SessionStorage
4. 刷新页面

### 步骤 2: 重新登录

1. 访问 http://localhost:3000
2. 点击"教研室端"
3. 输入用户名: `director1`
4. 输入密码: `password123`
5. 点击"登录"

### 步骤 3: 检查登录响应

在浏览器控制台中查看登录响应：

```javascript
// 在 Network 标签页中找到 /api/auth/login 请求
// 查看 Response 中的 role 字段
```

**预期结果**:
```json
{
  "token": "...",
  "userId": "...",
  "role": "teaching_office",
  "teachingOfficeId": "...",
  "expiresIn": ...
}
```

### 步骤 4: 提交自评表

1. 填写自评表内容
2. 点击"提交"
3. 检查浏览器控制台中的错误信息

**预期结果**: 提交成功，收到 201 Created 响应

## 修改的文件

- ✓ `backend/app/core/deps.py` - 添加调试日志

## 后续步骤

1. **查看后端日志** - 检查权限检查的详细信息
2. **检查数据库** - 确认用户角色是否正确
3. **验证 Token** - 确认 Token 中的角色信息是否正确
4. **根据日志调整** - 根据日志信息进行相应的修复

## 相关文档

- `API路径和权限问题修复说明.md` - API 路径修复
- `director1_403问题修复总结.md` - 之前的权限问题修复

## 总结

403 错误的根本原因可能是：

1. **数据库中的用户角色不正确** - 需要检查并修复
2. **Token 中的角色信息不正确** - 需要重新登录
3. **权限检查逻辑有问题** - 需要调试和修复

通过添加调试日志和检查数据库，我们可以快速定位问题的根源并进行修复。
