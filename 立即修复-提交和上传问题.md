# 立即修复 - 提交和上传问题

## 已修复的问题

### ✅ 问题1: ElMessage.loading is not a function
**修复**: 将 `ElMessage.loading()` 改为正确的 `ElMessage()` 用法

### ✅ 问题2: 401 Unauthorized
**修复**: 
1. 修复了登录逻辑，现在调用真实的API
2. 修复了auth store，正确保存和加载token
3. 添加了认证状态检查

## 修改的文件

1. `frontend/src/views/TeachingOfficeHome.vue`
   - 修复了ElMessage的使用方式
   - 添加了onMounted钩子检查登录状态

2. `frontend/src/stores/auth.ts`
   - 添加了setAuth方法保存token
   - 修复了loadFromStorage方法
   - 添加了teaching_office角色支持

3. `frontend/src/views/Login.vue`
   - 修复了登录逻辑，调用真实API
   - 正确保存token到localStorage

4. `frontend/src/components/AttachmentUpload.vue`
   - 修复了上传URL配置

## 立即执行步骤

### 步骤1: 刷新前端页面

由于代码已更新，需要刷新浏览器：

```bash
# 1. 在浏览器中按 Ctrl + Shift + R 强制刷新
# 2. 或者清除缓存后刷新
```

### 步骤2: 重新登录

1. 访问登录页面:
   ```
   http://localhost:3000/login
   ```

2. 点击"教研室端"卡片

3. 输入测试账号:
   ```
   用户名: test_teaching_office
   密码: password123
   ```

4. 点击"登录"按钮

5. 登录成功后会自动跳转到教研室端主页

### 步骤3: 测试提交功能

1. 点击左侧菜单"填写自评表"

2. 填写所有8个必填项（每项至少10个字符）

3. 设置自评分（0-10分）

4. 点击"提交表单"按钮

5. **预期结果**:
   - 显示"正在提交自评表，请稍候..."
   - 显示"提交成功！数据已上传到考评小组端"
   - 按钮变为"已提交"状态

### 步骤4: 测试上传功能

1. 点击左侧菜单"材料提交"

2. 选择考核指标（例如：教学改革项目）

3. 上传测试文件（PDF、DOC等）

4. **预期结果**:
   - 显示上传进度
   - 显示"文件 xxx 上传成功"
   - 文件出现在"已上传附件"列表

## 验证登录状态

打开浏览器控制台（F12），执行以下命令：

```javascript
// 检查token
console.log('Token:', localStorage.getItem('token'))

// 检查用户信息
console.log('User ID:', localStorage.getItem('userId'))
console.log('User Name:', localStorage.getItem('userName'))
console.log('User Role:', localStorage.getItem('userRole'))

// 如果token存在，说明已登录
// 如果token为null，需要重新登录
```

## 常见问题

### Q1: 登录后仍然显示401错误

**解决方案**:
1. 检查后端是否正常运行:
   ```bash
   netstat -ano | findstr :8000
   ```

2. 检查后端日志是否有错误

3. 清除localStorage后重新登录:
   ```javascript
   localStorage.clear()
   ```

### Q2: 提交按钮点击后无反应

**解决方案**:
1. 打开浏览器控制台（F12）查看错误信息

2. 检查是否已填写所有必填项

3. 检查网络请求是否发送成功（Network标签）

### Q3: 上传文件时显示"请先选择考核指标"

**解决方案**:
1. 确保已从下拉列表中选择了考核指标

2. 选择指标后再上传文件

## 测试清单

### 登录测试
- [ ] 访问登录页面
- [ ] 点击"教研室端"
- [ ] 输入测试账号
- [ ] 登录成功
- [ ] 跳转到教研室端主页
- [ ] localStorage中有token

### 提交测试
- [ ] 填写所有必填项
- [ ] 设置自评分
- [ ] 点击"提交表单"
- [ ] 看到加载提示
- [ ] 看到成功消息
- [ ] 按钮变为"已提交"

### 上传测试
- [ ] 选择考核指标
- [ ] 上传测试文件
- [ ] 看到上传进度
- [ ] 看到成功消息
- [ ] 文件出现在列表

## 技术细节

### 登录流程

```
用户输入账号密码
    ↓
调用 POST /api/auth/login
    ↓
后端验证账号密码
    ↓
返回 { access_token, user }
    ↓
前端保存到localStorage
    ↓
authStore.setAuth()
    ↓
跳转到主页
```

### 认证流程

```
页面加载
    ↓
onMounted()
    ↓
authStore.loadFromStorage()
    ↓
检查token是否存在
    ↓
如果不存在，跳转到登录页
    ↓
如果存在，继续加载页面
```

### API请求流程

```
发起API请求
    ↓
axios拦截器
    ↓
从localStorage获取token
    ↓
添加到请求头: Authorization: Bearer <token>
    ↓
发送请求
    ↓
后端验证token
    ↓
返回数据或401错误
```

## 后续优化建议

### 1. 添加token过期检测

```typescript
// 在axios拦截器中
apiClient.interceptors.response.use(
  (response) => response,
  (error) => {
    if (error.response?.status === 401) {
      // Token过期，清除并跳转登录
      localStorage.clear()
      ElMessage.error('登录已过期，请重新登录')
      window.location.href = '/login'
    }
    return Promise.reject(error)
  }
)
```

### 2. 添加自动刷新token

```typescript
// 定期刷新token
setInterval(async () => {
  const token = localStorage.getItem('token')
  if (token) {
    try {
      const response = await fetch('/api/auth/refresh', {
        headers: { Authorization: `Bearer ${token}` }
      })
      const data = await response.json()
      localStorage.setItem('token', data.access_token)
    } catch (error) {
      console.error('Token refresh failed:', error)
    }
  }
}, 30 * 60 * 1000) // 每30分钟刷新一次
```

### 3. 添加网络状态检测

```typescript
window.addEventListener('online', () => {
  ElMessage.success('网络已连接')
})

window.addEventListener('offline', () => {
  ElMessage.warning('网络已断开，请检查网络连接')
})
```

## 总结

✅ 已修复ElMessage.loading错误
✅ 已修复登录逻辑
✅ 已修复token保存和加载
✅ 已修复401认证错误
✅ 已修复附件上传URL

现在只需要：
1. 刷新浏览器
2. 重新登录
3. 测试功能

所有功能应该都能正常工作了！

---

**修复时间**: 2026-02-13
**版本**: 2.0.0
**状态**: ✅ 修复完成
