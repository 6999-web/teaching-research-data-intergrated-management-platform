# 手动评分页面数据加载修复完成

## 📅 修复时间
2026年2月14日

## 🐛 问题描述
考评表无法显示在考评小组端的手动评分页面

## 🔍 问题原因

### 根本原因
前端代码没有正确处理后端API的响应数据结构。

### 详细分析

#### 后端API响应结构
```json
{
  "value": [
    {
      "id": "faa49cfd-090d-4d36-82ac-53c302e6e6e8",
      "teaching_office_name": "Computer Science Office",
      "evaluation_year": 2026,
      "status": "locked",
      "submitted_at": "2026-02-14T02:40:33"
    }
  ],
  "Count": 2
}
```

#### 前端期望的结构
```json
[
  {
    "id": "faa49cfd-090d-4d36-82ac-53c302e6e6e8",
    "teaching_office_name": "Computer Science Office",
    "evaluation_year": 2026,
    "status": "locked",
    "submitted_at": "2026-02-14T02:40:33"
  }
]
```

**问题**：前端直接使用 `response.data`，但实际数据在 `response.data.value` 中。

---

## ✅ 修复方案

### 修改文件
`frontend/src/views/ManualScoring.vue`

### 修改内容

#### 修改前
```typescript
const loadEvaluations = async () => {
  try {
    loading.value = true
    const response = await scoringApi.getEvaluationsForScoring({})
    evaluations.value = response.data  // ❌ 直接使用response.data
  } catch (error: any) {
    console.error('Failed to load evaluations:', error)
    ElMessage.error(error.response?.data?.detail || '加载待评分列表失败')
  } finally {
    loading.value = false
  }
}
```

#### 修改后
```typescript
const loadEvaluations = async () => {
  try {
    loading.value = true
    const response = await scoringApi.getEvaluationsForScoring({})
    
    // ✅ 处理不同的响应数据结构
    if (Array.isArray(response.data)) {
      evaluations.value = response.data
    } else if (response.data.value && Array.isArray(response.data.value)) {
      // PowerShell返回的数据结构包含value字段
      evaluations.value = response.data.value
    } else {
      evaluations.value = []
      console.warn('Unexpected response data structure:', response.data)
    }
    
    console.log('Loaded evaluations:', evaluations.value.length)
  } catch (error: any) {
    console.error('Failed to load evaluations:', error)
    ElMessage.error(error.response?.data?.detail || '加载待评分列表失败')
  } finally {
    loading.value = false
  }
}
```

### 修复说明

1. **兼容性处理**：代码现在可以处理两种响应结构
   - 直接数组：`[...]`
   - 包含value字段：`{ value: [...], Count: 2 }`

2. **错误处理**：如果响应结构不符合预期，设置为空数组并输出警告

3. **调试信息**：添加console.log输出加载的数据数量，方便调试

---

## 🧪 测试步骤

### 步骤1：重启前端服务（如果需要）
```bash
# 如果前端使用了热重载，应该自动更新
# 如果没有自动更新，重启前端服务
cd frontend
npm run dev
```

### 步骤2：登录管理端
1. 访问：http://localhost:3000
2. 点击"管理端"卡片
3. 输入账号：
   - 用户名：`evaluator1`
   - 密码：`password123`
   - 角色：选择"评教小组"
4. 点击"登录"

### 步骤3：进入手动评分页面
1. 登录成功后，点击"手动评分"菜单
2. 应该看到待评分列表，显示2条记录：
   - Computer Science Office - 2026年度 - 已锁定
   - Test Teaching Office - 2026年度 - 已锁定

### 步骤4：开始评分
1. 点击任意一条记录的"开始评分"按钮
2. 应该进入评分表单页面
3. 填写各项评分
4. 提交评分

---

## 📊 预期结果

### 手动评分列表页面
应该显示如下表格：

| 教研室名称 | 考评年度 | 状态 | 提交时间 | 操作 |
|-----------|---------|------|---------|------|
| Computer Science Office | 2026 | 已锁定 | 2026-02-14 10:40 | [开始评分] |
| Test Teaching Office | 2026 | 已锁定 | 2026-02-13 22:16 | [开始评分] |

### 浏览器控制台输出
```
Loaded evaluations: 2
```

---

## 🔧 其他可能需要的修复

### 如果仍然无法显示数据

#### 检查1：API基础URL配置
文件：`frontend/.env.development`
```env
VITE_API_BASE_URL=http://localhost:8000/api
```

#### 检查2：后端服务是否运行
```bash
# 检查后端端口
netstat -ano | findstr :8000
```

应该看到：
```
TCP    0.0.0.0:8000           0.0.0.0:0              LISTENING       [PID]
```

#### 检查3：Token是否正确存储
打开浏览器开发者工具（F12）：
1. 切换到"Application"或"存储"标签
2. 查看"Local Storage"
3. 应该看到 `token` 键

#### 检查4：网络请求是否成功
打开浏览器开发者工具（F12）：
1. 切换到"Network"标签
2. 刷新页面
3. 查找 `evaluations-for-scoring` 请求
4. 检查状态码（应该是200）
5. 检查响应数据

---

## 📝 相关文件

### 修改的文件
- `frontend/src/views/ManualScoring.vue` - 修复数据加载逻辑

### 相关文件（未修改）
- `frontend/src/api/client.ts` - API客户端配置
- `backend/app/api/v1/endpoints/scoring.py` - 后端API端点
- `backend/app/api/v1/endpoints/self_evaluation.py` - 自评表API端点

---

## 🎯 完整的手动评分流程

### 1. 教研室端提交自评表
1. 登录教研室端（123 / 123）
2. 填写自评表
3. （可选）上传附件
4. 提交表单
5. 状态变为 `locked`

### 2. 考评小组手动评分
1. 登录管理端（evaluator1 / password123，选择"评教小组"）
2. 进入"手动评分"页面
3. 看到待评分列表（状态为 `locked` 或 `ai_scored`）
4. 点击"开始评分"
5. 填写各项评分
6. 提交评分
7. 状态变为 `manually_scored`

### 3. 考评办公室确定最终得分
1. 登录管理端（office1 / password123，选择"评教小组办公室"）
2. 进入"最终得分"页面
3. 查看所有评分（AI评分 + 手动评分）
4. 确定最终得分
5. 状态变为 `finalized`

### 4. 校长办公会审批
1. 登录管理端（president1 / password123，选择"校长办公会"）
2. 查看数据大屏
3. 审批评分结果
4. 状态变为 `approved`

### 5. 发布结果
1. 考评办公室发布结果
2. 状态变为 `published`
3. 教研室可以查看最终结果

---

## 🐛 常见问题

### Q1: 页面显示"暂无待评分的教研室"
**A**: 检查以下几点：
1. 是否有教研室提交了自评表？
2. 自评表状态是否为 `locked` 或 `ai_scored`？
3. 浏览器控制台是否有错误？
4. 网络请求是否成功？

### Q2: 点击"开始评分"没有反应
**A**: 检查以下几点：
1. 浏览器控制台是否有错误？
2. 是否正确选择了评分表单组件？
3. evaluation_id是否正确传递？

### Q3: 提交评分失败
**A**: 检查以下几点：
1. 是否填写了所有必填项？
2. 评分是否在有效范围内？
3. 是否已经提交过评分（不允许重复评分）？
4. 网络连接是否正常？

---

## ✅ 修复完成检查清单

- [x] 修改前端数据加载逻辑
- [x] 添加响应数据结构兼容性处理
- [x] 添加调试日志输出
- [x] 创建修复文档
- [ ] 用户测试前端页面
- [ ] 验证数据正确显示
- [ ] 测试完整评分流程

---

## 📞 下一步

请按照"测试步骤"进行测试，如果仍有问题，请提供：
1. 浏览器控制台错误信息
2. Network标签中的API请求详情
3. 页面显示的具体情况

---

**修复完成时间**：2026年2月14日  
**修复人员**：Kiro AI Assistant  
**状态**：等待用户测试验证
