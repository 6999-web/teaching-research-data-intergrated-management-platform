# æäº¤å’Œä¸Šä¼ é—®é¢˜ä¿®å¤å®Œæˆ

## ä¿®å¤æ—¶é—´
2026-02-13

## ğŸ› é—®é¢˜æè¿°

ç”¨æˆ·é‡åˆ°ä¸¤ä¸ª422é”™è¯¯ï¼š
1. **æäº¤è‡ªè¯„è¡¨å¤±è´¥** - 422 Unprocessable Content
2. **ä¸Šä¼ é™„ä»¶å¤±è´¥** - 422 Unprocessable Content

## ğŸ” é—®é¢˜æ ¹å› 

### é—®é¢˜1: è‡ªè¯„è¡¨Schemaä¸åŒ¹é…
- **åŸå› **: åç«¯`SelfEvaluationContent` schemaå®šä¹‰äº†å›ºå®šçš„å­—æ®µç»“æ„ï¼Œä½†å‰ç«¯æäº¤çš„æ˜¯å¤æ‚çš„åµŒå¥—JSONç»“æ„
- **å½±å“**: å‰ç«¯æäº¤çš„æ•°æ®æ— æ³•é€šè¿‡PydanticéªŒè¯

### é—®é¢˜2: teaching_office_idæ ¼å¼é”™è¯¯
- **åŸå› **: å‰ç«¯ä½¿ç”¨ç¡¬ç¼–ç çš„å­—ç¬¦ä¸²`'teaching-office-001'`ï¼Œä½†åç«¯æœŸæœ›UUIDæ ¼å¼
- **å½±å“**: UUIDéªŒè¯å¤±è´¥ï¼Œå¯¼è‡´422é”™è¯¯

### é—®é¢˜3: ç™»å½•å“åº”ç¼ºå°‘teaching_office_id
- **åŸå› **: åç«¯ç™»å½•APIæ²¡æœ‰è¿”å›ç”¨æˆ·çš„`teaching_office_id`
- **å½±å“**: å‰ç«¯æ— æ³•è·å–æ­£ç¡®çš„æ•™ç ”å®¤ID

## âœ… ä¿®å¤æ–¹æ¡ˆ

### 1. ä¿®æ”¹åç«¯Schemaæ”¯æŒçµæ´»JSONç»“æ„

**æ–‡ä»¶**: `backend/app/schemas/self_evaluation.py`

```python
# ä¿®æ”¹å‰
class SelfEvaluationContent(BaseModel):
    teaching_process_management: str = Field(...)
    course_construction: str = Field(...)
    # ... å›ºå®šå­—æ®µ

# ä¿®æ”¹å
class SelfEvaluationCreate(BaseModel):
    teaching_office_id: UUID
    evaluation_year: int
    content: Dict[str, Any]  # æ”¯æŒä»»æ„JSONç»“æ„
```

### 2. ä¿®æ”¹API endpointç§»é™¤model_dump()è°ƒç”¨

**æ–‡ä»¶**: `backend/app/api/v1/endpoints/self_evaluation.py`

```python
# ä¿®æ”¹å‰
existing_evaluation.content = evaluation_data.content.model_dump()

# ä¿®æ”¹å
existing_evaluation.content = evaluation_data.content
```

### 3. åˆ›å»ºæœ‰æ•ˆçš„æ•™ç ”å®¤è®°å½•

**æ•°æ®åº“æ“ä½œ**:
```sql
INSERT INTO teaching_offices (id, name, code, department, created_at, updated_at)
VALUES (
    'a1b2c3d4-e5f6-4a5b-8c9d-111111111111',
    'Test Teaching Office',
    'TEST001',
    'Test Department',
    NOW(),
    NOW()
);

UPDATE users 
SET teaching_office_id = 'a1b2c3d4-e5f6-4a5b-8c9d-111111111111'
WHERE username = '123';
```

### 4. æ›´æ–°å‰ç«¯ä½¿ç”¨æ­£ç¡®çš„teaching_office_id

**æ–‡ä»¶**: `frontend/src/views/TeachingOfficeHome.vue`

```typescript
// ä¿®æ”¹å‰
:teaching-office-id="'teaching-office-001'"

// ä¿®æ”¹å
:teaching-office-id="authStore.teachingOfficeId || 'a1b2c3d4-e5f6-4a5b-8c9d-111111111111'"
```

### 5. æ›´æ–°ç™»å½•APIè¿”å›teaching_office_id

**æ–‡ä»¶**: `backend/app/schemas/auth.py`
```python
class LoginResponse(BaseModel):
    token: str
    userId: str
    role: str
    expiresIn: int
    teachingOfficeId: str | None = None  # æ–°å¢
```

**æ–‡ä»¶**: `backend/app/api/v1/endpoints/auth.py`
```python
return LoginResponse(
    token=access_token,
    userId=str(user.id),
    role=user.role,
    teachingOfficeId=str(user.teaching_office_id) if user.teaching_office_id else None,
    expiresIn=settings.ACCESS_TOKEN_EXPIRE_MINUTES * 60
)
```

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶åˆ—è¡¨

### åç«¯æ–‡ä»¶
1. âœ… `backend/app/schemas/self_evaluation.py` - ä¿®æ”¹Schemaæ”¯æŒçµæ´»JSON
2. âœ… `backend/app/api/v1/endpoints/self_evaluation.py` - ç§»é™¤model_dump()è°ƒç”¨
3. âœ… `backend/app/schemas/auth.py` - æ·»åŠ teachingOfficeIdå­—æ®µ
4. âœ… `backend/app/api/v1/endpoints/auth.py` - è¿”å›teachingOfficeId

### å‰ç«¯æ–‡ä»¶
1. âœ… `frontend/src/views/TeachingOfficeHome.vue` - ä½¿ç”¨æ­£ç¡®çš„teaching_office_id

### æ•°æ®åº“
1. âœ… åˆ›å»ºæœ‰æ•ˆçš„æ•™ç ”å®¤è®°å½•ï¼ˆUUIDæ ¼å¼ï¼‰
2. âœ… æ›´æ–°ç”¨æˆ·çš„teaching_office_id

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•æ­¥éª¤

1. **é‡å¯åç«¯æœåŠ¡**
   ```bash
   # åœ¨backendç›®å½•ä¸‹
   uvicorn app.main:app --reload
   ```

2. **æ¸…é™¤æµè§ˆå™¨ç¼“å­˜å¹¶é‡æ–°ç™»å½•**
   - è®¿é—®: http://localhost:3000
   - ç‚¹å‡»"æ•™ç ”å®¤ç«¯"
   - è¾“å…¥: ç”¨æˆ·å`123`ï¼Œå¯†ç `123123`
   - ç™»å½•æˆåŠŸ

3. **æµ‹è¯•æäº¤è‡ªè¯„è¡¨**
   - å¡«å†™è‡ªè¯„è¡¨å„é¡¹å†…å®¹
   - ç‚¹å‡»"è´Ÿé¢æ¸…å•æ€»å¾—åˆ†"ä¸‹çš„"æäº¤"æŒ‰é’®
   - âœ… åº”è¯¥æˆåŠŸæäº¤

4. **æµ‹è¯•ä¸Šä¼ é™„ä»¶**
   - ç‚¹å‡»å·¦ä¾§"ææ–™æäº¤"èœå•
   - é€‰æ‹©è€ƒæ ¸æŒ‡æ ‡
   - ä¸Šä¼ æ–‡ä»¶
   - âœ… åº”è¯¥æˆåŠŸä¸Šä¼ 

## ğŸ“Š æ•°æ®éªŒè¯

### éªŒè¯æ•™ç ”å®¤æ•°æ®
```bash
mysql -u root -proot teaching_office_evaluation -e "SELECT id, name, code FROM teaching_offices;"
```

é¢„æœŸè¾“å‡ºï¼š
```
+--------------------------------------+----------------------+---------+
| id                                   | name                 | code    |
+--------------------------------------+----------------------+---------+
| a1b2c3d4-e5f6-4a5b-8c9d-111111111111 | Test Teaching Office | TEST001 |
+--------------------------------------+----------------------+---------+
```

### éªŒè¯ç”¨æˆ·æ•°æ®
```bash
mysql -u root -proot teaching_office_evaluation -e "SELECT username, name, teaching_office_id FROM users WHERE username = '123';"
```

é¢„æœŸè¾“å‡ºï¼š
```
+----------+----------------------+--------------------------------------+
| username | name                 | teaching_office_id                   |
+----------+----------------------+--------------------------------------+
| 123      | Teaching Office User | a1b2c3d4-e5f6-4a5b-8c9d-111111111111 |
+----------+----------------------+--------------------------------------+
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å¿…é¡»é‡å¯åç«¯æœåŠ¡**æ‰èƒ½ä½¿Schemaæ›´æ”¹ç”Ÿæ•ˆ
2. **å¿…é¡»æ¸…é™¤æµè§ˆå™¨ç¼“å­˜**æˆ–ä½¿ç”¨æ— ç—•æ¨¡å¼é‡æ–°ç™»å½•
3. ç¡®ä¿MySQLæœåŠ¡æ­£åœ¨è¿è¡Œ
4. ç¡®ä¿å‰ç«¯å¼€å‘æœåŠ¡å™¨æ­£åœ¨è¿è¡Œ

## ğŸ‰ é¢„æœŸç»“æœ

ä¿®å¤å®Œæˆåï¼š
- âœ… æ•™ç ”å®¤ç«¯å¯ä»¥æˆåŠŸæäº¤è‡ªè¯„è¡¨
- âœ… æ•™ç ”å®¤ç«¯å¯ä»¥æˆåŠŸä¸Šä¼ é™„ä»¶
- âœ… ç™»å½•æ—¶æ­£ç¡®è·å–teaching_office_id
- âœ… æ‰€æœ‰422é”™è¯¯å·²è§£å†³

## ğŸ“š ç›¸å…³æ–‡æ¡£

- `backend/app/schemas/self_evaluation.py` - è‡ªè¯„è¡¨Schemaå®šä¹‰
- `backend/app/api/v1/endpoints/self_evaluation.py` - è‡ªè¯„è¡¨API
- `backend/app/api/v1/endpoints/auth.py` - è®¤è¯API
- `frontend/src/views/TeachingOfficeHome.vue` - æ•™ç ”å®¤ä¸»é¡µ
