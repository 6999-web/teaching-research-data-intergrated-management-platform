# 登录问题诊断和修复

## 问题描述
教研室端无法提交表单，出现以下错误：
- 403 Forbidden: `/api/teaching-office/self-evaluations`
- 401 Unauthorized: `Failed to submit self-evaluation`

## 问题原因
用户的登录状态有问题，可能是：
1. Token未正确保存
2. Token已过期
3. 用户角色不匹配

## 修复内容

### 1. 添加登录调试信息
在 `Login.vue` 中添加了console.log，方便查看登录数据：
```typescript
console.log('Login successful, user data:', user)
console.log('Token saved:', data.token)
```

## 诊断步骤

### 步骤1：检查登录状态
1. 打开浏览器开发者工具（F12）
2. 切换到 `Console` 标签
3. 刷新页面
4. 查看是否有登录相关的日志

### 步骤2：检查LocalStorage
1. 在开发者工具中切换到 `Application` 标签
2. 展开左侧的 `Local Storage`
3. 点击 `http://localhost:3000`
4. 检查以下键值是否存在：
   - `token`: JWT token
   - `userId`: 用户ID
   - `userName`: 用户名
   - `userRole`: 用户角色（应该是 `teaching_office`）
   - `teachingOfficeId`: 教研室ID

### 步骤3：重新登录
1. 点击右下角"退出登录"
2. 清除浏览器缓存（Ctrl + Shift + Delete）
3. 刷新页面
4. 重新登录

#### 登录步骤
1. 访问 http://localhost:3000
2. 点击"教研室端"卡片
3. 输入用户名：`office1`
4. 输入密码：`password123`
5. 点击"登录"
6. 观察控制台输出

### 步骤4：验证Token
在控制台中执行以下代码：
```javascript
// 检查token
const token = localStorage.getItem('token')
console.log('Token:', token)

// 检查用户信息
const userId = localStorage.getItem('userId')
const userName = localStorage.getItem('userName')
const userRole = localStorage.getItem('userRole')
const teachingOfficeId = localStorage.getItem('teachingOfficeId')

console.log('User Info:', {
  userId,
  userName,
  userRole,
  teachingOfficeId
})

// 验证token
fetch('/api/auth/verify', {
  headers: {
    'Authorization': `Bearer ${token}`
  }
})
.then(res => res.json())
.then(data => console.log('Token verification:', data))
.catch(err => console.error('Token verification failed:', err))
```

## 预期结果

### 正确的LocalStorage数据
```
token: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
userId: "a1b2c3d4-e5f6-4a5b-8c9d-111111111111"
userName: "office1"
userRole: "teaching_office"
teachingOfficeId: "a1b2c3d4-e5f6-4a5b-8c9d-111111111111"
```

### 正确的控制台输出
```
Login successful, user data: {
  id: "a1b2c3d4-e5f6-4a5b-8c9d-111111111111",
  name: "office1",
  role: "teaching_office",
  teaching_office_id: "a1b2c3d4-e5f6-4a5b-8c9d-111111111111"
}
Token saved: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
```

## 常见问题

### Q1: LocalStorage中没有token？
A: 重新登录，确保输入正确的用户名和密码

### Q2: Token验证失败？
A: Token可能已过期，重新登录获取新token

### Q3: userRole不是teaching_office？
A: 确保从"教研室端"入口登录，不要从"管理端"登录

### Q4: teachingOfficeId为空？
A: 检查数据库中用户的teaching_office_id字段是否有值

## 数据库检查

### 检查用户数据
```sql
SELECT 
  id,
  username,
  role,
  teaching_office_id,
  created_at
FROM users
WHERE username = 'office1';
```

### 预期结果
```
id: a1b2c3d4-e5f6-4a5b-8c9d-111111111111
username: office1
role: teaching_office
teaching_office_id: a1b2c3d4-e5f6-4a5b-8c9d-111111111111
```

### 如果teaching_office_id为空
```sql
UPDATE users
SET teaching_office_id = 'a1b2c3d4-e5f6-4a5b-8c9d-111111111111'
WHERE username = 'office1';
```

## 后端日志检查

### 查看后端日志
```bash
# 在backend目录下
tail -f error.log
```

### 查找认证相关错误
```bash
grep "401\|403\|Unauthorized\|Forbidden" error.log
```

## 测试API

### 测试登录API
```bash
curl -X POST http://localhost:8000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "office1",
    "password": "password123",
    "role": "teaching_office"
  }'
```

### 预期响应
```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "userId": "a1b2c3d4-e5f6-4a5b-8c9d-111111111111",
  "role": "teaching_office",
  "teachingOfficeId": "a1b2c3d4-e5f6-4a5b-8c9d-111111111111",
  "expiresIn": 43200
}
```

### 测试自评表API
```bash
# 先获取token
TOKEN="your_token_here"

# 测试保存自评表
curl -X POST http://localhost:8000/api/teaching-office/self-evaluation \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "teaching_office_id": "a1b2c3d4-e5f6-4a5b-8c9d-111111111111",
    "evaluation_year": 2026,
    "content": {}
  }'
```

## 快速修复方案

### 方案1：清除所有数据重新登录
1. 打开开发者工具（F12）
2. 在Console中执行：
```javascript
localStorage.clear()
location.reload()
```
3. 重新登录

### 方案2：手动设置Token
如果你有有效的token，可以手动设置：
```javascript
localStorage.setItem('token', 'your_token_here')
localStorage.setItem('userId', 'your_user_id')
localStorage.setItem('userName', 'office1')
localStorage.setItem('userRole', 'teaching_office')
localStorage.setItem('teachingOfficeId', 'your_teaching_office_id')
location.reload()
```

### 方案3：使用测试账号
确保使用正确的测试账号：
```
用户名: office1
密码: password123
角色: teaching_office
```

## 修改的文件
- `frontend/src/views/Login.vue` - 添加调试日志

## 下一步

如果问题仍然存在：
1. 提供控制台的完整错误日志
2. 提供LocalStorage的截图
3. 提供后端error.log的相关内容
4. 检查数据库中用户数据是否正确

## 相关文档
- `表单提交错误修复-2026-02-14.md`
- `教研室端界面更新说明.md`
- `系统账号密码清单.md`
