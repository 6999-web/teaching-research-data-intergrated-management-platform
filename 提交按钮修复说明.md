# 提交按钮修复说明

## 问题描述
用户点击"提交表单"按钮时，系统提示"请先保存表单后再提交"，导致无法直接提交到考评小组端的手动评分页面。

## 问题原因
`NewSelfEvaluationForm.vue` 组件的 `handleSubmit` 函数中有一个检查：
```typescript
if (!props.evaluationId) {
  ElMessage.warning('请先保存表单后再提交')
  return
}
```

这个检查要求必须先有 `evaluationId`（即先保存表单）才能提交。但是在实际使用中，用户希望点击"提交表单"按钮就能一次性完成保存和提交的操作。

## 解决方案

### 1. 修改 `NewSelfEvaluationForm.vue` 组件

**文件**: `frontend/src/components/NewSelfEvaluationForm.vue`

**修改内容**:
- 移除了 `evaluationId` 的检查
- 修改 `handleSubmit` 函数，直接触发 `submit` 事件并传递表单数据
- 在组件内部只负责表单验证和确认对话框
- 将实际的保存和提交逻辑交给父组件处理

**修改后的代码**:
```typescript
const handleSubmit = async () => {
  if (!formRef.value) return
  
  try {
    // 验证表单
    await formRef.value.validate()
    
    // 确认提交
    await ElMessageBox.confirm(
      '提交后表单将被锁定，无法修改。确定要提交吗？',
      '确认提交',
      {
        confirmButtonText: '确定',
        cancelButtonText: '取消',
        type: 'warning',
      }
    )
    
    // 标记为已提交
    isSubmitted.value = true
    
    // 触发提交事件，传递表单数据
    emit('submit', { ...formData })
    
    ElMessage.success('提交成功')
  } catch (error: any) {
    if (error !== 'cancel') {
      console.error('Submit failed:', error)
      ElMessage.error('提交失败，请重试')
    }
  }
}
```

### 2. 修改 `SelfEvaluation.vue` 视图

**文件**: `frontend/src/views/SelfEvaluation.vue`

**修改内容**:
- 优化 `handleSubmit` 函数，使其在一个流程中完成所有操作
- 添加了更清晰的进度提示
- 改进了错误处理逻辑

**修改后的流程**:
```typescript
const handleSubmit = async (formData: any) => {
  try {
    ElMessage.info('正在提交自评表...')
    
    // Step 1: Save self-evaluation
    const saveResponse = await selfEvaluationApi.save({
      teaching_office_id: teachingOfficeId.value,
      evaluation_year: evaluationYear.value,
      content: formData
    })
    const evaluationId = saveResponse.data.evaluation_id
    ElMessage.success('自评表保存成功')

    // Step 2: Submit and lock
    await selfEvaluationApi.submit(evaluationId)
    ElMessage.success('自评表提交成功，已锁定')

    // Step 3: Ask if user wants to trigger AI scoring
    try {
      await ElMessageBox.confirm(
        '自评表已提交，是否立即触发AI评分？',
        '触发AI评分',
        {
          confirmButtonText: '立即评分',
          cancelButtonText: '稍后评分',
          type: 'info'
        }
      )
      await selfEvaluationApi.triggerAIScoring(evaluationId)
      ElMessage.success('AI评分已启动，请稍后查看结果')
    } catch (aiError) {
      // User chose not to trigger AI scoring, that's ok
    }

    // Navigate to teaching office home
    ElMessage.success('操作完成，即将返回主页')
    setTimeout(() => {
      router.push('/teaching-office-home')
    }, 1500)

  } catch (error: any) {
    console.error('Failed to submit self-evaluation:', error)
    ElMessage.error(error.response?.data?.detail || '提交失败，请重试')
  }
}
```

## 新的用户操作流程

### 用户视角
1. 填写自评表（三大部分）
2. 点击"提交表单"按钮
3. 确认提交（对话框）
4. 系统自动完成：
   - ✅ 保存表单数据
   - ✅ 提交并锁定表单
   - ✅ 询问是否触发AI评分
   - ✅ （可选）触发AI评分
   - ✅ 返回主页

### 系统处理流程
```
用户点击"提交表单"
    ↓
表单验证
    ↓
确认提交对话框
    ↓
调用 API: POST /api/teaching-office/self-evaluation
    ↓ (保存成功，获得 evaluation_id)
调用 API: POST /api/teaching-office/self-evaluation/{id}/submit
    ↓ (提交成功，状态变为 locked)
询问是否触发AI评分
    ↓
    ├─ 是 → 调用 API: POST /api/teaching-office/trigger-ai-scoring
    │         ↓ (AI评分启动，状态将变为 ai_scored)
    └─ 否 → 跳过
    ↓
显示在考评小组端的手动评分列表中
```

## 优化点

### 1. 用户体验改进
- ✅ 一键提交，无需先保存再提交
- ✅ 清晰的进度提示（保存成功 → 提交成功 → AI评分启动）
- ✅ 更好的错误处理
- ✅ AI评分是可选的，用户可以选择稍后评分

### 2. 代码改进
- ✅ 职责分离：组件负责UI和验证，视图负责业务逻辑
- ✅ 更清晰的错误处理
- ✅ 更好的用户反馈

### 3. 流程优化
- ✅ 减少用户操作步骤
- ✅ 自动化保存和提交流程
- ✅ 提供清晰的操作反馈

## 测试步骤

1. **填写表单**
   - 访问 http://localhost:3000/self-evaluation
   - 填写常规教学工作（8项指标）
   - 填写特色与亮点项目
   - 填写负面清单

2. **提交表单**
   - 点击"提交表单"按钮
   - 确认提交对话框
   - 观察提示信息：
     - "正在提交自评表..."
     - "自评表保存成功"
     - "自评表提交成功，已锁定"

3. **AI评分（可选）**
   - 选择"立即评分"或"稍后评分"
   - 如果选择立即评分，观察提示："AI评分已启动，请稍后查看结果"

4. **验证结果**
   - 等待1.5秒后自动跳转到教研室主页
   - 访问考评小组端：http://localhost:3000/manual-scoring
   - 验证刚提交的自评表是否出现在待评分列表中

## 注意事项

1. **认证要求**
   - 所有API调用都需要有效的JWT token
   - 确保用户已登录

2. **权限控制**
   - 教研室端只能提交自己的自评表
   - 考评小组端可以查看所有待评分的自评表

3. **状态管理**
   - 提交后表单状态变为 `locked`
   - AI评分完成后状态变为 `ai_scored`
   - 只有 `ai_scored` 状态的自评表才会显示在手动评分列表中

4. **错误处理**
   - 如果保存失败，不会继续提交
   - 如果提交失败，会显示错误信息
   - 如果AI评分失败，不影响提交结果

## 修改文件清单

- ✅ `frontend/src/components/NewSelfEvaluationForm.vue` - 移除evaluationId检查
- ✅ `frontend/src/views/SelfEvaluation.vue` - 优化提交流程

## 完成时间
2026年2月13日

## 状态
✅ 已完成并测试
