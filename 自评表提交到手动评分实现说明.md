# 自评表提交到手动评分功能实现说明

## 实现概述

成功实现了教研室端填写自评表提交后，数据能在考评小组端的手动评分页面显示的完整流程。

## 实现的功能

### 1. 自评表提交流程

**文件**: `frontend/src/views/SelfEvaluation.vue`

- 使用新的评分表组件 `NewSelfEvaluationForm.vue`
- 实现完整的提交流程：
  1. 用户填写自评表
  2. 点击提交按钮
  3. 确认提交对话框
  4. 保存自评表数据到后端
  5. 提交并锁定自评表
  6. 询问是否触发AI评分
  7. 触发AI评分（可选）
  8. 跳转回教研室主页

### 2. API客户端更新

**文件**: `frontend/src/api/client.ts`

新增和更新的API方法：

#### 自评表API (`selfEvaluationApi`)
- `save()` - 创建或保存自评表
- `get()` - 获取自评表详情
- `update()` - 更新自评表
- `submit()` - 提交并锁定自评表
- `triggerAIScoring()` - 触发AI评分
- `getStatus()` - 获取自评表状态

#### 评分API (`scoringApi`)
- `getEvaluationsForScoring()` - 获取待评分的自评表列表
- `submitManualScore()` - 提交手动评分
- `getAllScores()` - 获取所有评分记录
- `submitFinalScore()` - 提交最终得分

### 3. 手动评分页面更新

**文件**: `frontend/src/views/ManualScoring.vue`

- 从模拟数据改为真实API调用
- 自动加载已完成AI评分的自评表列表
- 显示教研室名称、考评年度、状态、提交时间
- 支持选择教研室开始评分
- 集成 `ManualScoringForm` 组件进行评分

### 4. 后端API端点新增

**文件**: `backend/app/api/v1/endpoints/scoring.py`

新增端点：
```python
GET /v1/scoring/evaluations-for-scoring
```

功能：
- 获取待手动评分的自评表列表
- 默认返回状态为 `locked`（已提交）或 `ai_scored`（AI已评分）的自评表
- 支持按状态和年份筛选
- 返回教研室名称、考评年度、状态、提交时间等信息
- 按提交时间倒序排列

## 数据流程

```
教研室端填写自评表
    ↓
点击提交按钮
    ↓
调用 selfEvaluationApi.save() 保存数据
    ↓
调用 selfEvaluationApi.submit() 提交并锁定
    ↓
（可选）调用 selfEvaluationApi.triggerAIScoring() 触发AI评分
    ↓
AI评分完成后，状态变为 'ai_scored'
    ↓
考评小组端访问手动评分页面
    ↓
调用 scoringApi.getEvaluationsForScoring() 获取待评分列表
    ↓
显示已完成AI评分的自评表
    ↓
考评小组选择教研室开始评分
    ↓
使用 ManualScoringForm 组件进行评分
    ↓
调用 scoringApi.submitManualScore() 提交评分
```

## API路径说明

所有API路径都使用 `/api/` 前缀（配置在 `settings.API_V1_STR`）：

- 自评表相关：`/api/teaching-office/self-evaluation/...`
- 评分相关：`/api/scoring/...`
- 其他功能：`/api/review/...`, `/api/president-office/...` 等

**重要**：前端 `apiClient` 的 `baseURL` 已设置为 `/api`，所以API调用时不需要再加 `/api` 前缀。

## 状态流转

自评表状态流转：
1. `draft` - 草稿（初始状态）
2. `submitted` - 已提交
3. `locked` - 已锁定（提交后自动锁定）
4. `ai_scored` - AI已评分
5. `manually_scored` - 已手动评分
6. `finalized` - 已确定最终得分
7. `published` - 已公示

## 测试步骤

### 1. 测试自评表提交

1. 访问 http://localhost:3000/self-evaluation
2. 填写新评分表（三大部分）
3. 点击"提交表单"按钮
4. 确认提交
5. 选择是否触发AI评分
6. 验证跳转到教研室主页

### 2. 测试手动评分页面

1. 访问 http://localhost:3000/manual-scoring
2. 验证显示已完成AI评分的自评表列表
3. 点击"开始评分"按钮
4. 验证显示评分表单
5. 填写评分并提交

## 注意事项

1. **认证要求**：所有API调用都需要有效的JWT token
2. **权限控制**：
   - 教研室端只能提交自己的自评表
   - 考评小组和考评办公室可以查看和评分所有自评表
3. **状态检查**：
   - 只有状态为 `ai_scored` 的自评表才会显示在手动评分列表中
   - 已锁定的自评表无法修改
4. **数据验证**：
   - 提交前需要确保所有必填项都已填写
   - 评分需要在有效范围内

## 相关文件

### 前端文件
- `frontend/src/views/SelfEvaluation.vue` - 自评表视图
- `frontend/src/views/ManualScoring.vue` - 手动评分视图
- `frontend/src/components/NewSelfEvaluationForm.vue` - 新评分表组件
- `frontend/src/api/client.ts` - API客户端

### 后端文件
- `backend/app/api/v1/endpoints/self_evaluation.py` - 自评表API端点
- `backend/app/api/v1/endpoints/scoring.py` - 评分API端点
- `backend/app/models/self_evaluation.py` - 自评表模型
- `backend/app/models/manual_score.py` - 手动评分模型

## 下一步优化建议

1. 添加自评表草稿保存功能
2. 添加自评表预览功能
3. 添加评分进度跟踪
4. 添加评分历史记录查看
5. 优化错误处理和用户提示
6. 添加加载状态指示器
7. 实现评分结果通知功能

## 完成时间

2026年2月13日
