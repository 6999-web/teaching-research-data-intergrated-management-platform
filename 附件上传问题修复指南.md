# 附件上传问题修复指南

## 问题诊断

从截图看到422错误（Unprocessable Content），这是因为上传请求的数据格式不正确。

## 已修复内容

### 1. 前端修改

**文件**: `frontend/src/components/AttachmentUpload.vue`

修改了文件上传方式，从使用`:data`属性改为使用`:http-request`自定义上传方法。

#### 修改前（有问题）
```vue
<el-upload
  :action="uploadAction"
  :data="uploadData"
  ...
>
```

#### 修改后（正确）
```vue
<el-upload
  :action="uploadAction"
  :http-request="customUpload"
  ...
>
```

### 2. 添加自定义上传方法

新增了`customUpload`方法，正确构建FormData：

```typescript
const customUpload = async (options: any) => {
  const formData = new FormData()
  formData.append('evaluation_id', props.evaluationId)
  formData.append('indicator', uploadForm.indicator)
  formData.append('files', file)
  
  // 使用XMLHttpRequest发送请求
  // 支持进度监听
  // 正确处理响应
}
```

---

## 重启服务

### 重要：必须重启前端服务

修改了前端代码后，必须重启前端服务才能生效：

#### 方法1：如果使用了热重载

前端应该会自动重新编译。刷新浏览器页面即可。

#### 方法2：手动重启

1. 找到运行前端的命令行窗口
2. 按 `Ctrl + C` 停止服务
3. 重新运行：
   ```bash
   cd frontend
   npm run dev
   ```

### 同时确保后端服务正常

如果后端还有403错误，也需要重启后端：

1. 找到运行后端的命令行窗口
2. 按 `Ctrl + C` 停止服务
3. 重新运行：
   ```bash
   cd backend
   python -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
   ```

---

## 测试上传功能

### 方法1：使用浏览器测试

1. 访问 http://localhost:3000
2. 登录教研室端（`director1` / `password123`）
3. 进入"填写自评表"
4. 填写并提交表单
5. 进入"附件上传"页面
6. 选择考核指标
7. 拖拽或点击上传文件
8. 应该能看到上传进度
9. 上传成功后，文件会出现在"已上传附件"列表

### 方法2：使用测试脚本

```bash
python test_file_upload_fixed.py
```

应该看到：
```
✅ 登录成功
✅ 自评表已创建
✅ 文件上传成功
```

---

## 上传流程说明

### 正确的上传流程

1. **用户选择考核指标**
   - 必须先选择考核指标
   - 系统会根据指标显示支持的文件格式

2. **选择文件**
   - 拖拽文件到上传区域
   - 或点击上传区域选择文件
   - 支持多文件上传（最多10个）

3. **文件验证**
   - 检查文件大小（最大50MB）
   - 检查文件格式（根据考核指标）
   - 验证通过后开始上传

4. **上传文件**
   - 显示上传进度
   - 上传成功后添加到已上传列表
   - 可以继续上传更多文件

5. **提交附件**
   - 点击"提交附件"按钮
   - 锁定表单和附件
   - 跳转回自评表页面

### FormData格式

后端API期望的请求格式：

```
Content-Type: multipart/form-data

evaluation_id: <UUID>
indicator: <string>
files: <File>
```

---

## 支持的文件格式

### 证书类
- PDF (.pdf)
- 图片 (.jpg, .jpeg, .png)
- Word 文档 (.doc, .docx)

### 项目类
- PDF (.pdf)
- Excel (.xls, .xlsx)
- Word 文档 (.doc, .docx)
- 压缩包 (.zip, .rar)

---

## 常见问题

### Q1: 上传时提示422错误

**原因**: 请求数据格式不正确

**解决方法**:
1. 确认前端代码已更新
2. 重启前端服务
3. 清除浏览器缓存
4. 刷新页面重试

### Q2: 上传时提示403错误

**原因**: 
- 未登录或token过期
- 自评表不存在
- 自评表已锁定

**解决方法**:
1. 重新登录
2. 确认自评表已创建
3. 确认自评表未锁定

### Q3: 上传时提示404错误

**原因**: API路径不正确

**解决方法**:
1. 检查后端服务是否运行
2. 检查API路径配置
3. 访问 http://localhost:8000/docs 查看API文档

### Q4: 文件上传后看不到

**原因**: 
- 上传成功但前端没有刷新列表
- 数据库保存失败

**解决方法**:
1. 刷新页面
2. 检查浏览器控制台错误
3. 检查后端日志

### Q5: 提示"请先选择考核指标"

**原因**: 没有选择考核指标

**解决方法**:
1. 在"选择考核指标"下拉框中选择一个指标
2. 然后再上传文件

---

## 文件存储位置

### 使用本地存储时

文件保存在：`backend/uploads/`

目录结构：
```
backend/uploads/
  └── {evaluation_id}/
      └── {indicator}/
          └── {unique_filename}
```

### 使用MinIO时

文件保存在MinIO对象存储中：
- Bucket: teaching-office-attachments
- 路径结构同上

---

## 验证修复

### 1. 检查前端代码

打开 `frontend/src/components/AttachmentUpload.vue`，确认包含：

```typescript
const customUpload = async (options: any) => {
  // ... 自定义上传逻辑
}
```

### 2. 检查前端服务

访问 http://localhost:3000，应该能看到登录页面。

### 3. 检查后端服务

访问 http://localhost:8000/docs，应该能看到API文档。

### 4. 测试完整流程

1. 登录教研室端
2. 填写自评表
3. 提交表单
4. 上传附件
5. 提交附件

所有步骤都应该成功。

---

## 技术细节

### 为什么要使用自定义上传？

Element Plus的el-upload组件默认使用`:data`属性传递额外数据，但这种方式在某些情况下会导致数据格式不正确。

使用`:http-request`自定义上传方法可以：
1. 完全控制FormData的构建
2. 正确设置请求头
3. 监听上传进度
4. 处理响应和错误

### FormData构建

```typescript
const formData = new FormData()
formData.append('evaluation_id', props.evaluationId)  // UUID字符串
formData.append('indicator', uploadForm.indicator)     // 考核指标
formData.append('files', file)                         // 文件对象
```

### 后端接收

```python
@router.post("/attachments")
async def upload_attachments(
    evaluation_id: UUID = Form(...),      # 从FormData接收
    indicator: str = Form(...),           # 从FormData接收
    files: List[UploadFile] = File(...),  # 从FormData接收文件
    ...
):
```

---

## 总结

✅ 前端上传方法已修复
✅ 使用自定义上传方法
✅ 正确构建FormData
✅ 支持进度监听
✅ 支持多文件上传

重启前端服务后，附件上传功能应该可以正常工作了！
