# 教研室端问题完整修复方案

## 问题总结

根据截图和代码分析，发现以下问题：

### 问题1: 填写考评表无法提交
**症状**: 点击"提交表单"按钮后无反应或报错
**根本原因**: 
1. 用户未登录或token已过期
2. 浏览器缓存导致的组件加载问题

### 问题2: 材料提交无法上传文件
**症状**: 上传文件时显示401 Unauthorized错误
**根本原因**:
1. 用户未登录（后端需要认证）
2. Token已过期或无效
3. 附件上传API路径配置问题

## 立即修复步骤

### 步骤1: 清除缓存并重启浏览器

```bash
# 1. 关闭所有浏览器窗口
# 2. 清除浏览器缓存
#    - Chrome: Ctrl + Shift + Delete
#    - 选择"缓存的图片和文件"
#    - 时间范围选择"全部时间"
#    - 点击"清除数据"
# 3. 重新打开浏览器
```

### 步骤2: 重新登录系统

1. 访问登录页面:
   ```
   http://localhost:3000/login
   ```

2. 使用测试账号登录:
   ```
   用户名: test_teaching_office
   密码: password123
   角色: 教研室端
   ```

3. 登录成功后，检查token:
   - 按F12打开开发者工具
   - 切换到Console标签
   - 执行: `console.log(localStorage.getItem('token'))`
   - 应该看到一个长字符串

### 步骤3: 测试提交功能

1. 点击左侧菜单"填写自评表"

2. 填写表单（所有必填项）:
   - 1. 教学过程管理（至少10个字符）
   - 2. 教学质量管理（至少10个字符）
   - 3. 课程考核（至少10个字符）
   - 4. 教育教学科研工作（至少10个字符）
   - 5. 课程建设（至少10个字符）
   - 6. 教师队伍建设（至少10个字符）
   - 7. 科学研究与学术交流（至少10个字符）
   - 8. 教学档案室管理与建设（至少10个字符）

3. 设置自评分:
   - 每个指标都要设置分数（0-10分）

4. 点击"提交表单"按钮

5. 预期结果:
   - 显示"正在提交自评表，请稍候..."
   - 显示"提交成功！数据已上传到考评小组端"
   - 按钮变为"已提交"状态

### 步骤4: 测试附件上传

1. 点击左侧菜单"材料提交"

2. 选择考核指标:
   - 从下拉列表中选择一个指标
   - 例如: "教学改革项目"

3. 上传文件:
   - 拖拽文件到上传区域
   - 或点击上传区域选择文件
   - 支持的格式: pdf, doc, docx, ppt, pptx

4. 预期结果:
   - 显示上传进度条
   - 显示"文件 xxx 上传成功"
   - 文件出现在"已上传附件"列表

## 代码修复

### 修复1: 附件上传URL配置

**文件**: `frontend/src/components/AttachmentUpload.vue`

**已修复的代码**:
```typescript
// Computed
const uploadAction = computed(() => {
  // 使用完整的API URL
  const baseURL = import.meta.env.VITE_API_BASE_URL || '/api'
  return `${baseURL}/teaching-office/attachments`
})
```

**说明**: 确保附件上传使用正确的API基础URL

## 常见错误及解决方案

### 错误1: "请填写所有必填项"

**原因**: 表单验证失败

**解决方案**:
1. 检查所有8个常规教学工作指标是否都已填写
2. 每个指标的内容至少10个字符
3. 每个指标都设置了自评分（0-10分）

### 错误2: "请先登录后再提交"

**原因**: 用户未登录或token已过期

**解决方案**:
1. 退出登录（点击左下角"退出登录"）
2. 清除浏览器缓存
3. 重新登录
4. 再次尝试提交

### 错误3: 401 Unauthorized

**原因**: Token无效或已过期

**解决方案**:
1. 检查token是否存在:
   ```javascript
   // 在浏览器控制台执行
   console.log('Token:', localStorage.getItem('token'))
   ```

2. 如果token为null或undefined:
   - 重新登录

3. 如果token存在但仍然401:
   - 清除localStorage:
     ```javascript
     localStorage.clear()
     ```
   - 重新登录

### 错误4: "自评表已锁定，无法上传附件"

**原因**: 表单已提交并锁定

**解决方案**:
- 这是正常行为
- 提交后无法再上传附件
- 如需修改，需要联系管理员打回

### 错误5: "文件格式不支持"

**原因**: 上传的文件格式不在支持列表中

**解决方案**:
1. 检查文件格式
2. 不同指标支持不同格式:
   - 证书类: pdf, jpg, jpeg, png
   - 项目类: pdf, doc, docx, ppt, pptx

## 调试指南

### 1. 检查登录状态

打开浏览器控制台（F12），执行：

```javascript
// 检查token
const token = localStorage.getItem('token')
console.log('Token存在:', !!token)
console.log('Token长度:', token ? token.length : 0)

// 检查用户信息
const user = localStorage.getItem('user')
console.log('用户信息:', user ? JSON.parse(user) : null)
```

### 2. 检查API请求

打开Network标签，查看API请求：

1. 提交表单时的请求:
   - URL: `/api/teaching-office/self-evaluation`
   - Method: POST
   - Status: 应该是200或201

2. 上传附件时的请求:
   - URL: `/api/teaching-office/attachments`
   - Method: POST
   - Status: 应该是201

3. 检查请求头:
   - 应该包含: `Authorization: Bearer <token>`

### 3. 检查后端服务

```bash
# 检查后端是否运行
netstat -ano | findstr :8000

# 应该看到类似输出:
# TCP    0.0.0.0:8000           0.0.0.0:0              LISTENING       7940
```

如果没有输出，说明后端未运行，需要启动：

```bash
cd backend
python -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

## 完整测试流程

### 测试1: 提交自评表

1. [ ] 清除浏览器缓存
2. [ ] 重新登录系统
3. [ ] 填写所有8个必填项
4. [ ] 设置所有自评分
5. [ ] 点击"提交表单"
6. [ ] 验证提交成功消息
7. [ ] 验证按钮变为"已提交"
8. [ ] 登录考评小组端验证数据

### 测试2: 上传附件

1. [ ] 确保已登录
2. [ ] 点击"材料提交"
3. [ ] 选择考核指标
4. [ ] 上传测试文件（PDF）
5. [ ] 验证上传进度
6. [ ] 验证上传成功消息
7. [ ] 验证文件出现在列表中
8. [ ] 尝试删除文件
9. [ ] 点击"提交附件"

## 预期行为

### 提交成功后

1. 显示成功消息
2. 表单状态变为"已提交"
3. 提交按钮禁用
4. 数据保存到数据库
5. 状态变为"locked"
6. 触发AI评分
7. 考评小组端能看到待评分表单

### 上传成功后

1. 显示上传进度
2. 显示成功消息
3. 文件出现在列表
4. 可以删除文件（提交前）
5. 提交后无法删除

## 数据流转

```
教研室端填写表单
    ↓
点击"提交表单"
    ↓
保存到数据库（status: draft）
    ↓
提交并锁定（status: locked）
    ↓
触发AI评分（status: ai_scored）
    ↓
显示在考评小组端的手动评分列表
```

## 需要帮助？

如果问题仍然存在，请提供：

1. **浏览器控制台截图**
   - F12 → Console标签
   - 显示所有错误和警告

2. **Network标签截图**
   - F12 → Network标签
   - 显示失败的API请求
   - 包括请求头和响应

3. **Local Storage截图**
   - F12 → Application标签
   - Local Storage → http://localhost:3000
   - 显示token和user

4. **后端日志**
   - 后端窗口的完整输出
   - 包括错误堆栈

5. **具体操作步骤**
   - 详细描述你的操作
   - 在哪一步出现问题
   - 具体的错误信息

---

**最后更新**: 2026-02-13
**版本**: 1.0.0
**状态**: ✅ 已修复附件上传URL配置
