# 评分流程修复 - 代码变更详情

**修复日期**: 2026-02-15  
**修复状态**: ✅ 完成  

---

## 修改的文件

### 1. `backend/app/api/v1/endpoints/auth.py`

**修改位置**: 登录响应返回

**修改前**:
```python
return LoginResponse(
    token=access_token,
    userId=str(user.id),
    role=user.role,
    teachingOfficeId=str(user.teaching_office_id) if user.teaching_office_id else None,
    expiresIn=settings.ACCESS_TOKEN_EXPIRE_MINUTES * 60  # Convert to seconds
)
```

**修改后**:
```python
# Return teaching_office_id only for teaching_office role users
teaching_office_id = None
if user.role == "teaching_office" and user.teaching_office_id:
    teaching_office_id = str(user.teaching_office_id)

return LoginResponse(
    token=access_token,
    userId=str(user.id),
    role=user.role,
    teachingOfficeId=teaching_office_id,
    expiresIn=settings.ACCESS_TOKEN_EXPIRE_MINUTES * 60  # Convert to seconds
)
```

**说明**:
- 仅为 teaching_office 角色返回 teaching_office_id
- 其他角色返回 None（而非空字符串）
- 这样可以在前端区分用户是否需要 teaching_office_id

---

### 2. `backend/app/api/v1/endpoints/scoring.py`

#### 修改 2.1: 权重函数

**修改位置**: `get_reviewer_weight` 函数

**修改前**:
```python
def get_reviewer_weight(reviewer_role: str) -> Decimal:
    """
    Get weight for reviewer based on role.
    
    考评小组 (evaluation_team) has higher weight than 考评办公室 (evaluation_office).
    """
    weights = {
        "evaluation_team": Decimal("0.70"),  # 考评小组权重更高
        "evaluation_office": Decimal("0.50"),
    }
    return weights.get(reviewer_role, Decimal("0.50"))
```

**修改后**:
```python
def get_reviewer_weight(reviewer_role: str) -> Decimal:
    """
    Get weight for reviewer based on role.
    
    考评小组 (evaluation_team) has higher weight than 考评办公室 (evaluation_office).
    evaluator has same weight as evaluation_team.
    """
    weights = {
        "evaluation_team": Decimal("0.70"),  # 考评小组权重更高
        "evaluation_office": Decimal("0.50"),
        "evaluator": Decimal("0.70"),  # evaluator has same weight as evaluation_team
    }
    return weights.get(reviewer_role, Decimal("0.50"))
```

**说明**:
- 添加 evaluator 角色到权重字典
- 设置 evaluator 权重为 0.70（与 evaluation_team 相同）
- 这样 evaluator 的评分权重与考评小组相同

#### 修改 2.2: 权限检查

**修改位置**: `submit_manual_score` 函数的权限检查

**修改前**:
```python
@router.post("/manual-score", response_model=ManualScoreResponse, status_code=status.HTTP_201_CREATED)
def submit_manual_score(
    score_data: ManualScoreCreate,
    db: Session = Depends(get_db),
    current_user: User = Depends(require_management_roles)
):
```

**修改后**:
```python
@router.post("/manual-score", response_model=ManualScoreResponse, status_code=status.HTTP_201_CREATED)
def submit_manual_score(
    score_data: ManualScoreCreate,
    db: Session = Depends(get_db),
    current_user: User = Depends(RoleChecker(["evaluation_team", "evaluation_office", "evaluator"]))
):
```

**说明**:
- 修改权限检查从 `require_management_roles` 到 `RoleChecker`
- 添加 "evaluator" 到允许的角色列表
- 这样 evaluator 用户可以调用 manual-score API

---

### 3. `frontend/src/components/ManualScoringForm.vue`

#### 修改 3.1: 加载附件函数

**修改位置**: `loadAttachments` 函数

**修改前**:
```typescript
// Load attachments
const loadAttachments = async () => {
  attachmentsLoading.value = true
  try {
    const response = await apiClient.get(`/teaching-office/attachments/${props.evaluationId}`)
    attachments.value = response.data
  } catch (error: any) {
    console.error('Failed to load attachments:', error)
    ElMessage.error('加载附件列表失败')
  } finally {
    attachmentsLoading.value = false
  }
}
```

**修改后**:
```typescript
// Load attachments
const loadAttachments = async () => {
  attachmentsLoading.value = true
  try {
    // Use the correct API endpoint based on user role
    // evaluator should use /attachments, teaching_office should use /teaching-office/attachments
    const endpoint = props.currentUserRole ? `/attachments/${props.evaluationId}` : `/teaching-office/attachments/${props.evaluationId}`
    const response = await apiClient.get(endpoint)
    attachments.value = response.data
  } catch (error: any) {
    console.error('Failed to load attachments:', error)
    ElMessage.error('加载附件列表失败')
  } finally {
    attachmentsLoading.value = false
  }
}
```

**说明**:
- 根据用户角色选择正确的 API 路径
- evaluator 使用 `/attachments/{id}`
- teaching_office 使用 `/teaching-office/attachments/{id}`
- 这样可以避免权限错误

#### 修改 3.2: 下载附件函数

**修改位置**: `handleDownloadAttachment` 函数

**修改前**:
```typescript
// Download attachment
const handleDownloadAttachment = async (attachment: any) => {
  try {
    const response = await apiClient.get(`/teaching-office/attachments/${attachment.id}/download`, {
      responseType: 'blob'
    })
    
    // Create download link
    const url = window.URL.createObjectURL(new Blob([response.data]))
    const link = document.createElement('a')
    link.href = url
    link.setAttribute('download', attachment.file_name || 'attachment')
    document.body.appendChild(link)
    link.click()
    document.body.removeChild(link)
    window.URL.revokeObjectURL(url)
    
    ElMessage.success('文件下载成功')
  } catch (error: any) {
    console.error('Failed to download attachment:', error)
    ElMessage.error('文件下载失败')
  }
}
```

**修改后**:
```typescript
// Download attachment
const handleDownloadAttachment = async (attachment: any) => {
  try {
    // Use the correct API endpoint for downloading
    const endpoint = `/attachments/${attachment.id}/download`
    const response = await apiClient.get(endpoint, {
      responseType: 'blob'
    })
    
    // Create download link
    const url = window.URL.createObjectURL(new Blob([response.data]))
    const link = document.createElement('a')
    link.href = url
    link.setAttribute('download', attachment.file_name || 'attachment')
    document.body.appendChild(link)
    link.click()
    document.body.removeChild(link)
    window.URL.revokeObjectURL(url)
    
    ElMessage.success('文件下载成功')
  } catch (error: any) {
    console.error('Failed to download attachment:', error)
    ElMessage.error('文件下载失败')
  }
}
```

**说明**:
- 修改下载路径为 `/attachments/{id}/download`
- 这个路径对所有认证用户都可用
- 避免了权限错误

---

## 修改总结

### 后端修改
| 文件 | 修改 | 行数 |
|-----|------|------|
| auth.py | 登录响应逻辑 | 3 行 |
| scoring.py | 权重函数 | 2 行 |
| scoring.py | 权限检查 | 1 行 |

### 前端修改
| 文件 | 修改 | 行数 |
|-----|------|------|
| ManualScoringForm.vue | 加载附件函数 | 3 行 |
| ManualScoringForm.vue | 下载附件函数 | 1 行 |

### 总计
- **后端**: 6 行代码修改
- **前端**: 4 行代码修改
- **总计**: 10 行代码修改

---

## 验证修改

### 后端验证

#### 1. 验证登录响应
```bash
# 教研室用户
curl -X POST http://localhost:8000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"director1","password":"password123"}'

# 预期: teachingOfficeId 返回实际 ID

# evaluator 用户
curl -X POST http://localhost:8000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"evaluator1","password":"password123"}'

# 预期: teachingOfficeId 返回 null
```

#### 2. 验证权限检查
```bash
TOKEN="<evaluator_token>"

# 应该成功
curl -X POST http://localhost:8000/api/scoring/manual-score \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"evaluation_id":"<id>","scores":[{"indicator":"test","score":8,"comment":"test"}]}'

# 预期: 201 Created
```

#### 3. 验证权重函数
```python
# 在后端测试
from app.api.v1.endpoints.scoring import get_reviewer_weight
from decimal import Decimal

assert get_reviewer_weight("evaluator") == Decimal("0.70")
assert get_reviewer_weight("evaluation_team") == Decimal("0.70")
assert get_reviewer_weight("evaluation_office") == Decimal("0.50")
```

### 前端验证

#### 1. 验证 API 路径
```typescript
// 在浏览器控制台检查网络请求
// 应该看到 GET /api/attachments/<id> 而非 /api/teaching-office/attachments/<id>
```

#### 2. 验证附件加载
```typescript
// 在 ManualScoringForm 中测试
// 应该能够加载附件列表而不出现 403 错误
```

---

## 部署步骤

### 1. 后端部署
```bash
# 1. 更新代码
git pull origin main

# 2. 重启后端服务
cd backend
python -m uvicorn app.main:app --reload
```

### 3. 前端部署
```bash
# 1. 更新代码
git pull origin main

# 2. 重新构建
cd frontend
npm run build

# 3. 部署到服务器
# 或者在开发环境重启
npm run dev
```

### 4. 验证部署
```bash
# 1. 测试登录
# 2. 测试评分流程
# 3. 检查日志
```

---

## 回滚步骤

如果需要回滚修改：

### 后端回滚
```bash
# 恢复 auth.py
git checkout backend/app/api/v1/endpoints/auth.py

# 恢复 scoring.py
git checkout backend/app/api/v1/endpoints/scoring.py

# 重启后端
python -m uvicorn app.main:app --reload
```

### 前端回滚
```bash
# 恢复 ManualScoringForm.vue
git checkout frontend/src/components/ManualScoringForm.vue

# 重启前端
npm run dev
```

---

## 常见问题

### Q: 修改后仍然收到 403 错误
**A**: 
1. 确保后端已重启
2. 清除浏览器缓存
3. 检查 token 是否有效
4. 查看后端日志中的 RoleChecker 日志

### Q: 附件加载失败
**A**:
1. 检查前端 API 路径是否正确
2. 验证 evaluation_id 是否正确
3. 检查后端是否返回 200 OK

### Q: 评分提交返回 400 错误
**A**:
1. 检查 scores 格式是否为列表
2. 验证 evaluation_id 是否存在
3. 检查是否已经提交过评分

---

**修复完成**: 2026-02-15  
**状态**: ✅ 完成  
**下一步**: 部署和测试
