# 教研室数据管理平台 - 数据库表结构详解

## 📊 数据库概览

**数据库名**: teaching_office_evaluation  
**表数量**: 15个  
**字符集**: utf8mb4（支持中文和emoji）

---

## 🏗️ 表分类

数据库的15个表可以分为4大类：

### 1️⃣ 基础数据表（3个）
- users（用户表）
- colleges（学院表）
- teaching_offices（教研室表）

### 2️⃣ 核心业务表（2个）
- self_evaluations（自评表）
- attachments（附件表）

### 3️⃣ 评分相关表（3个）
- ai_scores（AI评分表）
- manual_scores（手动评分表）
- final_scores（最终得分表）

### 4️⃣ 管理功能表（7个）
- anomalies（异常表）
- publications（公示表）
- approvals（审批表）
- operation_logs（操作日志表）
- sync_tasks（同步任务表）
- insight_summaries（洞察摘要表）
- improvement_plans（改进计划表）

---

## 📋 详细表说明

### 1. users（用户表）👥

**作用**: 存储系统中所有用户的信息

**主要字段**:
```
id                  - 用户唯一ID（UUID）
username            - 登录用户名（唯一）
password_hash       - 加密后的密码
role                - 用户角色（teaching_office/review_group/president_office等）
teaching_office_id  - 所属教研室ID（外键）
college_id          - 所属学院ID（外键）
name                - 真实姓名
email               - 邮箱
created_at          - 创建时间
updated_at          - 更新时间
```

**用户角色类型**:
- `teaching_office` - 教研室用户
- `review_group` - 评教小组成员
- `review_office` - 评教小组办公室
- `president_office` - 校长办公会成员

**关系**:
- 属于某个教研室（teaching_office_id）
- 属于某个学院（college_id）
- 可以是学院的院长（colleges.dean_id）

---

### 2. colleges（学院表）🏫

**作用**: 存储学院信息

**主要字段**:
```
id       - 学院唯一ID（UUID）
name     - 学院名称（唯一）
dean_id  - 院长用户ID（外键，指向users表）
```

**示例数据**:
- 计算机学院
- 经济管理学院
- 外国语学院

**关系**:
- 包含多个教研室（teaching_offices）
- 包含多个用户（users）
- 有一个院长（dean_id → users）

---

### 3. teaching_offices（教研室表）🏢

**作用**: 存储教研室信息

**主要字段**:
```
id          - 教研室唯一ID（UUID）
name        - 教研室名称
code        - 教研室代码（唯一，用于标识）
department  - 所属系部
college_id  - 所属学院ID（外键）
created_at  - 创建时间
updated_at  - 更新时间
```

**示例数据**:
- 软件工程教研室（code: SE001）
- 计算机科学教研室（code: CS001）
- 网络工程教研室（code: NE001）

**关系**:
- 属于某个学院（college_id → colleges）
- 有多个用户（users）
- 有多个自评记录（self_evaluations）

---

### 4. self_evaluations（自评表）📝

**作用**: 存储教研室的自评数据（核心表）

**主要字段**:
```
id                  - 自评记录唯一ID（UUID）
teaching_office_id  - 教研室ID（外键）
evaluation_year     - 评估年份（如2024）
content             - 自评内容（JSON格式，存储评分表数据）
status              - 状态（draft草稿/submitted已提交/reviewed已审核）
submitted_at        - 提交时间
created_at          - 创建时间
updated_at          - 更新时间
version             - 版本号（用于乐观锁，防止并发冲突）
```

**content字段结构**（JSON）:
```json
{
  "indicators": [
    {
      "id": "1",
      "name": "教学改革项目",
      "declared_count": 5,
      "self_score": 10
    },
    {
      "id": "2",
      "name": "荣誉奖项",
      "declared_count": 3,
      "self_score": 8
    }
  ]
}
```

**关系**:
- 属于某个教研室（teaching_office_id → teaching_offices）
- 有多个附件（attachments）
- 有AI评分记录（ai_scores）
- 有手动评分记录（manual_scores）
- 有最终得分（final_score）
- 可能有异常记录（anomalies）
- 有洞察摘要（insight_summary）
- 有改进计划（improvement_plans）

---

### 5. attachments（附件表）📎

**作用**: 存储上传的支撑材料文件信息

**主要字段**:
```
id             - 附件唯一ID（UUID）
evaluation_id  - 所属自评记录ID（外键）
indicator      - 对应的指标项（如"教学改革项目"）
file_name      - 原始文件名
file_size      - 文件大小（字节）
file_type      - 文件类型（pdf/docx/jpg等）
storage_path   - 存储路径（MinIO中的路径，唯一）
classified_by  - 分类方式（manual手动/ai自动）
uploaded_at    - 上传时间
is_archived    - 是否已归档
archived_at    - 归档时间
```

**支持的文件类型**:
- PDF文档
- Word文档（.doc, .docx）
- Excel表格（.xls, .xlsx）
- 图片（.jpg, .png）
- 压缩包（.zip, .rar）

**关系**:
- 属于某个自评记录（evaluation_id → self_evaluations）
- 通过自评记录关联到教研室

---

### 6. ai_scores（AI评分表）🤖

**作用**: 存储AI自动评分的结果

**主要字段**:
```
id                      - AI评分记录ID（UUID）
evaluation_id           - 自评记录ID（外键）
total_score             - AI评定的总分
indicator_scores        - 各指标的得分（JSON格式）
parsed_reform_projects  - 解析出的教改项目数量
parsed_honorary_awards  - 解析出的荣誉奖项数量
scored_at               - 评分时间
```

**indicator_scores结构**（JSON）:
```json
{
  "1": {
    "name": "教学改革项目",
    "score": 10,
    "parsed_count": 5
  },
  "2": {
    "name": "荣誉奖项",
    "score": 8,
    "parsed_count": 3
  }
}
```

**特殊约束**:
- ⚠️ **不可修改**：一旦创建，不能更新或删除（通过SQLAlchemy事件监听器强制）
- 保证评分的可追溯性和审计性

**关系**:
- 属于某个自评记录（evaluation_id → self_evaluations）

---

### 7. manual_scores（手动评分表）✍️

**作用**: 存储评教小组的人工评分记录

**主要字段**:
```
id             - 手动评分记录ID（UUID）
evaluation_id  - 自评记录ID（外键）
reviewer_id    - 评分人ID（外键，指向users）
reviewer_name  - 评分人姓名
reviewer_role  - 评分人角色
weight         - 权重（如0.3表示30%）
scores         - 各指标的评分（JSON格式）
submitted_at   - 提交时间
```

**scores结构**（JSON）:
```json
{
  "1": {
    "name": "教学改革项目",
    "score": 9
  },
  "2": {
    "name": "荣誉奖项",
    "score": 7
  }
}
```

**评分权重示例**:
- 评教小组成员A：权重0.3（30%）
- 评教小组成员B：权重0.3（30%）
- 评教小组组长：权重0.4（40%）

**特殊约束**:
- ⚠️ **不可修改**：一旦提交，不能更新或删除
- 保证评分的公正性和可追溯性

**关系**:
- 属于某个自评记录（evaluation_id → self_evaluations）
- 由某个用户评分（reviewer_id → users）

---

### 8. final_scores（最终得分表）🏆

**作用**: 存储经过审定的最终得分

**主要字段**:
```
id             - 最终得分记录ID（UUID）
evaluation_id  - 自评记录ID（外键，唯一）
final_score    - 最终得分
summary        - 评价总结
determined_by  - 审定人ID（外键，指向users）
determined_at  - 审定时间
version        - 版本号（乐观锁）
```

**计算方式**:
```
最终得分 = AI评分 × 权重1 + 手动评分1 × 权重2 + 手动评分2 × 权重3 + ...
```

**特殊约束**:
- ⚠️ **不可修改**：一旦审定，不能更新或删除
- 每个自评记录只能有一个最终得分（唯一约束）

**关系**:
- 属于某个自评记录（evaluation_id → self_evaluations）
- 由某个用户审定（determined_by → users）

---

### 9. anomalies（异常表）⚠️

**作用**: 记录评分过程中发现的异常情况

**主要字段**:
```
id              - 异常记录ID（UUID）
evaluation_id   - 自评记录ID（外键）
type            - 异常类型（count_mismatch数量不匹配/missing_evidence缺少证据等）
indicator       - 异常指标项
declared_count  - 申报数量
parsed_count    - AI解析数量
description     - 异常描述
status          - 处理状态（pending待处理/resolved已解决/ignored已忽略）
handled_by      - 处理人ID（外键）
handled_action  - 处理动作（adjust调整/accept接受）
handled_at      - 处理时间
```

**异常类型**:
- `count_mismatch` - 申报数量与AI解析数量不一致
- `missing_evidence` - 缺少支撑材料
- `invalid_format` - 文件格式不正确
- `duplicate_entry` - 重复提交

**处理流程**:
1. AI评分时自动检测异常
2. 创建异常记录（status=pending）
3. 评教小组处理异常
4. 更新状态为resolved或ignored

**关系**:
- 属于某个自评记录（evaluation_id → self_evaluations）
- 由某个用户处理（handled_by → users）

---

### 10. publications（公示表）📢

**作用**: 记录考评结果的公示信息

**主要字段**:
```
id              - 公示记录ID（UUID）
evaluation_ids  - 公示的自评记录ID列表（JSON数组）
published_by    - 公示人ID（外键）
published_at    - 公示时间
distributed_at  - 分发时间（发送给校长办公会）
```

**evaluation_ids结构**（JSON）:
```json
[
  "uuid-1",
  "uuid-2",
  "uuid-3"
]
```

**公示流程**:
1. 评教小组办公室选择要公示的自评记录
2. 创建公示记录
3. 公示期结束后，分发给校长办公会

**关系**:
- 包含多个自评记录（evaluation_ids）
- 由某个用户公示（published_by → users）

---

### 11. approvals（审批表）✅

**作用**: 记录校长办公会的审批决定

**主要字段**:
```
id              - 审批记录ID（UUID）
evaluation_ids  - 审批的自评记录ID列表（JSON数组）
decision        - 审批决定（approved通过/rejected驳回）
reject_reason   - 驳回原因
approved_by     - 审批人ID（外键）
approved_at     - 审批时间
```

**审批流程**:
1. 校长办公会收到公示数据
2. 审阅评分结果
3. 做出审批决定（通过/驳回）
4. 如果驳回，填写驳回原因

**关系**:
- 包含多个自评记录（evaluation_ids）
- 由某个用户审批（approved_by → users）

---

### 12. operation_logs（操作日志表）📜

**作用**: 记录系统中所有重要操作，用于审计

**主要字段**:
```
id              - 日志记录ID（UUID）
operation_type  - 操作类型（create/update/delete/submit/approve等）
operator_id     - 操作人ID（外键）
operator_name   - 操作人姓名
operator_role   - 操作人角色
target_id       - 操作目标ID
target_type     - 操作目标类型（self_evaluation/attachment/score等）
details         - 操作详情（JSON格式）
operated_at     - 操作时间
```

**操作类型示例**:
- `create_evaluation` - 创建自评
- `submit_evaluation` - 提交自评
- `upload_attachment` - 上传附件
- `ai_score` - AI评分
- `manual_score` - 手动评分
- `publish_result` - 公示结果
- `approve_result` - 审批结果

**details结构**（JSON）:
```json
{
  "action": "submit_evaluation",
  "evaluation_id": "uuid-xxx",
  "teaching_office": "软件工程教研室",
  "year": 2024
}
```

**用途**:
- 审计追踪
- 问题排查
- 操作统计
- 安全监控

**关系**:
- 由某个用户操作（operator_id → users）

---

### 13. sync_tasks（同步任务表）🔄

**作用**: 管理数据同步任务（从管理端到校长办公会端）

**主要字段**:
```
id              - 同步任务ID（UUID）
evaluation_ids  - 要同步的自评记录ID列表（JSON数组）
status          - 任务状态（pending/syncing/completed/failed）
synced_count    - 已同步数量
failed_count    - 失败数量
total_count     - 总数量
started_at      - 开始时间
completed_at    - 完成时间
error_message   - 错误信息
retry_count     - 重试次数
checksum        - 数据校验和（SHA256）
sync_data       - 同步数据包（JSON格式）
```

**同步流程**:
1. 创建同步任务（status=pending）
2. 开始同步（status=syncing）
3. 同步完成（status=completed）或失败（status=failed）
4. 如果失败，可以重试

**关系**:
- 包含多个自评记录（evaluation_ids）

---

### 14. insight_summaries（洞察摘要表）💡

**作用**: 存储AI生成的分析摘要和建议

**主要字段**:
```
id             - 摘要记录ID（UUID）
evaluation_id  - 自评记录ID（外键，唯一）
summary        - AI生成的摘要文本
generated_at   - 生成时间
```

**摘要内容示例**:
```
该教研室在教学改革方面表现突出，共完成5个教改项目，
获得3项荣誉奖项。建议在科研成果转化方面加强投入。
主要优势：教学质量高、团队协作好
改进方向：科研产出、国际交流
```

**生成时机**:
- AI评分完成后自动生成
- 使用DeepSeek API分析评分数据

**关系**:
- 属于某个自评记录（evaluation_id → self_evaluations）
- 每个自评记录只有一个摘要（唯一约束）

---

### 15. improvement_plans（改进计划表）📈

**作用**: 存储下学期的改进措施和计划

**主要字段**:
```
id                  - 改进计划ID（UUID）
evaluation_id       - 自评记录ID（外键）
indicator_item_id   - 指标项ID
target              - 改进目标
measures            - 改进措施
charger_id          - 负责人ID（外键）
deadline            - 截止日期
status              - 状态（PENDING/APPROVED/REJECTED/COMPLETED）
supervisor_comment  - 督导意见
created_at          - 创建时间
updated_at          - 更新时间
```

**改进计划示例**:
```
指标项：教学改革项目
目标：完成3个省级教改项目申报
措施：
  1. 组织教改项目申报培训
  2. 邀请专家指导项目书撰写
  3. 建立项目团队协作机制
负责人：张三
截止日期：2025-06-30
```

**状态流转**:
```
PENDING（待审批）→ APPROVED（已批准）→ COMPLETED（已完成）
                 ↓
              REJECTED（已驳回）
```

**关系**:
- 属于某个自评记录（evaluation_id → self_evaluations）
- 有一个负责人（charger_id → users）

---

## 🔗 表关系图

```
colleges (学院)
  ├─→ teaching_offices (教研室)
  │     └─→ self_evaluations (自评)
  │           ├─→ attachments (附件)
  │           ├─→ ai_scores (AI评分) [不可修改]
  │           ├─→ manual_scores (手动评分) [不可修改]
  │           ├─→ final_scores (最终得分) [不可修改]
  │           ├─→ anomalies (异常)
  │           ├─→ insight_summaries (洞察摘要)
  │           └─→ improvement_plans (改进计划)
  │
  └─→ users (用户)
        ├─→ operation_logs (操作日志)
        ├─→ publications (公示)
        ├─→ approvals (审批)
        └─→ manual_scores (评分人)

sync_tasks (同步任务) - 独立表
```

---

## 🔒 数据完整性约束

### 唯一性约束
- users.username - 用户名唯一
- colleges.name - 学院名称唯一
- teaching_offices.code - 教研室代码唯一
- attachments.storage_path - 文件存储路径唯一
- final_scores.evaluation_id - 每个自评只有一个最终得分
- insight_summaries.evaluation_id - 每个自评只有一个摘要

### 外键约束
- 所有外键都有ON DELETE和ON UPDATE规则
- 保证数据引用完整性

### 不可变约束（通过代码实现）
- ai_scores - 创建后不可修改或删除
- manual_scores - 创建后不可修改或删除
- final_scores - 创建后不可修改或删除

### 乐观锁
- self_evaluations.version - 防止并发修改冲突
- final_scores.version - 防止并发修改冲突

---

## 📊 数据流转流程

### 完整的考评流程

```
1. 教研室填写自评
   ↓ (创建 self_evaluations)
   
2. 上传支撑材料
   ↓ (创建 attachments)
   
3. AI自动评分
   ↓ (创建 ai_scores, 可能创建 anomalies)
   
4. 评教小组处理异常
   ↓ (更新 anomalies)
   
5. 评教小组手动评分
   ↓ (创建 manual_scores)
   
6. 审定最终得分
   ↓ (创建 final_scores)
   
7. 生成洞察摘要
   ↓ (创建 insight_summaries)
   
8. 公示结果
   ↓ (创建 publications)
   
9. 同步到校长办公会
   ↓ (创建 sync_tasks)
   
10. 校长办公会审批
    ↓ (创建 approvals)
    
11. 制定改进计划
    ↓ (创建 improvement_plans)
```

每一步操作都会记录到 operation_logs 表中。

---

## 💾 存储估算

假设有100个教研室，每年一次考评：

| 表名 | 每年记录数 | 单条大小 | 年增长 |
|------|-----------|---------|--------|
| self_evaluations | 100 | ~5KB | 500KB |
| attachments | 1000 | ~1KB | 1MB |
| ai_scores | 100 | ~2KB | 200KB |
| manual_scores | 300 | ~2KB | 600KB |
| final_scores | 100 | ~1KB | 100KB |
| anomalies | 50 | ~1KB | 50KB |
| operation_logs | 5000 | ~1KB | 5MB |
| improvement_plans | 500 | ~2KB | 1MB |
| **总计** | | | **~8.5MB/年** |

基础数据表（users, colleges, teaching_offices）增长缓慢。

---

## 🎯 总结

这个数据库设计：

✅ **完整性** - 覆盖了考评的全流程  
✅ **可追溯** - 所有操作都有日志记录  
✅ **不可篡改** - 关键评分数据不可修改  
✅ **高性能** - 合理的索引设计  
✅ **可扩展** - 使用JSON字段存储灵活数据  
✅ **安全性** - 外键约束保证数据完整性  

这是一个设计良好的教研室考评管理系统数据库！
