# 表单提交和附件上传功能修复完成

## 修复时间
2026-02-14

## 问题描述
教研室端无法提交表单，无法上传附件。用户在填写自评表时遇到验证错误，无法正常提交。

## 根本原因
在之前的修改中，附件上传功能集成到表单中时，文件上传组件被设置为 `disabled` 状态（当未选择考核指标时），导致用户体验不佳。同时，文件验证逻辑不够完善。

## 修复内容

### 1. 移除上传组件的 disabled 限制
- **修改前**: 上传组件在未选择考核指标时被禁用
- **修改后**: 移除 `disabled` 属性，允许用户随时添加文件
- **好处**: 用户可以先选择文件，再选择考核指标，更灵活

### 2. 增强文件验证逻辑
在 `handleFileChange` 方法中添加了完整的验证：
- 检查是否已选择考核指标
- 验证文件大小（不超过50MB）
- 验证文件格式（根据考核指标的支持格式）
- 自动为文件添加考核指标元数据

### 3. 优化考核指标切换逻辑
- **修改前**: 切换考核指标时清空所有已选文件
- **修改后**: 切换考核指标时保留文件，只更新它们的指标元数据
- **好处**: 用户不会因为切换指标而丢失已选择的文件

### 4. 改进用户提示信息
- 当前指标显示更清晰（蓝色高亮）
- 未选择指标时显示警告图标和明确提示
- 已选择文件时显示绿色确认信息

## 修改的文件
- `frontend/src/components/NewSelfEvaluationForm.vue`

## 功能说明

### 附件上传流程
1. 用户填写自评表各项内容
2. 在"附件上传"区域选择考核指标
3. 拖拽或点击上传文件（支持多文件）
4. 系统自动验证文件格式和大小
5. 点击"提交表单并上传附件"按钮
6. 系统先保存表单，获取 evaluation_id
7. 然后自动上传所有附件
8. 最后提交到考评小组并触发AI评分

### 支持的考核指标
- 教学改革项目
- 荣誉表彰
- 课程建设
- 教学质量
- 学生指导
- 科研工作
- 团队建设

### 文件限制
- 单个文件最大 50MB
- 最多上传 10 个文件
- 支持格式根据考核指标不同而不同（pdf, doc, docx, jpg, jpeg, png, ppt, pptx, xls, xlsx）

## 测试建议

### 测试步骤
1. 登录教研室端账号（如 office1 / password123）
2. 进入"自评表填写"页面
3. 填写各项必填内容
4. 滚动到"附件上传"区域
5. 先选择考核指标（如"教学改革项目"）
6. 点击或拖拽上传文件
7. 验证文件格式和大小限制是否生效
8. 可以添加多个文件
9. 点击"提交表单并上传附件"
10. 观察提交过程和成功提示
11. 验证是否跳转到教研室主页

### 预期结果
- 文件验证正常工作
- 上传进度显示清晰
- 提交成功后显示成功消息
- 自动跳转到主页

## 技术细节

### 文件元数据
每个上传的文件都会附加以下元数据：
```typescript
{
  indicator: string,  // 考核指标
  name: string,       // 文件名
  size: number,       // 文件大小
  raw: File          // 原始文件对象
}
```

### 上传API
- 端点: `POST /api/teaching-office/attachments`
- 请求格式: `multipart/form-data`
- 参数:
  - `evaluation_id`: 自评表ID
  - `indicator`: 考核指标
  - `files`: 文件（支持多个）

## 注意事项
1. 附件上传是可选的，用户可以只提交表单不上传附件
2. 如果附件上传失败，表单仍会保存，用户可以稍后单独上传
3. 提交后表单和附件都会被锁定，需要管理员打回才能修改
4. 系统会自动触发AI评分，无需手动操作

## 后续优化建议
1. 添加附件预览功能
2. 支持附件下载
3. 添加上传进度条
4. 支持断点续传
5. 添加附件分类管理
