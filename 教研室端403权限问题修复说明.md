# 教研室端 403 Forbidden 权限问题修复说明

## 问题诊断

在教研室端提交自评表时，虽然登录成功并获取到了 Token，但在点击提交时，接口 `api/teaching-office/self-evaluation` 返回了 **403 Forbidden** 错误。

### 根本原因

后端接口缺少**角色权限检查**。虽然接口通过了 Token 验证（401 检查），但没有进行角色权限验证（403 检查）。

具体来说：
- `self_evaluation.py` 中的所有接口都使用了 `get_current_user` 依赖
- `get_current_user` 只验证 Token 的有效性，不检查用户角色
- 缺少 `RoleChecker` 的权限检查，导致所有用户都被拒绝访问

## 修复方案

### 1. 自评表接口权限配置 (`self_evaluation.py`)

添加了 `RoleChecker` 来限制只有 `teaching_office` 角色的用户可以访问：

```python
# 导入权限检查器
from app.core.deps import get_db, get_current_user, RoleChecker

# 创建教研室角色检查器
require_teaching_office = RoleChecker(["teaching_office"])

# 在所有教研室端接口中使用
@router.post("/self-evaluation", response_model=SelfEvaluationSaveResponse)
def create_self_evaluation(
    evaluation_data: SelfEvaluationCreate,
    db: Session = Depends(get_db),
    current_user: User = Depends(require_teaching_office),  # ← 添加权限检查
):
    ...
```

**修改的接口：**
- `POST /teaching-office/self-evaluation` - 创建/保存自评表
- `GET /teaching-office/self-evaluation/{evaluation_id}` - 查询自评表
- `PUT /teaching-office/self-evaluation/{evaluation_id}` - 更新自评表
- `POST /teaching-office/self-evaluation/{evaluation_id}/submit` - 提交自评表
- `POST /teaching-office/trigger-ai-scoring` - 触发 AI 评分

### 2. 附件上传接口权限配置 (`attachments.py`)

根据接口的用途，配置了不同的权限：

```python
# 创建两个角色检查器
require_teaching_office = RoleChecker(["teaching_office"])
require_management_roles = RoleChecker(["evaluation_team", "evaluation_office"])

# 教研室端接口（仅教研室可访问）
@router.post("/attachments")
async def upload_attachments(
    ...,
    current_user: User = Depends(require_teaching_office),  # ← 教研室上传
):
    ...

@router.get("/attachments/{evaluation_id}")
def get_attachments(
    ...,
    current_user: User = Depends(require_teaching_office),  # ← 教研室查询
):
    ...

# 管理端接口（仅管理端可访问）
@router.get("/attachments")
def query_attachments(
    ...,
    current_user: User = Depends(require_management_roles),  # ← 管理端查询
):
    ...

@router.get("/attachments/{attachment_id}/download")
async def download_attachment(
    ...,
    current_user: User = Depends(require_management_roles),  # ← 管理端下载
):
    ...

@router.put("/attachments/{attachment_id}/classification")
def update_attachment_classification(
    ...,
    current_user: User = Depends(require_management_roles),  # ← 管理端调整分类
):
    ...
```

## 权限检查机制

### RoleChecker 工作原理

`RoleChecker` 是一个依赖注入类，在 `app/core/deps.py` 中定义：

```python
class RoleChecker:
    def __init__(self, allowed_roles: List[str]):
        self.allowed_roles = allowed_roles
    
    def __call__(self, current_user: User = Depends(get_current_user)) -> User:
        if current_user.role not in self.allowed_roles:
            raise HTTPException(
                status_code=status.HTTP_403_FORBIDDEN,
                detail=f"Access denied. Required roles: {', '.join(self.allowed_roles)}. Your role: {current_user.role}"
            )
        return current_user
```

### 权限检查流程

1. **Token 验证** (401 检查)
   - `get_current_user` 验证 JWT Token 的有效性
   - 如果 Token 无效或过期，返回 401 Unauthorized

2. **角色权限检查** (403 检查)
   - `RoleChecker` 检查用户的角色是否在允许列表中
   - 如果角色不匹配，返回 403 Forbidden

## 系统中的角色定义

系统中定义了以下四个角色：

| 角色 | 说明 | 可访问的接口 |
|------|------|-----------|
| `teaching_office` | 教研室 | 自评表提交、附件上传 |
| `evaluation_team` | 考评小组 | 手动评分、异常处理 |
| `evaluation_office` | 教务处 | 管理端操作、结果发布 |
| `president_office` | 校长办公室 | 数据大屏、最终审批 |

## 测试验证

### 测试场景 1：教研室用户提交自评表

```bash
# 1. 使用教研室账号登录
POST /api/auth/login
{
  "username": "teaching_office_001",
  "password": "password"
}

# 2. 获取 Token，然后提交自评表
POST /api/teaching-office/self-evaluation
Authorization: Bearer <token>
{
  "teaching_office_id": "...",
  "evaluation_year": 2024,
  "content": {...}
}

# 预期结果：201 Created ✓
```

### 测试场景 2：非教研室用户尝试提交自评表

```bash
# 1. 使用管理端账号登录
POST /api/auth/login
{
  "username": "evaluation_team_001",
  "password": "password"
}

# 2. 尝试提交自评表
POST /api/teaching-office/self-evaluation
Authorization: Bearer <token>
{
  "teaching_office_id": "...",
  "evaluation_year": 2024,
  "content": {...}
}

# 预期结果：403 Forbidden
# 错误信息：Access denied. Required roles: teaching_office. Your role: evaluation_team
```

## 修改的文件

1. **backend/app/api/v1/endpoints/self_evaluation.py**
   - 添加 `RoleChecker` 导入
   - 创建 `require_teaching_office` 检查器
   - 在 5 个接口中添加权限检查

2. **backend/app/api/v1/endpoints/attachments.py**
   - 添加 `RoleChecker` 导入
   - 创建 `require_teaching_office` 和 `require_management_roles` 检查器
   - 在 5 个接口中添加权限检查

## 后续建议

1. **审计其他接口** - 检查其他接口是否也需要添加权限检查
2. **权限文档** - 为每个接口添加权限要求的文档
3. **测试覆盖** - 添加权限检查的单元测试
4. **日志记录** - 记录权限拒绝事件用于审计

## 相关文件

- `backend/app/core/deps.py` - 权限检查器定义
- `backend/app/core/security.py` - Token 验证逻辑
- `backend/app/models/user.py` - 用户模型和角色定义
