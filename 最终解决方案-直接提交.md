# 最终解决方案 - 直接提交到考评小组端

## 已完成的修改

### 1. 简化提交流程

**修改文件**: `frontend/src/views/SelfEvaluation.vue`

**修改内容**:
- ✅ 删除了多余的提示信息
- ✅ 删除了"是否触发AI评分"的确认对话框
- ✅ 自动完成所有步骤：保存 → 提交 → 锁定 → AI评分
- ✅ 一键提交，直接上传到考评小组端

**新的流程**:
```
点击"提交表单"
    ↓
自动保存数据
    ↓
自动提交并锁定
    ↓
自动触发AI评分
    ↓
显示"提交成功！数据已上传到考评小组端"
    ↓
自动跳转到主页
```

### 2. 移除附件强制要求

**修改文件**: `backend/app/api/v1/endpoints/self_evaluation.py`

**修改内容**:
- ✅ 提交时不再强制要求附件
- ✅ AI评分时不再强制要求附件

## 核心问题：需要登录

### 问题说明
后端API需要JWT token认证，所以用户必须先登录才能提交表单。

### 解决方案

#### 方法1: 在前端登录（推荐）

1. **访问登录页面**
   ```
   http://localhost:3000/login
   ```

2. **创建测试用户**（如果还没有）
   
   在MySQL中执行：
   ```sql
   USE teaching_office_evaluation;

   -- 创建教研室
   INSERT INTO teaching_offices (id, name, description, created_at, updated_at)
   VALUES ('test-office-001', '测试教研室', '用于测试', NOW(), NOW())
   ON DUPLICATE KEY UPDATE name=name;

   -- 创建教研室端用户（密码: password123）
   INSERT INTO users (id, username, name, email, hashed_password, role, teaching_office_id, created_at, updated_at)
   VALUES (
       UUID(),
       'test_teaching_office',
       '测试教研室用户',
       'teaching@test.com',
       '$2b$12$LQv3c1yqBWVHxkd0LHAkCOYz6TtxMQJqhN8/LewY5GyYzpLaEg7Iq',
       'teaching_office',
       'test-office-001',
       NOW(),
       NOW()
   ) ON DUPLICATE KEY UPDATE username=username;

   -- 创建考评小组用户（密码: password123）
   INSERT INTO users (id, username, name, email, hashed_password, role, created_at, updated_at)
   VALUES (
       UUID(),
       'test_eval_team',
       '测试考评小组用户',
       'evalteam@test.com',
       '$2b$12$LQv3c1yqBWVHxkd0LHAkCOYz6TtxMQJqhN8/LewY5GyYzpLaEg7Iq',
       'evaluation_team',
       NULL,
       NOW(),
       NOW()
   ) ON DUPLICATE KEY UPDATE username=username;
   ```

3. **使用测试账号登录**
   - 用户名: `test_teaching_office`
   - 密码: `password123`

#### 方法2: 修改后端，移除认证要求（不推荐）

如果您想要在没有登录的情况下也能提交，需要修改后端API，移除认证要求。但这会带来安全风险。

## 完整的测试流程

### 步骤1: 准备测试用户

在MySQL中执行上面的SQL语句，创建测试用户。

### 步骤2: 登录前端

1. 访问 http://localhost:3000/login
2. 输入：
   - 用户名: `test_teaching_office`
   - 密码: `password123`
3. 点击登录

### 步骤3: 提交自评表

1. 登录成功后，访问 http://localhost:3000/self-evaluation
2. 填写自评表（所有必填项）
3. 点击"提交表单"按钮
4. 等待提示"提交成功！数据已上传到考评小组端"
5. 自动跳转到主页

### 步骤4: 验证结果

1. 退出登录
2. 使用考评小组账号登录：
   - 用户名: `test_eval_team`
   - 密码: `password123`
3. 访问 http://localhost:3000/manual-scoring
4. 应该能看到刚提交的自评表

## 提交流程说明

### 用户看到的流程
```
填写表单 → 点击"提交表单" → 看到"正在提交..." → 
看到"提交成功！数据已上传到考评小组端" → 自动跳转
```

### 系统后台处理
```
1. 保存表单数据（status: draft）
2. 提交并锁定（status: locked）
3. 触发AI评分（status: ai_scored）
4. 数据出现在考评小组端列表
```

### 数据状态流转
```
draft → locked → ai_scored → 显示在手动评分列表
```

## 为什么需要登录？

### 安全原因
- 防止未授权访问
- 确保数据来源可追溯
- 记录操作日志

### 业务原因
- 需要知道是哪个教研室提交的
- 需要记录提交人信息
- 需要进行权限控制

## 如果不想登录怎么办？

### 选项1: 使用默认用户（推荐）

修改前端代码，使用一个默认的token：

```typescript
// 在 frontend/src/api/client.ts 中
apiClient.interceptors.request.use(
  (config) => {
    // 使用默认token（需要先获取一个有效的token）
    const token = localStorage.getItem('token') || 'default_token_here'
    if (token) {
      config.headers.Authorization = `Bearer ${token}`
    }
    return config
  },
  (error) => {
    return Promise.reject(error)
  }
)
```

### 选项2: 修改后端API（不推荐）

移除所有API的认证要求，但这会带来严重的安全问题。

## 常见错误及解决

### 错误1: "Could not validate credentials"
**原因**: 没有登录或token无效

**解决**: 
1. 访问登录页面
2. 使用测试账号登录
3. 重新提交

### 错误2: "请先登录后再提交"
**原因**: token过期或无效

**解决**:
1. 重新登录
2. 确保token有效

### 错误3: 提交后在手动评分页面看不到
**原因**: 
- 状态不对
- 使用的账号角色不对
- 数据没有正确保存

**解决**:
1. 检查自评表状态（应该是 `locked` 或 `ai_scored`）
2. 使用考评小组或考评办公室账号登录
3. 查看数据库确认数据

## 验证方法

### 方法1: 查看浏览器控制台

打开浏览器控制台（F12），查看：
- Network标签：查看API请求和响应
- Console标签：查看错误信息

### 方法2: 查看后端日志

查看后端进程输出，应该看到：
```
INFO: POST /api/teaching-office/self-evaluation - 201 Created
INFO: POST /api/teaching-office/self-evaluation/{id}/submit - 200 OK
INFO: POST /api/teaching-office/trigger-ai-scoring - 200 OK
```

### 方法3: 查看数据库

```sql
-- 查看最新的自评表
SELECT id, teaching_office_id, evaluation_year, status, submitted_at 
FROM self_evaluations 
ORDER BY created_at DESC 
LIMIT 1;

-- 应该看到状态为 'locked' 或 'ai_scored'
```

## 快速开始

### 最简单的方式

1. **执行SQL创建用户**（复制上面的SQL到MySQL）

2. **登录前端**
   ```
   http://localhost:3000/login
   用户名: test_teaching_office
   密码: password123
   ```

3. **提交表单**
   ```
   http://localhost:3000/self-evaluation
   填写 → 点击"提交表单" → 完成
   ```

4. **查看结果**
   ```
   切换到考评小组账号
   http://localhost:3000/manual-scoring
   ```

## 总结

### 已完成
- ✅ 简化提交流程（一键提交）
- ✅ 自动完成所有步骤
- ✅ 移除附件强制要求
- ✅ 优化错误提示

### 需要用户做的
- ⚠️ 必须先登录
- ⚠️ 使用有效的账号

### 为什么需要登录
- 🔒 安全性
- 📝 可追溯性
- 👤 权限控制

现在，只要登录后点击"提交表单"，数据就会直接上传到考评小组端！🎉
