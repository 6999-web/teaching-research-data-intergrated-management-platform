# 403 Forbidden 错误诊断和修复

## 问题分析

从浏览器控制台的错误信息来看，所有API请求都返回 403 (Forbidden) 错误。

根本原因：**MySQL数据库连接失败**

```
sqlalchemy.exc.OperationalError: (pymysql.err.OperationalError) (1045, "Access denied for user 'root'@'localhost' (using password: YES)")
```

这意味着：
1. ✅ MySQL服务正在运行
2. ❌ 配置的密码不正确
3. ❌ 后端无法连接数据库
4. ❌ 无法验证用户权限
5. ❌ 所有需要认证的API都返回403

---

## 解决方案

### 方案一：修改MySQL密码为配置文件中的密码（推荐）

#### 步骤 1：连接MySQL

打开命令提示符（以管理员身份运行）：

```bash
# 使用当前MySQL密码登录
mysql -u root -p
# 输入当前密码
```

#### 步骤 2：修改密码为 'root'

```sql
-- 修改root用户密码
ALTER USER 'root'@'localhost' IDENTIFIED BY 'root';

-- 刷新权限
FLUSH PRIVILEGES;

-- 退出
EXIT;
```

#### 步骤 3：验证连接

```bash
# 使用新密码测试连接
mysql -u root -proot -e "SELECT 1;"
```

如果成功，应该看到：
```
+---+
| 1 |
+---+
| 1 |
+---+
```

---

### 方案二：修改配置文件使用正确的MySQL密码

#### 步骤 1：找到MySQL的实际密码

通常MySQL密码可能是：
- 空密码（直接回车）
- `123456`
- `password`
- 安装时设置的密码

#### 步骤 2：修改 `backend/.env` 文件

```properties
# 修改这一行，使用实际的MySQL密码
MYSQL_PASSWORD=你的实际密码
```

#### 步骤 3：重启后端服务

关闭当前后端服务，重新启动：
```bash
cd backend
python -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

---

### 方案三：重置MySQL root密码（如果忘记密码）

#### Windows系统：

1. **停止MySQL服务**
```bash
net stop MySQL80
```

2. **以安全模式启动MySQL**
```bash
mysqld --console --skip-grant-tables --shared-memory
```

3. **打开新的命令提示符，连接MySQL**
```bash
mysql -u root
```

4. **重置密码**
```sql
USE mysql;
UPDATE user SET authentication_string='' WHERE User='root';
FLUSH PRIVILEGES;
ALTER USER 'root'@'localhost' IDENTIFIED BY 'root';
FLUSH PRIVILEGES;
EXIT;
```

5. **关闭安全模式的MySQL，正常启动服务**
```bash
net start MySQL80
```

---

## 验证修复

### 1. 测试MySQL连接

```bash
mysql -u root -proot -e "SHOW DATABASES;"
```

应该能看到数据库列表，包括 `teaching_office_evaluation`

### 2. 测试后端API

访问：http://localhost:8000/docs

应该能看到API文档页面

### 3. 测试登录

```bash
curl -X POST "http://localhost:8000/api/auth/login" \
  -H "Content-Type: application/json" \
  -d "{\"username\":\"director1\",\"password\":\"password123\"}"
```

应该返回token

### 4. 测试前端

1. 访问 http://localhost:3000
2. 使用 `director1` / `password123` 登录
3. 应该能正常进入教研室端主页
4. 不再出现403错误

---

## 快速修复命令（推荐）

如果你能访问MySQL，执行以下命令：

```bash
# 1. 修改MySQL密码
mysql -u root -p -e "ALTER USER 'root'@'localhost' IDENTIFIED BY 'root'; FLUSH PRIVILEGES;"

# 2. 验证连接
mysql -u root -proot -e "SELECT 1;"

# 3. 重启后端服务（在后端服务窗口按Ctrl+C，然后执行）
cd backend
python -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

---

## 常见问题

### Q1: 我不知道MySQL的当前密码
**解决方法**：使用方案三重置密码

### Q2: 修改密码后还是连接失败
**检查项**：
1. 确认MySQL服务正在运行：`net start MySQL80`
2. 确认端口3306没有被占用：`netstat -ano | findstr :3306`
3. 检查防火墙设置
4. 查看MySQL错误日志

### Q3: 后端启动时没有报错，但前端还是403
**可能原因**：
1. 后端缓存了旧的数据库连接
2. 需要完全重启后端服务
3. 清除浏览器缓存和localStorage

**解决方法**：
```bash
# 完全停止后端
taskkill /F /IM python.exe

# 清除Python缓存
cd backend
rmdir /s /q __pycache__
rmdir /s /q app\__pycache__

# 重新启动
python -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

---

## 总结

403错误的根本原因是MySQL数据库连接失败。修复步骤：

1. ✅ 确认MySQL服务运行中
2. ✅ 修改MySQL密码为 'root' 或修改配置文件
3. ✅ 重启后端服务
4. ✅ 测试前端功能

修复后，教研室端应该能正常使用，不再出现403错误。
