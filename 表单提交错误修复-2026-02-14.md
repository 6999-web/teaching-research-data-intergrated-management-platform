# 表单提交错误修复

## 修复时间
2026-02-14

## 问题描述
教研室端无法提交表单，浏览器控制台显示错误：
```
Failed to submit self-evaluation: TypeError: ElMessage.loading is not a function
```

## 错误原因
在 `TeachingOfficeHome.vue` 的 `handleSubmit` 函数中，错误地使用了 `ElMessage.loading()` 方法。

Element Plus 的 `ElMessage` 组件没有 `loading()` 方法，应该使用标准的调用方式：
```typescript
ElMessage({
  message: '加载中...',
  type: 'info',
  duration: 0,
  showClose: false
})
```

## 修复方案

### 修改前（错误代码）
```typescript
const handleSubmit = async (submitData: any) => {
  try {
    // ❌ 错误：ElMessage.loading() 不存在
    ElMessage.loading('正在提交自评表，请稍候...')
    
    // ... 其他代码
    
    ElMessage.closeAll()
    ElMessage.loading('正在上传附件，请稍候...')
    
    // ... 其他代码
  } catch (error) {
    ElMessage.closeAll()
    // ...
  }
}
```

### 修改后（正确代码）
```typescript
const handleSubmit = async (submitData: any) => {
  let loadingMessage: any = null
  
  try {
    // ✅ 正确：使用标准的 ElMessage 调用方式
    loadingMessage = ElMessage({
      message: '正在提交自评表，请稍候...',
      type: 'info',
      duration: 0,
      showClose: false
    })
    
    // ... 其他代码
    
    // 关闭之前的消息
    if (loadingMessage) loadingMessage.close()
    
    // 显示新的加载消息
    loadingMessage = ElMessage({
      message: '正在上传附件，请稍候...',
      type: 'info',
      duration: 0,
      showClose: false
    })
    
    // ... 其他代码
    
    // 成功后关闭加载消息
    if (loadingMessage) loadingMessage.close()
    ElMessage.success('提交成功！')
    
  } catch (error) {
    // 错误时也要关闭加载消息
    if (loadingMessage) loadingMessage.close()
    ElMessage.error('提交失败')
  }
}
```

## 关键改进

### 1. 正确的消息显示方式
```typescript
// 创建一个持久的加载消息
const loadingMessage = ElMessage({
  message: '加载中...',
  type: 'info',
  duration: 0,        // 0 表示不自动关闭
  showClose: false    // 不显示关闭按钮
})

// 手动关闭消息
loadingMessage.close()
```

### 2. 消息管理
- 使用变量 `loadingMessage` 保存消息实例
- 在显示新消息前关闭旧消息
- 在成功或失败时都要关闭加载消息
- 避免使用 `ElMessage.closeAll()`，因为可能关闭其他重要消息

### 3. 错误处理
```typescript
try {
  // 显示加载消息
  loadingMessage = ElMessage({ ... })
  
  // 执行操作
  await someAsyncOperation()
  
  // 关闭加载消息
  if (loadingMessage) loadingMessage.close()
  
  // 显示成功消息
  ElMessage.success('操作成功')
  
} catch (error) {
  // 确保关闭加载消息
  if (loadingMessage) loadingMessage.close()
  
  // 显示错误消息
  ElMessage.error('操作失败')
}
```

## 完整的提交流程

### 步骤1：保存自评表
```typescript
loadingMessage = ElMessage({
  message: '正在提交自评表，请稍候...',
  type: 'info',
  duration: 0,
  showClose: false
})

const saveResponse = await selfEvaluationApi.save({
  teaching_office_id: authStore.teachingOfficeId,
  evaluation_year: new Date().getFullYear(),
  content: formData
})
```

### 步骤2：上传附件（如果有）
```typescript
if (attachments && attachments.length > 0) {
  if (loadingMessage) loadingMessage.close()
  
  loadingMessage = ElMessage({
    message: '正在上传附件，请稍候...',
    type: 'info',
    duration: 0,
    showClose: false
  })
  
  await uploadAttachments(evaluationId)
}
```

### 步骤3：提交并锁定
```typescript
if (loadingMessage) loadingMessage.close()

loadingMessage = ElMessage({
  message: '正在提交到考评小组，请稍候...',
  type: 'info',
  duration: 0,
  showClose: false
})

await selfEvaluationApi.submit(evaluationId)
```

### 步骤4：触发AI评分
```typescript
try {
  await selfEvaluationApi.triggerAIScoring(evaluationId)
} catch (aiError) {
  console.warn('AI评分触发失败，但不影响提交:', aiError)
}
```

### 步骤5：显示成功消息
```typescript
if (loadingMessage) loadingMessage.close()
ElMessage.success('提交成功！数据已上传到考评小组端')
```

## 测试验证

### 测试步骤
1. 访问 http://localhost:3000
2. 登录账号：office1 / password123
3. 点击"填写自评表"
4. 填写所有必填项
5. 点击"提交表单"按钮
6. 观察提交过程

### 预期结果
- ✅ 显示"正在提交自评表，请稍候..."
- ✅ 显示"正在上传附件，请稍候..."（如果有附件）
- ✅ 显示"正在提交到考评小组，请稍候..."
- ✅ 显示"提交成功！数据已上传到考评小组端"
- ✅ 没有控制台错误

### 错误处理测试
- ✅ 401错误：显示"请先登录后再提交"并跳转登录页
- ✅ 403错误：显示"没有权限执行此操作"
- ✅ 其他错误：显示详细错误信息

## Element Plus 消息组件使用指南

### 基本用法
```typescript
// 简单消息
ElMessage('这是一条消息')

// 带类型的消息
ElMessage.success('成功')
ElMessage.warning('警告')
ElMessage.error('错误')
ElMessage.info('信息')

// 完整配置
ElMessage({
  message: '消息内容',
  type: 'success',
  duration: 3000,      // 显示时间（毫秒）
  showClose: true,     // 显示关闭按钮
  center: false,       // 文字居中
  offset: 20,          // 距离顶部的偏移量
  grouping: false,     // 合并相同内容的消息
  onClose: () => {}    // 关闭时的回调
})
```

### 持久消息（不自动关闭）
```typescript
const message = ElMessage({
  message: '加载中...',
  type: 'info',
  duration: 0,         // 设置为 0 表示不自动关闭
  showClose: false
})

// 手动关闭
message.close()
```

### 关闭所有消息
```typescript
// 不推荐使用，可能关闭其他重要消息
ElMessage.closeAll()

// 推荐：手动管理消息实例
if (loadingMessage) {
  loadingMessage.close()
}
```

## 修改的文件
- `frontend/src/views/TeachingOfficeHome.vue`

## 相关文档
- [Element Plus Message 组件文档](https://element-plus.org/zh-CN/component/message.html)
- `教研室端界面更新说明.md`
- `表单提交和附件上传修复完成.md`

## 总结
本次修复解决了 `ElMessage.loading is not a function` 错误，使用正确的 Element Plus 消息组件调用方式。现在表单可以正常提交，并且有清晰的加载提示和错误处理。
