# 完整问题诊断和修复指南

## 当前问题

从浏览器控制台看到的错误：
```
POST http://localhost:3000/api/teaching-office/self-evaluation 403 (Forbidden)
Failed to create draft evaluation
```

## 根本原因

**MySQL数据库连接失败** → 后端无法访问数据库 → 无法验证用户 → 返回403错误

---

## 立即修复（推荐方案）

### 方案A：自动测试和修复

运行自动化脚本：

```bash
# 以管理员身份运行命令提示符，然后执行：
test_mysql_password.bat
```

这个脚本会：
1. 自动测试常见密码
2. 如果找到正确密码，自动修改为 'root'
3. 验证修改结果

### 方案B：手动修复（如果方案A失败）

#### 步骤1：找到MySQL密码

尝试以下密码连接MySQL：

```bash
# 尝试密码 'root'
mysql -u root -proot -e "SELECT 1;"

# 尝试空密码
mysql -u root -e "SELECT 1;"

# 尝试密码 '123456'
mysql -u root -p123456 -e "SELECT 1;"

# 手动输入密码
mysql -u root -p
```

#### 步骤2：修改密码为 'root'

找到正确密码后，执行：

```bash
# 连接MySQL（使用正确的密码）
mysql -u root -p

# 在MySQL命令行中执行：
ALTER USER 'root'@'localhost' IDENTIFIED BY 'root';
FLUSH PRIVILEGES;
EXIT;
```

#### 步骤3：验证新密码

```bash
mysql -u root -proot -e "SELECT 1;"
```

应该看到：
```
+---+
| 1 |
+---+
| 1 |
+---+
```

#### 步骤4：检查数据库

```bash
mysql -u root -proot -e "SHOW DATABASES;"
```

确认 `teaching_office_evaluation` 数据库存在。

如果不存在，创建它：

```bash
mysql -u root -proot -e "CREATE DATABASE teaching_office_evaluation CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"
```

#### 步骤5：初始化数据库

```bash
cd backend

# 运行数据库迁移
alembic upgrade head

# 初始化测试数据（如果需要）
python -c "from app.db.init_db import init_db; init_db()"
```

#### 步骤6：重启后端服务

1. 找到运行后端的命令行窗口
2. 按 `Ctrl + C` 停止服务
3. 重新启动：
   ```bash
   python -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
   ```

4. 查看启动日志，确认没有数据库连接错误

---

## 验证修复

### 1. 测试后端连接

```bash
python test_backend_connection.py
```

应该看到：
```
✅ 后端服务正常运行
✅ MySQL连接成功
✅ 登录成功
✅ 所有测试通过
```

### 2. 测试前端

1. 打开浏览器，访问 http://localhost:3000
2. 清除浏览器缓存：
   - 按 `F12` 打开开发者工具
   - 右键点击刷新按钮
   - 选择"清空缓存并硬性重新加载"
3. 使用 `director1` / `password123` 登录
4. 进入"填写自评表"页面
5. 不应该再看到403错误

---

## 如果还是不行

### 检查清单

- [ ] MySQL服务正在运行
  ```bash
  net start MySQL80
  ```

- [ ] MySQL密码已修改为 'root'
  ```bash
  mysql -u root -proot -e "SELECT 1;"
  ```

- [ ] 数据库存在
  ```bash
  mysql -u root -proot -e "SHOW DATABASES LIKE 'teaching_office_evaluation';"
  ```

- [ ] 后端配置正确
  检查 `backend/.env` 文件：
  ```properties
  MYSQL_PASSWORD=root
  ```

- [ ] 后端服务已重启
  完全停止并重新启动后端服务

- [ ] 浏览器缓存已清除
  按 `Ctrl + Shift + Delete` 清除缓存

### 查看详细错误

1. **后端日志**
   查看后端服务的命令行窗口，看是否有错误信息

2. **浏览器控制台**
   按 `F12` 打开开发者工具，查看 Console 和 Network 标签

3. **数据库日志**
   检查MySQL错误日志（通常在MySQL安装目录的 `data` 文件夹）

---

## 常见问题

### Q1: 忘记MySQL密码怎么办？

参考 "快速修复403错误.md" 中的"重置密码"部分。

### Q2: 修改密码后还是连接失败

可能原因：
1. 后端服务没有重启
2. 配置文件没有保存
3. MySQL服务需要重启

解决方法：
```bash
# 重启MySQL服务
net stop MySQL80
net start MySQL80

# 重启后端服务
# 在后端服务窗口按 Ctrl+C，然后重新运行
```

### Q3: 数据库不存在

```bash
# 创建数据库
mysql -u root -proot -e "CREATE DATABASE teaching_office_evaluation CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"

# 运行迁移
cd backend
alembic upgrade head
```

### Q4: 前端还是显示403错误

1. 清除浏览器所有数据：
   - 按 `F12`
   - 进入 Application 标签
   - 清除 Local Storage
   - 清除 Session Storage
   - 清除 Cookies

2. 完全关闭浏览器，重新打开

3. 重新登录

---

## 技术支持

如果以上方法都无法解决问题，请提供以下信息：

1. **MySQL版本**
   ```bash
   mysql --version
   ```

2. **后端启动日志**
   复制后端服务窗口的完整输出

3. **浏览器错误信息**
   - 打开开发者工具（F12）
   - 切换到 Network 标签
   - 重现错误
   - 右键点击失败的请求 → Copy → Copy as cURL

4. **测试脚本输出**
   ```bash
   python test_backend_connection.py > test_output.txt
   ```
   提供 `test_output.txt` 文件内容

---

## 总结

403错误的修复流程：

1. ✅ 修复MySQL密码
2. ✅ 验证数据库连接
3. ✅ 重启后端服务
4. ✅ 清除浏览器缓存
5. ✅ 重新登录测试

完成这些步骤后，系统应该能正常工作。
