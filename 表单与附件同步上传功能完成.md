# 表单与附件同步上传功能完成说明

## 完成时间
2026年2月14日

## 功能概述
成功实现了教研室自评表填写与附件上传同步进行的功能。用户现在可以一边填写考评表，一边上传相关附件，提交时自动完成表单保存和附件上传。

## 实现的功能

### 1. 表单内嵌附件上传区域
- 在自评表单底部（评分汇总之后）添加了附件上传区域
- 用户可以在填写表单的同时选择和上传附件
- 附件上传是可选的，不影响表单提交

### 2. 考核指标选择
- 支持7种考核指标：
  - 教学改革项目
  - 荣誉表彰
  - 课程建设
  - 教学质量
  - 学生指导
  - 科研工作
  - 团队建设
- 每个指标支持不同的文件格式
- 选择指标后自动显示支持的文件类型

### 3. 文件上传功能
- 支持拖拽上传和点击选择
- 支持多文件上传（最多10个）
- 单个文件最大50MB
- 自动验证文件格式
- 实时显示已选择的文件列表

### 4. 已选文件管理
- 显示文件名、大小、对应的考核指标
- 支持删除已选择的文件
- 文件大小自动格式化显示（B/KB/MB/GB）

### 5. 智能提交按钮
- 未选择附件时：显示"提交表单"
- 已选择附件时：显示"提交表单并上传附件"
- 提交中显示加载状态
- 已提交后按钮禁用

### 6. 自动化提交流程
提交时自动执行以下步骤：
1. 验证表单数据
2. 保存自评表到数据库
3. 如果有附件，自动上传所有附件
4. 提交表单并锁定
5. 自动触发AI评分
6. 跳转到教研室主页

## 技术实现

### 修改的文件
- `frontend/src/components/NewSelfEvaluationForm.vue`

### 新增的功能模块

#### 1. 导入依赖
```typescript
import { UploadInstance, UploadUserFile } from 'element-plus'
import type { IndicatorType } from '@/types/attachment'
import { INDICATORS } from '@/types/attachment'
```

#### 2. 状态管理
```typescript
// 上传组件引用
const uploadRef = ref<UploadInstance>()

// 附件表单数据
const attachmentForm = reactive({
  indicator: '' as IndicatorType | ''
})

// 附件状态
const attachmentFileList = ref<UploadUserFile[]>([])
const isSubmitting = ref(false)

// 考核指标列表
const attachmentIndicators = INDICATORS
```

#### 3. 计算属性
```typescript
// 当前指标支持的文件类型
const currentIndicatorFileTypes = computed(() => {
  if (!attachmentForm.indicator) return ''
  const indicator = attachmentIndicators.find(i => i.key === attachmentForm.indicator)
  return indicator ? indicator.fileTypes.join(', ') : ''
})

// 接受的文件类型（用于el-upload的accept属性）
const acceptedFileTypes = computed(() => {
  if (!attachmentForm.indicator) return ''
  const indicator = attachmentIndicators.find(i => i.key === attachmentForm.indicator)
  if (!indicator) return ''
  return indicator.fileTypes.map(type => `.${type}`).join(',')
})
```

#### 4. 核心方法

##### 指标变更处理
```typescript
const handleIndicatorChange = () => {
  // 切换指标时清空文件列表
  attachmentFileList.value = []
  uploadRef.value?.clearFiles()
}
```

##### 文件选择处理
```typescript
const handleFileChange = (file: UploadUserFile, fileList: UploadUserFile[]) => {
  // 将指标信息附加到文件元数据
  if (attachmentForm.indicator) {
    (file as any).indicator = attachmentForm.indicator
  }
  attachmentFileList.value = fileList
}
```

##### 文件上传到后端
```typescript
const uploadAttachments = async (evaluationId: string): Promise<boolean> => {
  if (attachmentFileList.value.length === 0) {
    return true // 没有文件需要上传
  }

  try {
    let successCount = 0
    let failCount = 0

    // 逐个上传文件
    for (const file of attachmentFileList.value) {
      const indicator = (file as any).indicator || attachmentForm.indicator
      
      // 创建FormData
      const formData = new FormData()
      formData.append('evaluation_id', evaluationId)
      formData.append('indicator', indicator)
      formData.append('files', file.raw as File)

      // 获取token
      const token = localStorage.getItem('token')

      // 上传文件
      const baseURL = import.meta.env.VITE_API_BASE_URL || '/api'
      const response = await fetch(`${baseURL}/teaching-office/attachments`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`
        },
        body: formData
      })

      if (response.ok) {
        successCount++
      } else {
        failCount++
      }
    }

    if (failCount > 0) {
      ElMessage.warning(`${successCount} 个文件上传成功，${failCount} 个文件上传失败`)
      return false
    } else {
      ElMessage.success(`${successCount} 个附件上传成功`)
      return true
    }
  } catch (error) {
    console.error('Upload attachments error:', error)
    ElMessage.error('附件上传失败')
    return false
  }
}
```

##### 表单提交处理
```typescript
const handleSubmit = async () => {
  if (!formRef.value) return
  
  try {
    // 验证表单
    await formRef.value.validate()
    
    // 标记为提交中
    isSubmitting.value = true
    
    // 触发提交事件，传递表单数据和附件上传函数
    emit('submit', {
      formData: { ...formData },
      attachments: attachmentFileList.value,
      uploadAttachments
    })
    
    // 标记为已提交
    isSubmitted.value = true
    
  } catch (error: any) {
    console.error('Submit failed:', error)
    ElMessage.error('请填写所有必填项')
    isSubmitting.value = false
  }
}
```

### 父组件处理（SelfEvaluation.vue）
父组件已经实现了完整的提交流程：

```typescript
const handleSubmit = async (submitData: any) => {
  try {
    // 提取表单数据和附件上传函数
    const { formData, attachments, uploadAttachments } = submitData
    
    // 步骤1: 保存自评表
    const saveResponse = await selfEvaluationApi.save({
      teaching_office_id: teachingOfficeId.value,
      evaluation_year: evaluationYear.value,
      content: formData
    })
    const evaluationId = saveResponse.data.evaluation_id

    // 步骤2: 上传附件（如果有）
    if (attachments && attachments.length > 0) {
      await uploadAttachments(evaluationId)
    }

    // 步骤3: 提交并锁定
    await selfEvaluationApi.submit(evaluationId)

    // 步骤4: 自动触发AI评分
    await selfEvaluationApi.triggerAIScoring(evaluationId)

    // 提交成功，跳转到主页
    ElMessage.success('提交成功！数据已上传到考评小组端')
    router.push('/teaching-office-home')

  } catch (error: any) {
    ElMessage.error('提交失败，请检查网络连接或联系管理员')
  }
}
```

## 用户体验优化

### 1. 友好的提示信息
- 选择指标前提示"请先选择考核指标"
- 显示当前指标支持的文件格式
- 显示文件大小和数量限制
- 已选择文件时显示绿色提示

### 2. 实时反馈
- 文件选择后立即显示在列表中
- 显示文件大小、考核指标等信息
- 支持删除已选择的文件
- 提交按钮文字根据是否有附件动态变化

### 3. 错误处理
- 文件格式不支持时提示
- 文件大小超限时提示
- 文件数量超限时提示
- 上传失败时显示详细信息

### 4. 加载状态
- 提交时显示加载动画
- 按钮禁用防止重复提交
- 已提交后按钮显示"已提交"

## 样式设计

### 附件上传区域样式
```css
.attachment-card {
  margin: 20px 0;
  background-color: #f9f9f9;
  border: 1px solid #e4e7ed;
}

.upload-component {
  width: 100%;
}

.selected-files {
  margin-top: 20px;
  padding: 15px;
  background-color: #ffffff;
  border-radius: 4px;
  border: 1px solid #e4e7ed;
}
```

## 测试建议

### 1. 基本功能测试
- [ ] 填写表单时可以选择考核指标
- [ ] 选择指标后可以上传文件
- [ ] 支持拖拽上传
- [ ] 支持多文件上传
- [ ] 文件列表正确显示

### 2. 验证测试
- [ ] 文件格式验证正确
- [ ] 文件大小限制生效
- [ ] 文件数量限制生效
- [ ] 切换指标时清空文件列表

### 3. 提交流程测试
- [ ] 只填表单不上传附件可以提交
- [ ] 填表单并上传附件可以提交
- [ ] 附件上传成功后正确保存
- [ ] 提交后正确跳转到主页

### 4. 错误处理测试
- [ ] 网络错误时正确提示
- [ ] 上传失败时正确提示
- [ ] 部分文件上传失败时正确提示

## 使用说明

### 用户操作流程
1. 填写自评表各项内容
2. （可选）在"附件上传"区域选择考核指标
3. （可选）拖拽或点击上传相关附件
4. 查看已选择的文件列表
5. 点击"提交表单"或"提交表单并上传附件"按钮
6. 系统自动完成保存、上传、提交、AI评分
7. 自动跳转到教研室主页

### 注意事项
- 附件上传是可选的，不影响表单提交
- 每个文件需要关联一个考核指标
- 单个文件不超过50MB
- 最多上传10个文件
- 提交后无法修改，请仔细检查

## 技术亮点

1. **无缝集成**：附件上传完全集成在表单中，无需跳转页面
2. **智能验证**：根据考核指标自动验证文件格式
3. **批量上传**：支持一次性上传多个文件
4. **错误恢复**：附件上传失败不影响表单保存
5. **用户友好**：实时反馈、清晰提示、流畅体验

## 后续优化建议

1. 添加上传进度条显示
2. 支持附件预览功能
3. 支持附件下载功能
4. 添加附件压缩功能
5. 支持断点续传

## 总结

本次更新成功实现了表单填写与附件上传同步进行的功能，大大提升了用户体验。用户不再需要分两步操作，可以在填写表单的同时准备和上传附件，一键完成所有操作。系统会自动处理表单保存、附件上传、提交锁定和AI评分等流程，确保数据完整性和操作便捷性。
