# 提交和上传问题修复指南

## 问题诊断

根据截图，发现两个问题：

### 问题1: 填写考评表提交失败
**错误信息**: `TeachingOfficeHome is not a function`

**原因分析**:
- 这个错误通常是由于组件导入或使用方式不正确导致的
- 可能是浏览器缓存问题

### 问题2: 材料提交上传失败  
**错误信息**: `401 Unauthorized`

**原因分析**:
- 用户未登录或token已过期
- 附件上传API路径配置问题

## 修复步骤

### 步骤1: 清除浏览器缓存并重新登录

1. **清除浏览器缓存**:
   ```
   按 Ctrl + Shift + Delete
   选择"缓存的图片和文件"
   点击"清除数据"
   ```

2. **强制刷新页面**:
   ```
   按 Ctrl + Shift + R
   ```

3. **重新登录**:
   - 访问: http://localhost:3000/login
   - 使用账号: `test_teaching_office` / `password123`

### 步骤2: 验证登录状态

打开浏览器开发者工具（F12），在Console中执行：

```javascript
// 检查token是否存在
console.log('Token:', localStorage.getItem('token'))

// 检查用户信息
console.log('User:', localStorage.getItem('user'))
```

**预期结果**:
- Token应该是一个长字符串
- User应该包含用户信息

**如果token为null**:
- 说明未登录或登录失败
- 需要重新登录

### 步骤3: 测试提交功能

1. **填写表单**:
   - 填写所有必填项（常规教学工作的8个指标）
   - 每个指标至少输入10个字符
   - 设置自评分

2. **点击提交**:
   - 点击"提交表单"按钮
   - 观察浏览器控制台的输出

3. **检查错误**:
   - 如果出现错误，查看Network标签
   - 找到失败的请求，查看详细信息

### 步骤4: 测试附件上传

1. **选择考核指标**:
   - 在"材料提交"页面
   - 先选择一个考核指标

2. **上传文件**:
   - 拖拽文件或点击上传
   - 支持的格式: pdf, doc, docx, ppt, pptx

3. **检查上传状态**:
   - 查看上传进度
   - 如果失败，查看错误信息

## 常见问题解决

### Q1: 提交时显示"请填写所有必填项"

**解决方案**:
- 确保所有8个常规教学工作指标都已填写
- 每个指标的内容至少10个字符
- 每个指标都设置了自评分

### Q2: 提交时显示"请先登录后再提交"

**解决方案**:
1. 退出登录
2. 清除浏览器缓存
3. 重新登录
4. 再次尝试提交

### Q3: 附件上传显示401错误

**解决方案**:
1. 检查是否已登录
2. 检查token是否有效:
   ```javascript
   // 在浏览器控制台执行
   fetch('/api/teaching-office/self-evaluation', {
     headers: {
       'Authorization': 'Bearer ' + localStorage.getItem('token')
     }
   }).then(r => console.log('Status:', r.status))
   ```
3. 如果返回401，需要重新登录

### Q4: 上传文件格式不支持

**解决方案**:
- 检查文件格式是否在支持列表中
- 不同的考核指标支持不同的文件格式
- 证书类: pdf, jpg, jpeg, png
- 项目类: pdf, doc, docx, ppt, pptx

## 修复后的改进

### 改进1: 附件上传URL修复

**修改文件**: `frontend/src/components/AttachmentUpload.vue`

**修改内容**:
```typescript
// 修改前
const uploadAction = computed(() => {
  return `/api/teaching-office/attachments`
})

// 修改后
const uploadAction = computed(() => {
  const baseURL = import.meta.env.VITE_API_BASE_URL || '/api'
  return `${baseURL}/teaching-office/attachments`
})
```

**说明**: 使用环境变量配置的API基础URL，确保在不同环境下都能正确访问

## 测试清单

### 提交功能测试

- [ ] 清除浏览器缓存
- [ ] 重新登录系统
- [ ] 填写所有必填项
- [ ] 点击"提交表单"
- [ ] 验证提交成功消息
- [ ] 检查考评小组端是否能看到提交的表单

### 附件上传测试

- [ ] 登录系统
- [ ] 访问"材料提交"页面
- [ ] 选择考核指标
- [ ] 上传测试文件
- [ ] 验证上传成功
- [ ] 检查已上传文件列表

## 调试技巧

### 1. 查看网络请求

打开开发者工具（F12） → Network标签：

- 查看所有API请求
- 检查请求状态码
- 查看请求头中的Authorization
- 查看响应内容

### 2. 查看控制台日志

打开开发者工具（F12） → Console标签：

- 查看错误信息
- 查看警告信息
- 执行调试命令

### 3. 检查本地存储

打开开发者工具（F12） → Application标签 → Local Storage：

- 检查token是否存在
- 检查token是否有效
- 检查用户信息

## 后端API检查

### 检查后端服务状态

```bash
# 检查后端是否运行
netstat -ano | findstr :8000

# 访问API文档
http://localhost:8000/docs
```

### 测试API端点

使用Postman或curl测试：

```bash
# 1. 登录获取token
curl -X POST http://localhost:8000/api/auth/login \
  -H "Content-Type: application/json" \
  -d "{\"username\":\"test_teaching_office\",\"password\":\"password123\",\"role\":\"teaching_office\"}"

# 2. 使用token测试提交
curl -X POST http://localhost:8000/api/teaching-office/self-evaluation \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN_HERE" \
  -d "{\"teaching_office_id\":\"teaching-office-001\",\"evaluation_year\":2026,\"content\":{}}"
```

## 预期结果

### 提交成功

1. 显示"正在提交自评表，请稍候..."
2. 显示"提交成功！数据已上传到考评小组端"
3. 表单状态变为"已提交"
4. 提交按钮变为禁用状态

### 上传成功

1. 显示上传进度条
2. 进度达到100%
3. 显示"文件 xxx 上传成功"
4. 文件出现在"已上传附件"列表中

## 需要帮助？

如果问题仍然存在，请提供以下信息：

1. **浏览器控制台截图**（F12 → Console）
2. **Network标签截图**（F12 → Network，显示失败的请求）
3. **Local Storage截图**（F12 → Application → Local Storage）
4. **具体的错误信息**（完整的错误堆栈）

---

**最后更新**: 2026-02-13
**版本**: 1.0.0
