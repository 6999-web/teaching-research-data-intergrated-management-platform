# 教研室数据管理平台 - 腾讯云部署指南

## 📋 服务器信息

- **公网IP**: 101.33.211.98
- **操作系统**: Linux (推荐 Ubuntu 20.04/22.04 或 CentOS 7/8)
- **访问地址**: http://101.33.211.98

---

## 🚀 快速部署

### 前置要求

确保服务器已安装以下软件：

```bash
# 更新系统
sudo apt update && sudo apt upgrade -y  # Ubuntu/Debian
# 或
sudo yum update -y  # CentOS

# 安装必要软件
sudo apt install -y python3 python3-pip nodejs npm nginx postgresql  # Ubuntu
# 或
sudo yum install -y python3 python3-pip nodejs npm nginx postgresql-server  # CentOS
```

---

## 📦 部署步骤

### 步骤 1: 上传项目到服务器

在本地电脑上运行：

```bash
# 压缩项目（排除node_modules等大文件）
tar -czf teaching-office-platform.tar.gz \
  --exclude='node_modules' \
  --exclude='frontend/dist' \
  --exclude='backend/__pycache__' \
  --exclude='backend/.pytest_cache' \
  --exclude='*.pyc' \
  .

# 上传到服务器
scp teaching-office-platform.tar.gz root@101.33.211.98:/root/

# 或使用rsync（推荐）
rsync -avz --exclude='node_modules' --exclude='frontend/dist' \
  --exclude='backend/__pycache__' --exclude='*.pyc' \
  . root@101.33.211.98:/root/teaching-office-platform/
```

### 步骤 2: 在服务器上解压并配置

SSH登录到服务器：

```bash
ssh root@101.33.211.98
```

解压项目：

```bash
cd /root
tar -xzf teaching-office-platform.tar.gz
cd teaching-office-platform
```

### 步骤 3: 配置数据库

#### 3.1 安装PostgreSQL（如果未安装）

```bash
# Ubuntu
sudo apt install -y postgresql postgresql-contrib

# CentOS
sudo yum install -y postgresql-server postgresql-contrib
sudo postgresql-setup initdb
```

#### 3.2 启动PostgreSQL

```bash
sudo systemctl start postgresql
sudo systemctl enable postgresql
```

#### 3.3 创建数据库和用户

```bash
sudo -u postgres psql

# 在PostgreSQL命令行中执行：
CREATE DATABASE teaching_office_evaluation;
CREATE USER teaching_office_user WITH PASSWORD 'your_secure_password';
GRANT ALL PRIVILEGES ON DATABASE teaching_office_evaluation TO teaching_office_user;
\q
```

### 步骤 4: 配置后端环境

```bash
cd backend

# 安装Python依赖
pip3 install -r requirements.txt

# 配置环境变量
cp .env.production .env

# 编辑.env文件，修改以下配置：
nano .env
```

修改以下内容：

```env
# 数据库配置
USE_SQLITE=false
POSTGRES_SERVER=localhost
POSTGRES_USER=teaching_office_user
POSTGRES_PASSWORD=your_secure_password  # 修改为实际密码
POSTGRES_DB=teaching_office_evaluation
POSTGRES_PORT=5432

# 安全配置（生成随机密钥）
SECRET_KEY=your-random-secret-key-here  # 使用 openssl rand -hex 32 生成

# DeepSeek API（如果使用AI功能）
DEEPSEEK_API_KEY=your_api_key_here
```

生成随机密钥：

```bash
openssl rand -hex 32
```

#### 4.1 运行数据库迁移

```bash
cd /root/teaching-office-platform/backend
alembic upgrade head
```

### 步骤 5: 构建前端

```bash
cd /root/teaching-office-platform/frontend

# 安装依赖
npm install

# 构建生产版本
npm run build
```

构建完成后，静态文件会生成在 `frontend/dist` 目录。

### 步骤 6: 配置后端服务（systemd）

创建systemd服务文件：

```bash
sudo nano /etc/systemd/system/teaching-office-backend.service
```

添加以下内容：

```ini
[Unit]
Description=Teaching Office Evaluation Backend
After=network.target postgresql.service

[Service]
Type=simple
User=root
WorkingDirectory=/root/teaching-office-platform/backend
Environment="PATH=/usr/local/bin:/usr/bin:/bin"
ExecStart=/usr/bin/python3 -m uvicorn app.main:app --host 0.0.0.0 --port 8000
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

启动服务：

```bash
# 重新加载systemd配置
sudo systemctl daemon-reload

# 启动后端服务
sudo systemctl start teaching-office-backend

# 设置开机自启
sudo systemctl enable teaching-office-backend

# 查看服务状态
sudo systemctl status teaching-office-backend

# 查看日志
sudo journalctl -u teaching-office-backend -f
```

### 步骤 7: 配置Nginx

创建Nginx配置文件：

```bash
sudo nano /etc/nginx/sites-available/teaching-office
```

添加以下内容：

```nginx
server {
    listen 80;
    server_name 101.33.211.98;

    # 前端静态文件
    location / {
        root /root/teaching-office-platform/frontend/dist;
        try_files $uri $uri/ /index.html;
        index index.html;
    }

    # 后端API代理
    location /api {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket支持
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # API文档
    location /docs {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # 静态资源缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        root /root/teaching-office-platform/frontend/dist;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # 文件上传大小限制
    client_max_body_size 100M;
}
```

启用站点并重启Nginx：

```bash
# 创建软链接
sudo ln -s /etc/nginx/sites-available/teaching-office /etc/nginx/sites-enabled/

# 删除默认站点（可选）
sudo rm /etc/nginx/sites-enabled/default

# 测试Nginx配置
sudo nginx -t

# 重启Nginx
sudo systemctl restart nginx

# 设置开机自启
sudo systemctl enable nginx
```

### 步骤 8: 配置防火墙

```bash
# Ubuntu (ufw)
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw allow 8000/tcp
sudo ufw enable

# CentOS (firewalld)
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --permanent --add-port=8000/tcp
sudo firewall-cmd --reload
```

### 步骤 9: 验证部署

```bash
# 检查后端服务
curl http://127.0.0.1:8000/api/health

# 检查Nginx
curl http://101.33.211.98

# 查看服务状态
sudo systemctl status teaching-office-backend
sudo systemctl status nginx
```

---

## 🌐 访问系统

部署完成后，通过以下地址访问：

- **前端平台**: http://101.33.211.98
- **API文档**: http://101.33.211.98/docs
- **健康检查**: http://101.33.211.98/api/health

---

## 🔧 常用管理命令

### 后端服务管理

```bash
# 启动服务
sudo systemctl start teaching-office-backend

# 停止服务
sudo systemctl stop teaching-office-backend

# 重启服务
sudo systemctl restart teaching-office-backend

# 查看状态
sudo systemctl status teaching-office-backend

# 查看日志
sudo journalctl -u teaching-office-backend -f

# 查看最近100行日志
sudo journalctl -u teaching-office-backend -n 100
```

### Nginx管理

```bash
# 测试配置
sudo nginx -t

# 重启Nginx
sudo systemctl restart nginx

# 重新加载配置（不中断服务）
sudo systemctl reload nginx

# 查看错误日志
sudo tail -f /var/log/nginx/error.log

# 查看访问日志
sudo tail -f /var/log/nginx/access.log
```

### 数据库管理

```bash
# 连接数据库
sudo -u postgres psql teaching_office_evaluation

# 备份数据库
sudo -u postgres pg_dump teaching_office_evaluation > backup.sql

# 恢复数据库
sudo -u postgres psql teaching_office_evaluation < backup.sql
```

---

## 🔄 更新部署

当代码更新后，执行以下步骤：

```bash
# 1. 上传新代码到服务器
rsync -avz --exclude='node_modules' --exclude='frontend/dist' \
  . root@101.33.211.98:/root/teaching-office-platform/

# 2. SSH登录服务器
ssh root@101.33.211.98

# 3. 更新后端
cd /root/teaching-office-platform/backend
pip3 install -r requirements.txt
alembic upgrade head
sudo systemctl restart teaching-office-backend

# 4. 更新前端
cd /root/teaching-office-platform/frontend
npm install
npm run build
sudo systemctl reload nginx
```

---

## 🐛 故障排查

### 问题 1: 后端服务无法启动

```bash
# 查看详细日志
sudo journalctl -u teaching-office-backend -n 100

# 检查端口占用
sudo netstat -tlnp | grep 8000

# 手动启动测试
cd /root/teaching-office-platform/backend
python3 -m uvicorn app.main:app --host 0.0.0.0 --port 8000
```

### 问题 2: 前端无法访问

```bash
# 检查Nginx状态
sudo systemctl status nginx

# 检查Nginx错误日志
sudo tail -f /var/log/nginx/error.log

# 检查前端文件是否存在
ls -la /root/teaching-office-platform/frontend/dist
```

### 问题 3: API请求失败

```bash
# 检查CORS配置
# 编辑 backend/app/core/config.py
# 确保 BACKEND_CORS_ORIGINS 包含正确的域名

# 检查后端日志
sudo journalctl -u teaching-office-backend -f
```

### 问题 4: 数据库连接失败

```bash
# 检查PostgreSQL状态
sudo systemctl status postgresql

# 检查数据库连接
sudo -u postgres psql -c "SELECT version();"

# 检查.env配置
cat /root/teaching-office-platform/backend/.env
```

---

## 🔒 安全建议

1. **修改默认密码**: 确保数据库密码、SECRET_KEY等都使用强密码
2. **配置HTTPS**: 使用Let's Encrypt配置SSL证书
3. **限制SSH访问**: 修改SSH端口，禁用root密码登录
4. **配置防火墙**: 只开放必要的端口
5. **定期备份**: 设置自动备份数据库和重要文件
6. **更新系统**: 定期更新系统和软件包

### 配置HTTPS（可选但推荐）

```bash
# 安装Certbot
sudo apt install -y certbot python3-certbot-nginx  # Ubuntu

# 获取SSL证书（需要域名）
sudo certbot --nginx -d yourdomain.com

# 自动续期
sudo certbot renew --dry-run
```

---

## 📊 监控和日志

### 设置日志轮转

创建日志轮转配置：

```bash
sudo nano /etc/logrotate.d/teaching-office
```

添加内容：

```
/var/log/teaching-office/*.log {
    daily
    rotate 14
    compress
    delaycompress
    notifempty
    create 0640 root root
    sharedscripts
}
```

### 监控脚本

创建简单的监控脚本：

```bash
nano /root/monitor.sh
```

添加内容：

```bash
#!/bin/bash
# 检查服务状态
if ! systemctl is-active --quiet teaching-office-backend; then
    echo "Backend service is down, restarting..."
    systemctl restart teaching-office-backend
fi

if ! systemctl is-active --quiet nginx; then
    echo "Nginx is down, restarting..."
    systemctl restart nginx
fi
```

设置定时任务：

```bash
chmod +x /root/monitor.sh
crontab -e

# 添加以下行（每5分钟检查一次）
*/5 * * * * /root/monitor.sh >> /var/log/monitor.log 2>&1
```

---

## 📞 技术支持

如遇到问题，请检查：

1. 服务日志: `sudo journalctl -u teaching-office-backend -f`
2. Nginx日志: `sudo tail -f /var/log/nginx/error.log`
3. 系统日志: `sudo tail -f /var/log/syslog`

---

## ✅ 部署检查清单

- [ ] 服务器环境准备完成
- [ ] 项目代码已上传
- [ ] PostgreSQL已安装并配置
- [ ] 后端环境变量已配置
- [ ] 数据库迁移已完成
- [ ] 前端已构建
- [ ] 后端服务已启动
- [ ] Nginx已配置并启动
- [ ] 防火墙已配置
- [ ] 可以通过公网IP访问
- [ ] API接口正常工作
- [ ] 双模式功能正常
- [ ] 已配置自动备份
- [ ] 已配置监控脚本

---

**部署完成后访问**: http://101.33.211.98

祝部署顺利！🚀
