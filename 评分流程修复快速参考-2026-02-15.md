# è¯„åˆ†æµç¨‹ä¿®å¤ - å¿«é€Ÿå‚è€ƒ

**ä¿®å¤æ—¥æœŸ**: 2026-02-15  
**çŠ¶æ€**: âœ… å®Œæˆ  

---

## ğŸ¯ ä¿®å¤æ¦‚è§ˆ

| é—®é¢˜ | ä¿®å¤ | æ–‡ä»¶ |
|-----|------|------|
| evaluator 403 é”™è¯¯ | æ·»åŠ  evaluator åˆ°æƒé™æ£€æŸ¥ | `backend/app/api/v1/endpoints/scoring.py` |
| é”™è¯¯çš„ API è·¯å¾„ | ä¿®æ”¹å‰ç«¯ API è°ƒç”¨ | `frontend/src/components/ManualScoringForm.vue` |
| teaching_office_id ä¸ºç©ºå­—ç¬¦ä¸² | ä¿®æ”¹ç™»å½•é€»è¾‘ | `backend/app/api/v1/endpoints/auth.py` |
| æƒé‡å‡½æ•°ç¼ºå°‘ evaluator | æ·»åŠ  evaluator æƒé‡ | `backend/app/api/v1/endpoints/scoring.py` |

---

## ğŸ“ ä¿®å¤è¯¦æƒ…

### ä¿®å¤ 1: åç«¯æƒé™æ£€æŸ¥

**æ–‡ä»¶**: `backend/app/api/v1/endpoints/scoring.py`

**ä¿®æ”¹**:
```python
# ä¿®æ”¹å‰
current_user: User = Depends(require_management_roles)

# ä¿®æ”¹å
current_user: User = Depends(RoleChecker(["evaluation_team", "evaluation_office", "evaluator"]))
```

### ä¿®å¤ 2: æƒé‡å‡½æ•°

**æ–‡ä»¶**: `backend/app/api/v1/endpoints/scoring.py`

**ä¿®æ”¹**:
```python
# æ·»åŠ  evaluator æƒé‡
weights = {
    "evaluation_team": Decimal("0.70"),
    "evaluation_office": Decimal("0.50"),
    "evaluator": Decimal("0.70"),  # âœ… æ–°å¢
}
```

### ä¿®å¤ 3: ç™»å½•å“åº”

**æ–‡ä»¶**: `backend/app/api/v1/endpoints/auth.py`

**ä¿®æ”¹**:
```python
# ä»…ä¸º teaching_office è¿”å› teaching_office_id
teaching_office_id = None
if user.role == "teaching_office" and user.teaching_office_id:
    teaching_office_id = str(user.teaching_office_id)
```

### ä¿®å¤ 4: å‰ç«¯ API è·¯å¾„

**æ–‡ä»¶**: `frontend/src/components/ManualScoringForm.vue`

**ä¿®æ”¹**:
```typescript
// ä¿®æ”¹å‰
const response = await apiClient.get(`/teaching-office/attachments/${props.evaluationId}`)

// ä¿®æ”¹å
const endpoint = props.currentUserRole ? `/attachments/${props.evaluationId}` : `/teaching-office/attachments/${props.evaluationId}`
const response = await apiClient.get(endpoint)
```

---

## âœ… éªŒè¯æ¸…å•

### åç«¯éªŒè¯
- [ ] evaluator ç”¨æˆ·å¯ä»¥ç™»å½•
- [ ] evaluator ç™»å½•è¿”å› teachingOfficeId: null
- [ ] evaluator å¯ä»¥è°ƒç”¨ POST /scoring/manual-score
- [ ] evaluator å¯ä»¥è°ƒç”¨ GET /attachments/{id}
- [ ] evaluator å¯ä»¥è°ƒç”¨ GET /attachments/{id}/download

### å‰ç«¯éªŒè¯
- [ ] evaluator ç”¨æˆ·å¯ä»¥åŠ è½½è€ƒè¯„è¡¨
- [ ] evaluator ç”¨æˆ·å¯ä»¥åŠ è½½é™„ä»¶åˆ—è¡¨
- [ ] evaluator ç”¨æˆ·å¯ä»¥ä¸‹è½½é™„ä»¶
- [ ] evaluator ç”¨æˆ·å¯ä»¥æäº¤è¯„åˆ†

### æƒé™éªŒè¯
- [ ] teaching_office ä¸èƒ½è°ƒç”¨ /scoring/manual-score
- [ ] evaluator ä¸èƒ½è°ƒç”¨ /teaching-office/self-evaluation
- [ ] evaluator ä¸èƒ½è°ƒç”¨ /teaching-office/attachments

---

## ğŸš€ å¿«é€Ÿæµ‹è¯•

### 1. æµ‹è¯• evaluator ç™»å½•
```bash
curl -X POST http://localhost:8000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"evaluator1","password":"password123"}'
```

**é¢„æœŸ**: è¿”å› teachingOfficeId: null

### 2. æµ‹è¯• evaluator æäº¤è¯„åˆ†
```bash
TOKEN="<evaluator_token>"
curl -X POST http://localhost:8000/api/scoring/manual-score \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "evaluation_id": "<evaluation_id>",
    "scores": [{"indicator": "æ•™å­¦è¿‡ç¨‹ç®¡ç†", "score": 8, "comment": "test"}]
  }'
```

**é¢„æœŸ**: è¿”å› 201 Created

### 3. æµ‹è¯• evaluator åŠ è½½é™„ä»¶
```bash
TOKEN="<evaluator_token>"
curl -X GET http://localhost:8000/api/attachments/<evaluation_id> \
  -H "Authorization: Bearer $TOKEN"
```

**é¢„æœŸ**: è¿”å› 200 OKï¼Œé™„ä»¶åˆ—è¡¨

---

## ğŸ“Š API ç«¯ç‚¹æƒé™çŸ©é˜µ

| ç«¯ç‚¹ | teaching_office | evaluator | evaluation_team | evaluation_office |
|-----|-----------------|-----------|-----------------|------------------|
| POST /teaching-office/self-evaluation | âœ… | âŒ | âŒ | âŒ |
| GET /teaching-office/self-evaluation/{id} | âœ… | âœ… | âœ… | âœ… |
| POST /teaching-office/attachments | âœ… | âŒ | âŒ | âŒ |
| GET /attachments/{id} | âœ… | âœ… | âœ… | âœ… |
| GET /attachments/{id}/download | âœ… | âœ… | âœ… | âœ… |
| POST /scoring/manual-score | âŒ | âœ… | âœ… | âœ… |

---

## ğŸ” å¸¸è§é—®é¢˜

### Q: evaluator ä»ç„¶æ”¶åˆ° 403 é”™è¯¯
**A**: 
1. æ£€æŸ¥åç«¯æ˜¯å¦é‡å¯
2. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜
3. æ£€æŸ¥ token æ˜¯å¦æœ‰æ•ˆ
4. æŸ¥çœ‹åç«¯æ—¥å¿—

### Q: é™„ä»¶åŠ è½½å¤±è´¥
**A**:
1. æ£€æŸ¥å‰ç«¯ API è·¯å¾„æ˜¯å¦æ­£ç¡®
2. éªŒè¯ evaluator æœ‰æƒé™è®¿é—® /attachments/{id}
3. æ£€æŸ¥ evaluation_id æ˜¯å¦æ­£ç¡®

### Q: è¯„åˆ†æäº¤è¿”å› 400 é”™è¯¯
**A**:
1. æ£€æŸ¥ scores æ ¼å¼æ˜¯å¦æ­£ç¡®ï¼ˆåº”ä¸ºåˆ—è¡¨ï¼‰
2. éªŒè¯ evaluation_id æ˜¯å¦å­˜åœ¨
3. æ£€æŸ¥æ˜¯å¦å·²ç»æäº¤è¿‡è¯„åˆ†

---

## ğŸ“‹ ä¿®æ”¹æ–‡ä»¶æ€»ç»“

### åç«¯ä¿®æ”¹
```
backend/app/api/v1/endpoints/auth.py
  - ä¿®æ”¹ç™»å½•å“åº”é€»è¾‘

backend/app/api/v1/endpoints/scoring.py
  - ä¿®æ”¹æƒé™æ£€æŸ¥
  - ä¿®æ”¹æƒé‡å‡½æ•°
```

### å‰ç«¯ä¿®æ”¹
```
frontend/src/components/ManualScoringForm.vue
  - ä¿®æ”¹ loadAttachments å‡½æ•°
  - ä¿®æ”¹ handleDownloadAttachment å‡½æ•°
```

---

## âœ¨ å®Œæ•´æµç¨‹

### æ•™ç ”å®¤ç«¯
```
ç™»å½• â†’ åˆ›å»ºè€ƒè¯„è¡¨ â†’ ä¸Šä¼ é™„ä»¶ â†’ æäº¤
```

### è¯„å§”ç«¯ (evaluator)
```
ç™»å½• â†’ åŠ è½½è€ƒè¯„è¡¨ â†’ æŸ¥çœ‹é™„ä»¶ â†’ è¯„åˆ† â†’ æäº¤
```

---

**æœ€åæ›´æ–°**: 2026-02-15  
**çŠ¶æ€**: âœ… å®Œæˆ  
**ä¸‹ä¸€æ­¥**: éƒ¨ç½²å’Œæµ‹è¯•
