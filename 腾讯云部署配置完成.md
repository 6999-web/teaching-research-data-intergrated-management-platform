# 腾讯云部署配置完成

## ✅ 配置完成

已为您的项目配置好腾讯云部署所需的所有文件。

---

## 📁 创建/修改的文件

### 前端配置

1. **frontend/.env.production** ⭐ 新建
   - 生产环境配置
   - API地址: http://101.33.211.98:8000/api

2. **frontend/.env.development** ⭐ 新建
   - 开发环境配置
   - API地址: /api (通过代理)

3. **frontend/src/api/client.ts** ⭐ 已修改
   - 支持根据环境变量动态设置API地址
   - 开发环境使用代理，生产环境直接访问

### 后端配置

4. **backend/.env.production** ⭐ 新建
   - 生产环境配置模板
   - 包含数据库、安全、API等配置

5. **backend/app/core/config.py** ⭐ 已修改
   - 添加腾讯云IP到CORS白名单
   - 支持多个域名访问

### 部署脚本

6. **deploy-to-cloud.sh** ⭐ 新建
   - 完整的部署脚本
   - 包含构建、配置、服务创建等步骤

7. **quick-deploy.sh** ⭐ 新建
   - 快速部署脚本
   - 在服务器上一键运行

### 文档

8. **腾讯云部署指南.md** ⭐ 新建
   - 详细的部署步骤说明
   - 包含故障排查和维护指南

9. **腾讯云部署配置完成.md** ⭐ 新建（本文档）
   - 配置完成总结

---

## 🚀 快速部署步骤

### 方法一：使用快速部署脚本（推荐）

```bash
# 1. 上传项目到服务器
rsync -avz --exclude='node_modules' --exclude='frontend/dist' \
  --exclude='backend/__pycache__' --exclude='*.pyc' \
  . root@101.33.211.98:/root/teaching-office-platform/

# 2. SSH登录服务器
ssh root@101.33.211.98

# 3. 运行快速部署脚本
cd /root/teaching-office-platform
chmod +x quick-deploy.sh
./quick-deploy.sh

# 4. 访问系统
# 打开浏览器访问: http://101.33.211.98
```

### 方法二：手动部署

详细步骤请参考《腾讯云部署指南.md》

---

## 🔧 配置说明

### 前端配置

**开发环境** (frontend/.env.development):
```env
VITE_API_BASE_URL=/api
```
- 使用Vite代理，API请求通过 `/api` 转发到 `http://localhost:8000`

**生产环境** (frontend/.env.production):
```env
VITE_API_BASE_URL=http://101.33.211.98:8000/api
```
- 直接访问服务器API地址

### 后端配置

**CORS设置** (backend/app/core/config.py):
```python
BACKEND_CORS_ORIGINS: List[str] = [
    "http://localhost:3000",
    "http://127.0.0.1:3000",
    "http://101.33.211.98",
    "http://101.33.211.98:3000",
    "http://101.33.211.98:8000"
]
```
- 允许本地开发和腾讯云服务器访问

**环境变量** (backend/.env.production):
- 数据库配置
- 安全密钥（需要修改）
- API密钥（需要配置）
- MinIO配置

---

## 📊 部署架构

```
用户浏览器
    ↓
http://101.33.211.98 (Nginx:80)
    ↓
    ├─→ / (前端静态文件)
    │   └─→ /root/teaching-office-platform/frontend/dist
    │
    └─→ /api (后端API)
        └─→ http://127.0.0.1:8000 (FastAPI)
            └─→ PostgreSQL数据库
```

### 端口说明

- **80**: Nginx (HTTP)
- **8000**: FastAPI后端
- **5432**: PostgreSQL数据库

---

## 🔐 安全配置

### 必须修改的配置

1. **数据库密码** (backend/.env):
   ```env
   POSTGRES_PASSWORD=your_secure_password  # 修改为强密码
   ```

2. **SECRET_KEY** (backend/.env):
   ```env
   SECRET_KEY=your-random-secret-key  # 使用 openssl rand -hex 32 生成
   ```

3. **DeepSeek API密钥** (backend/.env):
   ```env
   DEEPSEEK_API_KEY=your_api_key_here  # 如果使用AI功能
   ```

### 生成随机密钥

```bash
# 生成SECRET_KEY
openssl rand -hex 32

# 生成数据库密码
openssl rand -base64 32
```

---

## 🌐 访问地址

部署完成后，可通过以下地址访问：

- **前端平台**: http://101.33.211.98
- **API文档**: http://101.33.211.98/docs
- **健康检查**: http://101.33.211.98/api/health

---

## 🔄 双模式功能

系统支持两种工作模式，部署后可正常使用：

### 三端模式（功能导向）
- 教研室端
- 管理端
- 校长办公会端

### 四角色模式（角色导向）
- 普通教师
- 教研室负责人
- 二级学院负责人
- 学校教务处负责人

**切换方法**: 点击侧边栏顶部的切换按钮

---

## 📝 部署后检查清单

### 基础检查

- [ ] 项目已上传到服务器
- [ ] 系统依赖已安装（Python, Node.js, Nginx, PostgreSQL）
- [ ] 数据库已创建并配置
- [ ] 后端环境变量已配置
- [ ] 前端已构建（frontend/dist目录存在）

### 服务检查

- [ ] 后端服务已启动
  ```bash
  systemctl status teaching-office-backend
  ```

- [ ] Nginx已启动
  ```bash
  systemctl status nginx
  ```

- [ ] 数据库已启动
  ```bash
  systemctl status postgresql
  ```

### 功能检查

- [ ] 可以访问前端页面 (http://101.33.211.98)
- [ ] 可以访问API文档 (http://101.33.211.98/docs)
- [ ] API健康检查正常 (http://101.33.211.98/api/health)
- [ ] 双模式切换功能正常
- [ ] 可以登录系统
- [ ] 可以访问各个功能模块

### 安全检查

- [ ] 数据库密码已修改
- [ ] SECRET_KEY已修改为随机值
- [ ] 防火墙已配置
- [ ] 只开放必要的端口（80, 443, 8000）

---

## 🛠️ 常用命令

### 查看服务状态

```bash
# 后端服务
systemctl status teaching-office-backend

# Nginx
systemctl status nginx

# 数据库
systemctl status postgresql
```

### 查看日志

```bash
# 后端日志
journalctl -u teaching-office-backend -f

# Nginx错误日志
tail -f /var/log/nginx/error.log

# Nginx访问日志
tail -f /var/log/nginx/access.log
```

### 重启服务

```bash
# 重启后端
systemctl restart teaching-office-backend

# 重启Nginx
systemctl restart nginx

# 重新加载Nginx配置（不中断服务）
systemctl reload nginx
```

---

## 🐛 常见问题

### 问题 1: 前端页面无法访问

**检查**:
```bash
# 检查Nginx状态
systemctl status nginx

# 检查前端文件是否存在
ls -la /root/teaching-office-platform/frontend/dist

# 查看Nginx错误日志
tail -f /var/log/nginx/error.log
```

**解决**:
```bash
# 重新构建前端
cd /root/teaching-office-platform/frontend
npm run build

# 重启Nginx
systemctl restart nginx
```

### 问题 2: API请求失败

**检查**:
```bash
# 检查后端服务状态
systemctl status teaching-office-backend

# 查看后端日志
journalctl -u teaching-office-backend -n 100

# 测试API
curl http://127.0.0.1:8000/api/health
```

**解决**:
```bash
# 重启后端服务
systemctl restart teaching-office-backend

# 检查环境变量配置
cat /root/teaching-office-platform/backend/.env
```

### 问题 3: 数据库连接失败

**检查**:
```bash
# 检查PostgreSQL状态
systemctl status postgresql

# 测试数据库连接
sudo -u postgres psql -c "SELECT version();"

# 检查数据库是否存在
sudo -u postgres psql -l | grep teaching_office
```

**解决**:
```bash
# 启动PostgreSQL
systemctl start postgresql

# 检查数据库配置
cat /root/teaching-office-platform/backend/.env | grep POSTGRES
```

### 问题 4: CORS错误

**检查**:
```bash
# 查看CORS配置
cat /root/teaching-office-platform/backend/app/core/config.py | grep CORS
```

**解决**:
- 确保 `BACKEND_CORS_ORIGINS` 包含正确的域名
- 重启后端服务

---

## 📚 相关文档

- **腾讯云部署指南.md** - 详细的部署步骤
- **教研室数据管理平台介绍文档.md** - 系统功能介绍
- **双模式使用指南.md** - 双模式功能说明
- **README.md** - 项目说明

---

## 🎯 下一步

1. **测试系统功能**
   - 测试双模式切换
   - 测试各个功能模块
   - 测试文件上传

2. **配置HTTPS**（推荐）
   - 申请域名
   - 配置SSL证书
   - 使用Let's Encrypt

3. **设置监控**
   - 配置服务监控
   - 设置日志轮转
   - 配置自动备份

4. **性能优化**
   - 配置Nginx缓存
   - 优化数据库
   - 配置CDN（可选）

---

## ✅ 配置完成确认

- [x] 前端环境配置文件已创建
- [x] 后端环境配置文件已创建
- [x] API客户端已修改支持环境变量
- [x] CORS配置已更新
- [x] 部署脚本已创建
- [x] 部署指南已创建
- [x] 配置说明文档已创建

---

## 🎉 总结

所有部署配置文件已准备完成！您现在可以：

1. 使用 `quick-deploy.sh` 快速部署到服务器
2. 或按照《腾讯云部署指南.md》手动部署
3. 部署完成后通过 http://101.33.211.98 访问系统

祝部署顺利！🚀

---

**配置完成时间**: 2026-02-07  
**服务器IP**: 101.33.211.98  
**访问地址**: http://101.33.211.98
