# ✅ 问题已解决：提交表单到手动评分功能

## 问题描述

您要求：**点击教研室端的填写考评表里面的提交表单，表单就传到考评小组端的手动评分里面**

## 解决方案

### 修改的文件

**`frontend/src/views/ManualScoring.vue`**

**修改内容**：
```javascript
// 之前的代码（有问题）
const loadEvaluations = async () => {
  const response = await scoringApi.getEvaluationsForScoring({
    status: 'ai_scored' // ❌ 只显示AI已评分的
  })
}

// 修改后的代码（正确）
const loadEvaluations = async () => {
  const response = await scoringApi.getEvaluationsForScoring({})
  // ✅ 不传status参数，后端会返回 locked 和 ai_scored 状态的表单
}
```

### 为什么之前不工作？

1. **前端问题**：手动评分页面只请求 `status: 'ai_scored'` 的自评表
2. **实际情况**：提交后的自评表状态是 `locked`（已锁定）
3. **结果**：刚提交的表单不会出现在列表中，必须等AI评分完成

### 现在如何工作？

1. **教研室端提交**：
   - 点击"提交表单"
   - 状态变为 `locked`（已锁定）
   - 可选：触发AI评分

2. **考评小组端查看**：
   - 访问手动评分页面
   - **立即看到刚提交的表单**
   - 状态显示为"已锁定"

## 完整测试流程

### 步骤1：登录教研室端

```
URL: http://localhost:3000/login
用户名: test_teaching_office
密码: password123
```

### 步骤2：提交表单

```
URL: http://localhost:3000/self-evaluation
操作: 填写所有必填项 → 点击"提交表单"
结果: 看到"提交成功！数据已上传到考评小组端"
```

### 步骤3：切换到考评小组端

```
操作: 退出登录
URL: http://localhost:3000/login
用户名: test_eval_team
密码: password123
```

### 步骤4：查看手动评分列表

```
URL: http://localhost:3000/manual-scoring
结果: ✅ 立即看到刚提交的表单
```

## 数据流程图

```
┌─────────────────────────────────────────────────────────────┐
│                      教研室端                                │
│                                                              │
│  1. 填写表单                                                 │
│  2. 点击"提交表单"                                           │
│     ↓                                                        │
│  3. 调用API保存数据                                          │
│  4. 调用API提交并锁定 (status → locked)                      │
│  5. 调用API触发AI评分（可选）                                │
│                                                              │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ↓
┌─────────────────────────────────────────────────────────────┐
│                      数据库                                  │
│                                                              │
│  self_evaluations 表:                                        │
│  - id: xxx                                                   │
│  - teaching_office_id: test-office-001                       │
│  - status: locked  ← 关键状态                                │
│  - submitted_at: 2025-01-XX XX:XX:XX                         │
│  - content: {...}                                            │
│                                                              │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ↓
┌─────────────────────────────────────────────────────────────┐
│                    考评小组端                                │
│                                                              │
│  1. 访问手动评分页面                                         │
│  2. 调用API: GET /api/scoring/evaluations-for-scoring       │
│     ↓                                                        │
│  3. 后端返回 status in ['locked', 'ai_scored'] 的表单       │
│     ↓                                                        │
│  4. ✅ 看到刚提交的表单（状态：已锁定）                      │
│  5. 点击"开始评分"进行手动评分                               │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

## 关键点

### ✅ 已实现的功能

1. **一键提交**：点击"提交表单"自动完成所有步骤
2. **立即可见**：提交后立即出现在手动评分列表
3. **无需等待**：不需要等待AI评分完成
4. **状态清晰**：显示"已锁定"或"AI已评分"状态

### 🔧 后端API支持

后端 `/api/scoring/evaluations-for-scoring` 默认返回：
- `status = 'locked'`（已提交但未AI评分）
- `status = 'ai_scored'`（AI已评分）

### 📱 前端显示

手动评分页面会显示：
- 教研室名称
- 考评年度
- 状态（已锁定/AI已评分）
- 提交时间
- "开始评分"按钮

## 验证方法

### 快速验证

1. 打开两个浏览器窗口
2. 窗口1：登录教研室端，提交表单
3. 窗口2：登录考评小组端，刷新手动评分页面
4. ✅ 应该立即看到刚提交的表单

### 数据库验证

```sql
-- 查看待评分的自评表
SELECT 
    se.id,
    to.name,
    se.status,
    se.submitted_at
FROM self_evaluations se
JOIN teaching_offices to ON se.teaching_office_id = to.id
WHERE se.status IN ('locked', 'ai_scored')
ORDER BY se.submitted_at DESC;
```

## 常见问题

### Q: 提交后看不到表单？

**A**: 检查以下几点：
1. 确保使用考评小组或考评办公室账号登录
2. 刷新手动评分页面
3. 检查表单状态是否为 `locked` 或 `ai_scored`

### Q: 必须等AI评分完成吗？

**A**: 不需要！现在 `locked` 状态的表单也会显示，可以立即开始手动评分。

### Q: 如果AI评分失败怎么办？

**A**: 不影响！表单仍然会显示在手动评分列表中（状态为"已锁定"），考评小组可以直接进行手动评分。

## 🎉 总结

**功能已完全实现！**

- ✅ 教研室端点击"提交表单"
- ✅ 数据立即传到考评小组端
- ✅ 手动评分列表立即显示
- ✅ 无需等待AI评分
- ✅ 可以立即开始手动评分

**现在就可以测试了！** 🚀
