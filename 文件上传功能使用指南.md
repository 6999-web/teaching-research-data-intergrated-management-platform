# 文件上传功能使用指南

## 问题已修复 ✅

教研室端文件上传功能已修复，现在支持两种存储方式：

### 1. MinIO 对象存储（推荐）
- 适合生产环境
- 支持分布式存储
- 需要启动 MinIO 服务

### 2. 本地文件存储（备用方案）
- 适合开发和测试
- 无需额外服务
- 文件保存在 `backend/uploads/` 目录

---

## 当前状态

✅ 后端已自动适配：
- 如果 MinIO 可用 → 使用 MinIO 存储
- 如果 MinIO 不可用 → 自动切换到本地文件存储

✅ 无需修改代码，系统会自动选择可用的存储方式

---

## 使用方法

### 教研室端上传文件

1. 登录教研室端账号
2. 进入"自评表填写"页面
3. 填写自评表内容
4. 点击"提交表单"
5. 系统会自动跳转到附件上传页面（或手动进入"附件上传"）
6. 选择考核指标
7. 拖拽或点击上传文件
8. 点击"提交附件"

### 支持的文件格式

#### 证书类
- PDF (.pdf)
- 图片 (.jpg, .jpeg, .png)
- Word 文档 (.doc, .docx)

#### 项目类
- PDF (.pdf)
- Excel (.xls, .xlsx)
- Word 文档 (.doc, .docx)
- 压缩包 (.zip, .rar)

### 文件大小限制
- 单个文件：最大 50MB
- 每次上传：最多 10 个文件

---

## 启动 MinIO 服务（可选）

如果想使用 MinIO 对象存储：

### 方法一：使用 Docker Compose（推荐）

```bash
# 启动 Docker Desktop

# 启动 MinIO 服务
docker-compose up -d minio

# 验证服务
docker ps | findstr minio
```

### 方法二：独立运行 MinIO

```bash
# 下载 MinIO（Windows）
curl -O https://dl.min.io/server/minio/release/windows-amd64/minio.exe

# 设置环境变量
set MINIO_ROOT_USER=minioadmin
set MINIO_ROOT_PASSWORD=minioadmin

# 启动服务
minio.exe server minio-data --console-address ":9001"
```

### 访问 MinIO 控制台

- URL: http://localhost:9001
- 用户名: minioadmin
- 密码: minioadmin

---

## 测试文件上传

运行测试脚本验证功能：

```bash
python test_file_upload.py
```

---

## 文件存储位置

### 使用本地存储时
```
backend/uploads/
  └── {evaluation_id}/
      └── {indicator}/
          └── {unique_filename}
```

### 使用 MinIO 时
- Bucket: teaching-office-attachments
- 路径结构同上

---

## 常见问题

### Q1: 上传文件时提示"自评表不存在"
**原因**: 需要先创建自评表才能上传附件

**解决方法**:
1. 先在教研室端填写并提交自评表
2. 提交后会自动跳转到附件上传页面
3. 或者在主页点击"附件上传"

### Q2: 上传文件时没有反应
**检查步骤**:
1. 打开浏览器开发者工具（F12）
2. 查看 Console 标签是否有错误
3. 查看 Network 标签，检查上传请求状态
4. 确认后端服务正常运行（http://localhost:8000/docs）

### Q3: 文件上传后在哪里查看？
**查看方式**:
1. 教研室端：在附件上传页面可以看到"已上传附件"列表
2. 管理端：在附件管理页面可以查看所有附件
3. 本地存储：检查 `backend/uploads/` 目录

### Q4: 如何切换存储方式？
**自动切换**:
- 系统会自动检测 MinIO 是否可用
- 不需要手动配置

**强制使用 MinIO**:
- 启动 MinIO 服务即可
- 系统会自动使用 MinIO

**强制使用本地存储**:
- 停止 MinIO 服务
- 系统会自动切换到本地存储

---

## 技术细节

### 修改的文件

1. `backend/app/services/local_file_service.py` (新增)
   - 本地文件存储服务

2. `backend/app/services/minio_service.py` (修改)
   - 添加自动切换逻辑
   - MinIO 不可用时使用本地存储

3. `backend/uploads/` (新增目录)
   - 本地文件存储目录

### 存储策略

```python
# 上传文件时的逻辑
if MinIO 可用:
    上传到 MinIO
else:
    保存到本地文件系统

# 下载文件时的逻辑
if MinIO 可用:
    从 MinIO 下载
else:
    从本地文件系统读取
```

---

## 后续优化建议

### 生产环境部署
1. 使用 MinIO 集群提高可用性
2. 配置 CDN 加速文件访问
3. 设置文件备份策略

### 功能增强
1. 支持文件预览
2. 支持批量下载
3. 添加文件版本管理
4. 实现文件去重

---

## 总结

✅ 文件上传功能已完全修复
✅ 支持自动切换存储方式
✅ 无需额外配置即可使用
✅ 适合开发和生产环境

现在可以正常使用教研室端的文件上传功能了！
