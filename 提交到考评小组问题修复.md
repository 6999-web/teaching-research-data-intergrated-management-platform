# 提交到考评小组问题修复

## 问题描述
教研室端无法上传考评表到考评小组端，出现403 Forbidden错误。

## 错误信息
```
POST http://localhost:3000/api/teaching-office/self-evaluation/{id}/submit 403 (Forbidden)
Failed to submit self-evaluation: AxiosError: Request failed with status code 403
```

## 问题分析

### 可能的原因
1. **权限问题**: 用户没有正确的权限
2. **Token问题**: Token无效或过期
3. **状态问题**: 自评表状态不正确
4. **数据库问题**: 数据未正确保存

## 修复方案

### 1. 增强错误处理
在 `TeachingOfficeHome.vue` 中增强了submit步骤的错误处理：

```typescript
// Step 3: Submit and lock
try {
  await selfEvaluationApi.submit(evaluationId)
} catch (submitError: any) {
  if (loadingMessage) loadingMessage.close()
  console.error('Submit error:', submitError)
  
  // 如果是403错误，可能是权限问题
  if (submitError.response?.status === 403) {
    ElMessage.error('提交失败：没有权限。请确保您已正确登录。')
  } else {
    ElMessage.error(submitError.response?.data?.detail || '提交失败，请重试')
  }
  return
}
```

### 2. 分离AI评分步骤
将AI评分作为可选步骤，即使失败也不影响提交：

```typescript
// Step 4: Trigger AI scoring (optional)
try {
  await selfEvaluationApi.triggerAIScoring(evaluationId)
  console.log('AI scoring triggered successfully')
} catch (aiError: any) {
  console.warn('AI评分触发失败，但不影响提交:', aiError)
  // AI评分失败不影响提交结果
}
```

## 诊断步骤

### 步骤1：检查登录状态
```javascript
// 在浏览器控制台执行
console.log('Token:', localStorage.getItem('token'))
console.log('User Role:', localStorage.getItem('userRole'))
console.log('Teaching Office ID:', localStorage.getItem('teachingOfficeId'))
```

### 步骤2：验证Token
```javascript
fetch('/api/auth/verify', {
  headers: {
    'Authorization': `Bearer ${localStorage.getItem('token')}`
  }
})
.then(res => res.json())
.then(data => console.log('Token valid:', data))
.catch(err => console.error('Token invalid:', err))
```

### 步骤3：使用测试脚本
运行提供的Python测试脚本：

```bash
python test_submit_evaluation.py
```

这个脚本会：
1. 测试登录
2. 测试保存自评表
3. 测试提交自评表
4. 测试触发AI评分

### 步骤4：检查后端日志
```bash
# 在backend目录下
tail -f error.log
```

查找相关错误信息。

## 常见问题和解决方案

### Q1: 403 Forbidden错误
**原因**: 
- Token无效或过期
- 用户角色不匹配
- 未正确登录

**解决方案**:
1. 清除localStorage并重新登录
```javascript
localStorage.clear()
location.reload()
```

2. 确保从"教研室端"入口登录
3. 检查userRole是否为"teaching_office"

### Q2: 自评表状态不正确
**原因**: 自评表可能已经提交过

**解决方案**:
1. 检查数据库中自评表的状态
```sql
SELECT id, status, submitted_at 
FROM self_evaluations 
WHERE teaching_office_id = 'your_id' 
AND evaluation_year = 2026;
```

2. 如果状态是"locked"，需要管理员打回

### Q3: AI评分失败
**原因**: AI服务未配置或不可用

**解决方案**:
- AI评分失败不影响提交
- 可以稍后手动触发AI评分
- 或者由管理员进行手动评分

## 测试步骤

### 完整测试流程
1. **清除数据**
```javascript
localStorage.clear()
location.reload()
```

2. **重新登录**
- 访问 http://localhost:3000
- 点击"教研室端"
- 用户名: `office1`
- 密码: `password123`

3. **填写自评表**
- 填写所有必填项（8个常规教学工作项目）
- 每项至少10个字符
- 输入自评分

4. **提交表单**
- 点击"提交表单"按钮
- 观察提交过程
- 查看控制台输出

5. **验证结果**
- 应该看到"提交成功！"消息
- 检查数据库中的状态

### 数据库验证
```sql
-- 查看最新的自评表
SELECT 
  id,
  teaching_office_id,
  evaluation_year,
  status,
  submitted_at,
  created_at
FROM self_evaluations
ORDER BY created_at DESC
LIMIT 1;

-- 查看操作日志
SELECT 
  operation_type,
  operator_name,
  operator_role,
  target_type,
  details,
  created_at
FROM operation_logs
ORDER BY created_at DESC
LIMIT 5;
```

## 后端API说明

### 1. 保存自评表
```
POST /api/teaching-office/self-evaluation
Authorization: Bearer {token}
Content-Type: application/json

{
  "teaching_office_id": "uuid",
  "evaluation_year": 2026,
  "content": {}
}
```

### 2. 提交自评表
```
POST /api/teaching-office/self-evaluation/{evaluation_id}/submit
Authorization: Bearer {token}
```

### 3. 触发AI评分
```
POST /api/teaching-office/trigger-ai-scoring
Authorization: Bearer {token}
Content-Type: application/json

{
  "evaluation_id": "uuid"
}
```

## 修改的文件
- `frontend/src/views/TeachingOfficeHome.vue` - 增强错误处理
- `test_submit_evaluation.py` - 新增测试脚本

## 预期结果

### 成功提交
1. ✅ 显示"正在提交自评表，请稍候..."
2. ✅ 显示"正在提交到考评小组，请稍候..."
3. ✅ 显示"提交成功！数据已上传到考评小组端"
4. ✅ 数据库中状态变为"locked"
5. ✅ 记录操作日志

### 失败情况
1. ❌ 403错误 - 检查登录状态和权限
2. ❌ 401错误 - Token无效，重新登录
3. ❌ 400错误 - 检查数据格式和状态

## 调试技巧

### 1. 查看完整的错误信息
```javascript
// 在catch块中
console.error('Full error:', error)
console.error('Response:', error.response)
console.error('Data:', error.response?.data)
console.error('Status:', error.response?.status)
```

### 2. 查看请求详情
打开开发者工具 → Network标签 → 找到失败的请求 → 查看：
- Request Headers (特别是Authorization)
- Request Payload
- Response Headers
- Response Body

### 3. 使用curl测试
```bash
# 获取token
TOKEN=$(curl -X POST http://localhost:8000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"office1","password":"password123","role":"teaching_office"}' \
  | jq -r '.token')

# 保存自评表
EVAL_ID=$(curl -X POST http://localhost:8000/api/teaching-office/self-evaluation \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"teaching_office_id":"a1b2c3d4-e5f6-4a5b-8c9d-111111111111","evaluation_year":2026,"content":{}}' \
  | jq -r '.evaluation_id')

# 提交自评表
curl -X POST "http://localhost:8000/api/teaching-office/self-evaluation/$EVAL_ID/submit" \
  -H "Authorization: Bearer $TOKEN"
```

## 下一步

如果问题仍然存在：
1. 运行测试脚本 `python test_submit_evaluation.py`
2. 提供完整的错误日志
3. 提供Network标签的截图
4. 提供后端error.log的内容

## 相关文档
- `快速修复-登录和提交问题.md`
- `登录问题诊断和修复.md`
- `表单提交错误修复-2026-02-14.md`
