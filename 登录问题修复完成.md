# 登录问题修复完成

## 问题原因

登录API要求必须提供`role`字段，但前端在某些情况下没有发送该字段，导致登录失败。

## 已修复内容

### 1. 后端修改

**文件**: `backend/app/schemas/auth.py`
- 将`role`字段改为可选（Optional）
- 用户登录时不再强制要求提供角色

**文件**: `backend/app/api/v1/endpoints/auth.py`
- 修改登录逻辑，role字段变为可选验证
- 如果提供了role，则验证是否匹配
- 如果没有提供role，则直接使用数据库中的角色

### 2. 修复效果

现在支持两种登录方式：

#### 方式1：不提供role（推荐）
```json
{
  "username": "director1",
  "password": "password123"
}
```
系统会自动从数据库获取用户角色。

#### 方式2：提供role（可选）
```json
{
  "username": "director1",
  "password": "password123",
  "role": "teaching_office"
}
```
系统会验证提供的角色是否与数据库中的角色匹配。

---

## 测试登录

### 方法1：使用测试脚本

```bash
python test_login.py
```

这会测试所有用户的登录功能。

### 方法2：使用浏览器

1. 访问 http://localhost:3000
2. 点击"教研室端"或"管理端"
3. 输入用户名和密码：
   - 教研室端: `director1` / `password123`
   - 评教小组: `evaluator1` / `password123`
   - 办公室: `office1` / `password123`
   - 校长办公会: `president1` / `password123`
4. 点击"登录"

### 方法3：使用API文档

1. 访问 http://localhost:8000/docs
2. 找到 `POST /api/auth/login`
3. 点击"Try it out"
4. 输入测试数据：
   ```json
   {
     "username": "director1",
     "password": "password123"
   }
   ```
5. 点击"Execute"

---

## 测试账号

所有账号的密码都是：`password123`

### 教研室端
- `director1` - 计算机科学教研室主任
- `director2` - 数学教研室主任
- `director3` - 物理教研室主任

### 评教小组
- `evaluator1` - 评委张老师
- `evaluator2` - 评委李老师

### 评教小组办公室
- `office1` - 办公室主任

### 校长办公会
- `president1` - 校长

---

## 重启后端服务

修改完成后，需要重启后端服务：

1. 找到运行后端的命令行窗口
2. 按 `Ctrl + C` 停止服务
3. 重新运行：
   ```bash
   cd backend
   python -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
   ```

---

## 验证修复

### 1. 检查后端启动日志

后端启动后，应该看到：
```
INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)
INFO:     Started reloader process
INFO:     Started server process
INFO:     Waiting for application startup.
INFO:     Application startup complete.
```

没有数据库连接错误。

### 2. 测试登录API

```bash
curl -X POST "http://localhost:8000/api/auth/login" \
  -H "Content-Type: application/json" \
  -d '{"username":"director1","password":"password123"}'
```

应该返回：
```json
{
  "token": "eyJ...",
  "userId": "...",
  "role": "teaching_office",
  "teachingOfficeId": "...",
  "expiresIn": 604800
}
```

### 3. 测试前端登录

1. 打开浏览器，访问 http://localhost:3000
2. 点击"教研室端"
3. 输入 `director1` / `password123`
4. 点击"登录"
5. 应该成功跳转到教研室端主页

---

## 常见问题

### Q1: 登录后立即跳转到登录页

**原因**: Token没有正确保存到localStorage

**解决方法**:
1. 打开浏览器开发者工具（F12）
2. 进入Application标签
3. 清除Local Storage
4. 刷新页面重新登录

### Q2: 提示"用户名或密码错误"

**检查项**:
1. 确认用户名拼写正确
2. 确认密码是 `password123`
3. 确认数据库中有该用户：
   ```bash
   python verify_database_setup.py
   ```

### Q3: 提示"用户角色不匹配"

**原因**: 前端发送的role与数据库中的role不一致

**解决方法**:
- 教研室端用户使用"教研室端"入口登录
- 管理端用户使用"管理端"入口登录，并选择正确的角色

### Q4: 后端报数据库连接错误

**解决方法**:
1. 确认MySQL服务正在运行
2. 确认MySQL密码是 'root'
3. 运行修复脚本：
   ```bash
   setup_mysql_password.bat
   ```

---

## 技术细节

### 修改前的问题

```python
# 旧代码 - role是必需的
class LoginRequest(BaseModel):
    username: str
    password: str
    role: Literal['teaching_office', 'evaluation_team', 'evaluation_office', 'president_office']
```

这导致前端必须在所有情况下都提供role字段。

### 修改后的实现

```python
# 新代码 - role是可选的
class LoginRequest(BaseModel):
    username: str
    password: str
    role: Optional[Literal['teaching_office', 'evaluation_team', 'evaluation_office', 'president_office']] = None
```

现在role字段是可选的，系统会自动从数据库获取用户角色。

### 登录流程

1. 用户提交用户名和密码（可选：角色）
2. 后端验证用户名和密码
3. 如果提供了角色，验证是否匹配
4. 从数据库获取用户的实际角色
5. 生成JWT token，包含用户信息和角色
6. 返回token和用户信息给前端
7. 前端保存token到localStorage
8. 根据角色跳转到相应页面

---

## 总结

✅ 登录API已修复，role字段变为可选
✅ 支持不提供role的简化登录
✅ 保持向后兼容，仍支持提供role的登录
✅ 所有测试账号都可以正常登录

现在两个端口（教研室端和管理端）都应该可以正常登录了！
