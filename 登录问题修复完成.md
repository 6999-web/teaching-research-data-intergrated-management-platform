# 登录问题修复完成

## 问题诊断

从截图看到的错误：
1. **401 Unauthorized** - 认证失败
2. **500 Internal Server Error** - 服务器内部错误
3. **登录失败，请检查用户名和密码** - 前端显示的错误消息

## 根本原因

1. **前后端数据格式不匹配**:
   - 后端返回: `{ token, userId, role, expiresIn }`
   - 前端期望: `{ access_token, user: {...} }`

2. **错误处理不完善**:
   - 前端没有正确处理后端返回的错误信息
   - 后端错误消息是英文，不够友好

## 已修复的内容

### 1. 前端 Login.vue

**修复内容**:
- 正确解析后端返回的数据格式
- 构造完整的user对象
- 改进错误处理，显示详细错误信息

**修改后的代码**:
```typescript
const data = await response.json()

// 构造用户对象
const user = {
  id: data.userId,
  name: loginForm.value.username,
  role: data.role,
  teaching_office_id: data.teachingOfficeId || ''
}

// 保存认证信息
authStore.setAuth({
  token: data.token,  // 注意：是 token，不是 access_token
  user: user
})
```

### 2. 后端 auth.py

**修复内容**:
- 改进错误消息，使用中文
- 提供更详细的角色不匹配错误信息

**修改后的错误消息**:
- `"用户名或密码错误"` (替代 "Incorrect username or password")
- `"用户角色不匹配。您的角色是 {user.role}，但尝试以 {login_data.role} 身份登录"`

## 测试步骤

### 步骤1: 重启后端服务

后端代码已修改，需要重启：

```bash
# 如果后端在单独窗口运行，按 Ctrl+C 停止
# 然后重新启动
cd backend
python -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

### 步骤2: 刷新前端

```bash
# 在浏览器中按 Ctrl + Shift + R 强制刷新
```

### 步骤3: 测试登录

#### 教研室端登录:
1. 访问: http://localhost:3000/login
2. 点击"教研室端"卡片
3. 输入:
   - 用户名: `test_teaching_office`
   - 密码: `password123`
4. 点击"登录"

#### 考评小组端登录:
1. 访问: http://localhost:3000/login
2. 点击"管理端"卡片
3. 输入:
   - 用户名: `test_eval_team`
   - 密码: `password123`
   - 角色: 评教小组
4. 点击"登录"

## 预期结果

### 登录成功:
- ✅ 显示"登录成功！"消息
- ✅ 自动跳转到对应的主页
- ✅ localStorage中保存了token和用户信息

### 登录失败:
- ❌ 用户名或密码错误: 显示"用户名或密码错误"
- ❌ 角色不匹配: 显示"用户角色不匹配。您的角色是 xxx，但尝试以 yyy 身份登录"

## 验证登录状态

打开浏览器控制台（F12），执行：

```javascript
// 检查token
console.log('Token:', localStorage.getItem('token'))

// 检查用户信息
console.log('User ID:', localStorage.getItem('userId'))
console.log('User Name:', localStorage.getItem('userName'))
console.log('User Role:', localStorage.getItem('userRole'))

// 所有值都应该存在
```

## 常见问题

### Q1: 仍然显示"用户名或密码错误"

**可能原因**:
1. 密码确实错误
2. 数据库中的密码hash不正确

**解决方案**:
```bash
# 检查数据库中的用户
mysql -u root -proot teaching_office_evaluation -e "SELECT username, role FROM users WHERE username='test_teaching_office';"

# 如果用户不存在，运行修复脚本
mysql -u root -proot teaching_office_evaluation < fix_issues.sql
```

### Q2: 显示"用户角色不匹配"

**可能原因**:
- 数据库中用户的role与登录时选择的role不一致

**解决方案**:
```bash
# 检查用户角色
mysql -u root -proot teaching_office_evaluation -e "SELECT username, role FROM users WHERE username='test_teaching_office';"

# 应该显示:
# username: test_teaching_office
# role: teaching_office

# 如果role不对，更新它:
mysql -u root -proot teaching_office_evaluation -e "UPDATE users SET role='teaching_office' WHERE username='test_teaching_office';"
```

### Q3: 后端返回500错误

**可能原因**:
- 后端代码有错误
- 数据库连接失败

**解决方案**:
1. 查看后端窗口的错误日志
2. 检查数据库是否运行:
   ```bash
   mysql -u root -proot -e "SELECT 1;"
   ```

## 测试账号汇总

### 教研室端
```
用户名: test_teaching_office
密码: password123
角色: teaching_office (自动选择)
```

### 考评小组
```
用户名: test_eval_team
密码: password123
角色: evaluation_team (需要手动选择"评教小组")
```

## 调试技巧

### 1. 查看网络请求

打开开发者工具（F12） → Network标签：

1. 清除所有请求
2. 尝试登录
3. 找到 `/api/auth/login` 请求
4. 查看:
   - Request Payload (发送的数据)
   - Response (返回的数据)
   - Status Code (状态码)

### 2. 查看后端日志

后端窗口会显示所有请求：

```
INFO:     127.0.0.1:xxxxx - "POST /api/auth/login HTTP/1.1" 200 OK
```

如果是401或500，会显示错误详情。

### 3. 测试API

使用curl测试登录API：

```bash
curl -X POST http://localhost:8000/api/auth/login \
  -H "Content-Type: application/json" \
  -d "{\"username\":\"test_teaching_office\",\"password\":\"password123\",\"role\":\"teaching_office\"}"
```

**预期返回**:
```json
{
  "token": "eyJ...",
  "userId": "...",
  "role": "teaching_office",
  "expiresIn": 43200
}
```

## 完整的登录流程

```
1. 用户访问 /login
    ↓
2. 点击"教研室端"或"管理端"
    ↓
3. 输入用户名和密码
    ↓
4. 点击"登录"
    ↓
5. 前端发送 POST /api/auth/login
    ↓
6. 后端验证用户名
    ↓
7. 后端验证密码
    ↓
8. 后端验证角色
    ↓
9. 后端生成JWT token
    ↓
10. 后端返回 { token, userId, role, expiresIn }
    ↓
11. 前端构造user对象
    ↓
12. 前端调用 authStore.setAuth()
    ↓
13. 保存到localStorage
    ↓
14. 显示"登录成功！"
    ↓
15. 跳转到主页
```

## 总结

✅ 已修复前后端数据格式不匹配问题
✅ 已改进错误消息，使用中文
✅ 已改进错误处理逻辑

现在需要：
1. 重启后端服务
2. 刷新前端页面
3. 重新登录测试

所有功能应该都能正常工作了！

---

**修复时间**: 2026-02-13
**版本**: 2.1.0
**状态**: ✅ 修复完成
