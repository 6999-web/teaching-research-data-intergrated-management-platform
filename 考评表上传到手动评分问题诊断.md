# 考评表无法上传到考评小组端手动评分问题诊断

## 📅 诊断时间
2026年2月14日

## 🔍 问题描述
用户反馈：考评表无法上传到考评小组端的手动评分页面

## ✅ 诊断结果

### 1. 后端API测试 - 正常✅

#### 测试命令
```powershell
# 登录考评小组账号
$response = Invoke-RestMethod -Uri "http://localhost:8000/api/auth/login" -Method POST -ContentType "application/json" -Body '{"username":"evaluator1","password":"password123","role":"evaluation_team"}'

# 获取待评分列表
$token = $response.token
Invoke-RestMethod -Uri "http://localhost:8000/api/scoring/evaluations-for-scoring" -Method GET -Headers @{Authorization="Bearer $token"}
```

#### 测试结果
```json
{
  "value": [
    {
      "id": "faa49cfd-090d-4d36-82ac-53c302e6e6e8",
      "teaching_office_id": "00000000-0000-0000-0000-000000000001",
      "teaching_office_name": "Computer Science Office",
      "evaluation_year": 2026,
      "status": "locked",
      "submitted_at": "2026-02-14T02:40:33"
    },
    {
      "id": "e56d8557-e341-40ff-9987-1ca7d50d21c7",
      "teaching_office_id": "a1b2c3d4-e5f6-4a5b-8c9d-111111111111",
      "teaching_office_name": "Test Teaching Office",
      "evaluation_year": 2026,
      "status": "locked",
      "submitted_at": "2026-02-13T14:16:31"
    }
  ],
  "Count": 2
}
```

**结论**：后端API正常工作，返回了2条状态为 `locked` 的待评分自评表。

---

### 2. 数据库状态检查 - 正常✅

#### 查询命令
```sql
SELECT 
  t.id, 
  t.name, 
  s.id as eval_id, 
  s.evaluation_year, 
  s.status, 
  s.submitted_at 
FROM teaching_offices t 
LEFT JOIN self_evaluations s ON t.id = s.teaching_office_id 
WHERE s.status = 'locked' 
ORDER BY s.submitted_at DESC;
```

#### 查询结果
| 教研室ID | 教研室名称 | 自评表ID | 年度 | 状态 | 提交时间 |
|---------|-----------|---------|------|------|---------|
| 00000000-0000-0000-0000-000000000001 | Computer Science Office | faa49cfd-090d-4d36-82ac-53c302e6e6e8 | 2026 | locked | 2026-02-14 02:40:33 |
| a1b2c3d4-e5f6-4a5b-8c9d-111111111111 | Test Teaching Office | e56d8557-e341-40ff-9987-1ca7d50d21c7 | 2026 | locked | 2026-02-13 14:16:31 |

**结论**：数据库中有2条已提交并锁定的自评表，状态正确。

---

### 3. 前端页面检查 - 需要验证⚠️

#### 前端代码分析
文件：`frontend/src/views/ManualScoring.vue`

**关键代码**：
```typescript
// Load evaluations from API
const loadEvaluations = async () => {
  try {
    loading.value = true
    // 不传status参数，后端会默认返回 locked 和 ai_scored 状态的自评表
    const response = await scoringApi.getEvaluationsForScoring({})
    evaluations.value = response.data
  } catch (error: any) {
    console.error('Failed to load evaluations:', error)
    ElMessage.error(error.response?.data?.detail || '加载待评分列表失败')
  } finally {
    loading.value = false
  }
}
```

**可能的问题**：
1. 前端可能没有正确处理API响应的数据结构
2. 前端可能没有正确存储和使用token
3. 前端可能有CORS或网络问题

---

## 🔧 解决方案

### 方案1：检查前端是否能正常访问（推荐）

#### 步骤1：登录管理端
1. 打开浏览器访问：http://localhost:3000
2. 点击"管理端"卡片
3. 输入账号：
   - 用户名：`evaluator1`
   - 密码：`password123`
   - 角色：选择"评教小组"
4. 点击"登录"

#### 步骤2：进入手动评分页面
1. 登录成功后，应该看到管理端主页
2. 点击"手动评分"菜单或按钮
3. 查看是否显示待评分列表

#### 步骤3：检查浏览器控制台
1. 按F12打开浏览器开发者工具
2. 切换到"Console"标签
3. 查看是否有错误信息
4. 切换到"Network"标签
5. 刷新页面，查看API请求是否成功

---

### 方案2：修复前端API响应处理

如果前端无法正确显示数据，可能需要修改 `frontend/src/views/ManualScoring.vue`：

#### 问题：API响应数据结构不匹配

后端返回的数据结构：
```json
{
  "value": [...],  // 数据在value字段中
  "Count": 2
}
```

但前端可能期望：
```json
[...]  // 直接是数组
```

#### 修复代码
```typescript
const loadEvaluations = async () => {
  try {
    loading.value = true
    const response = await scoringApi.getEvaluationsForScoring({})
    
    // 修复：检查响应数据结构
    if (Array.isArray(response.data)) {
      evaluations.value = response.data
    } else if (response.data.value && Array.isArray(response.data.value)) {
      evaluations.value = response.data.value
    } else {
      evaluations.value = []
    }
  } catch (error: any) {
    console.error('Failed to load evaluations:', error)
    ElMessage.error(error.response?.data?.detail || '加载待评分列表失败')
  } finally {
    loading.value = false
  }
}
```

---

### 方案3：检查API客户端配置

文件：`frontend/src/api/client.ts`

确保API基础URL配置正确：
```typescript
const baseURL = import.meta.env.VITE_API_BASE_URL || '/api'
```

检查环境变量文件 `frontend/.env.development`：
```env
VITE_API_BASE_URL=http://localhost:8000/api
```

---

## 🧪 完整测试流程

### 测试1：后端API直接测试
```powershell
# 1. 登录
$response = Invoke-RestMethod -Uri "http://localhost:8000/api/auth/login" -Method POST -ContentType "application/json" -Body '{"username":"evaluator1","password":"password123","role":"evaluation_team"}'

# 2. 获取token
$token = $response.token

# 3. 获取待评分列表
Invoke-RestMethod -Uri "http://localhost:8000/api/scoring/evaluations-for-scoring" -Method GET -Headers @{Authorization="Bearer $token"} | ConvertTo-Json -Depth 5
```

**预期结果**：返回2条待评分的自评表

---

### 测试2：前端页面测试
1. 访问：http://localhost:3000
2. 登录管理端（evaluator1 / password123，选择"评教小组"）
3. 进入"手动评分"页面
4. 应该看到2条待评分记录：
   - Computer Science Office - 2026年度
   - Test Teaching Office - 2026年度

---

### 测试3：手动评分流程测试
1. 在待评分列表中，点击"开始评分"按钮
2. 应该进入评分表单页面
3. 填写各项评分
4. 提交评分
5. 返回列表，该教研室应该从列表中消失或状态改变

---

## 📊 当前系统状态

### 已提交的自评表
| 教研室 | 年度 | 状态 | 提交时间 | 是否可评分 |
|--------|------|------|---------|-----------|
| Computer Science Office | 2026 | locked | 2026-02-14 02:40:33 | ✅ 是 |
| Test Teaching Office | 2026 | locked | 2026-02-13 14:16:31 | ✅ 是 |

### 测试账号
| 角色 | 用户名 | 密码 | 权限 |
|------|--------|------|------|
| 考评小组 | evaluator1 | password123 | 手动评分 |
| 考评小组 | evaluator2 | password123 | 手动评分 |
| 考评办公室 | office1 | password123 | 手动评分、确定最终得分 |

---

## 🐛 可能的问题和解决方案

### 问题1：前端页面空白或无数据
**原因**：API响应数据结构不匹配  
**解决**：修改 `ManualScoring.vue` 中的数据处理逻辑（见方案2）

### 问题2：401未授权错误
**原因**：Token未正确存储或传递  
**解决**：
1. 检查登录后token是否存储到localStorage
2. 检查API请求是否携带Authorization header
3. 重新登录

### 问题3：404 Not Found错误
**原因**：API路径不正确  
**解决**：
1. 检查 `frontend/.env.development` 中的 `VITE_API_BASE_URL`
2. 确保后端服务运行在 http://localhost:8000
3. 检查API路由配置

### 问题4：CORS跨域错误
**原因**：前后端跨域配置问题  
**解决**：
1. 检查后端CORS配置（`backend/app/main.py`）
2. 确保允许前端域名访问

---

## 📝 下一步行动

### 立即执行
1. ✅ 后端API测试 - 已完成，正常工作
2. ⏳ 前端页面测试 - 需要用户在浏览器中测试
3. ⏳ 检查浏览器控制台错误 - 需要用户提供错误信息

### 如果前端有问题
1. 修改 `frontend/src/views/ManualScoring.vue` 的数据处理逻辑
2. 检查API客户端配置
3. 检查环境变量配置

### 如果前端正常
1. 测试完整的手动评分流程
2. 验证评分提交功能
3. 验证最终得分计算功能

---

## 📞 需要用户提供的信息

为了进一步诊断问题，请提供以下信息：

1. **浏览器控制台错误**：
   - 打开浏览器开发者工具（F12）
   - 切换到Console标签
   - 截图或复制错误信息

2. **网络请求信息**：
   - 打开浏览器开发者工具（F12）
   - 切换到Network标签
   - 刷新页面
   - 查看 `/api/scoring/evaluations-for-scoring` 请求
   - 截图或复制请求和响应信息

3. **页面显示情况**：
   - 手动评分页面是否显示
   - 是否显示"暂无待评分的教研室"
   - 是否显示加载动画
   - 是否有其他错误提示

---

## 🎯 总结

**当前状态**：
- ✅ 后端API正常工作
- ✅ 数据库数据正确
- ⚠️ 前端页面需要验证

**最可能的问题**：
1. 前端API响应数据结构处理不正确
2. 前端token存储或传递有问题
3. 前端环境变量配置不正确

**推荐操作**：
1. 先在浏览器中测试前端页面
2. 检查浏览器控制台错误
3. 根据错误信息进行针对性修复

---

**文档创建时间**：2026年2月14日  
**诊断人员**：Kiro AI Assistant  
**状态**：等待用户反馈前端测试结果
