# 登录和提交问题快速修复指南

## 问题诊断

从截图看到两个错误：
1. **403 Forbidden** - 提交自评表时
2. **401 Unauthorized** - 上传附件时

## 根本原因

### 问题1：Token过期或无效
- 用户登录后，token可能已过期
- 或者token没有正确保存到localStorage

### 问题2：CORS配置
- 后端CORS配置可能不完整
- 需要允许所有必要的前端地址

## 修复步骤

### 步骤1：更新CORS配置

已修复 `backend/.env` 文件中的CORS配置：

```env
# CORS - 允许多个前端地址访问
BACKEND_CORS_ORIGINS=["http://localhost:3000","http://localhost:5173","http://127.0.0.1:3000","http://127.0.0.1:5173"]
```

### 步骤2：重启后端服务

**重要**：必须重启后端服务才能使CORS配置生效！

```powershell
# 1. 停止当前后端进程
# 找到Python进程ID
Get-Process | Where-Object {$_.ProcessName -like "*python*"}

# 停止进程（替换<PID>为实际进程ID）
Stop-Process -Id <PID>

# 2. 重新启动后端
cd backend
python -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

### 步骤3：清除浏览器缓存和重新登录

1. 打开浏览器开发者工具（F12）
2. 进入Application/应用程序标签
3. 清除LocalStorage中的所有数据
4. 刷新页面
5. 重新登录

### 步骤4：验证Token

登录后，在浏览器控制台执行：

```javascript
console.log('Token:', localStorage.getItem('token'))
console.log('User ID:', localStorage.getItem('userId'))
console.log('Role:', localStorage.getItem('role'))
```

确保这些值都存在且不为null。

## 快速测试

### 测试1：登录API

```powershell
$body = @{
    username = "director1"
    password = "password123"
    role = "teaching_office"
} | ConvertTo-Json

$response = Invoke-RestMethod -Uri "http://localhost:8000/api/auth/login" -Method POST -ContentType "application/json" -Body $body

$response | ConvertTo-Json
```

预期输出：包含token、userId、role等字段

### 测试2：提交自评表API

```powershell
# 使用上面获取的token
$token = "你的token"
$headers = @{Authorization = "Bearer $token"}

$body = @{
    teaching_office_id = "00000000-0000-0000-0000-000000000001"
    evaluation_year = 2026
    content = @{
        regularTeaching = @{
            teachingProcessManagement = @{
                content = "测试内容"
                selfScore = 8
                maxScore = 10
            }
        }
    }
} | ConvertTo-Json -Depth 10

try {
    $response = Invoke-RestMethod -Uri "http://localhost:8000/api/teaching-office/self-evaluation" -Method POST -Headers $headers -ContentType "application/json" -Body $body
    $response | ConvertTo-Json
} catch {
    Write-Host "错误: $($_.Exception.Message)"
    Write-Host "响应: $($_.Exception.Response)"
}
```

## 常见问题排查

### Q1: 仍然出现403错误

**可能原因**：
1. 后端服务没有重启
2. Token过期
3. 用户角色不匹配

**解决方法**：
1. 确认后端服务已重启
2. 重新登录获取新token
3. 检查用户角色是否正确

### Q2: 仍然出现401错误

**可能原因**：
1. Token没有正确发送
2. Token格式错误
3. Token已过期

**解决方法**：
1. 检查请求头中是否包含Authorization
2. 确认格式为 `Bearer <token>`
3. 重新登录获取新token

### Q3: 附件上传失败

**可能原因**：
1. 自评表未保存
2. evaluation_id不正确
3. Token无效

**解决方法**：
1. 先保存自评表，获取evaluation_id
2. 使用正确的evaluation_id上传附件
3. 确保token有效

## 完整的操作流程

### 正确的提交流程：

1. **登录**
   - 访问 http://localhost:3000
   - 点击"教研室端"
   - 输入：director1 / password123
   - 点击登录

2. **填写自评表**
   - 点击"自评表填写"
   - 填写所有必填项
   - （可选）选择考核指标并上传附件

3. **提交表单**
   - 点击"提交表单"或"提交表单并上传附件"
   - 系统会自动：
     - 保存自评表
     - 上传附件（如果有）
     - 提交并锁定
     - 触发AI评分
     - 跳转到主页

## 调试技巧

### 1. 查看网络请求

打开浏览器开发者工具（F12） → Network标签

检查每个请求：
- 请求URL是否正确
- 请求头是否包含Authorization
- 响应状态码
- 响应内容

### 2. 查看控制台错误

打开浏览器开发者工具（F12） → Console标签

查看是否有JavaScript错误或警告

### 3. 查看后端日志

```powershell
# 查看后端实时日志
cd backend
Get-Content error.log -Wait -Tail 50
```

## 紧急修复脚本

如果以上方法都不行，执行以下脚本重置所有服务：

```powershell
# 停止所有服务
Get-Process | Where-Object {$_.ProcessName -like "*python*"} | Stop-Process -Force
Get-Process | Where-Object {$_.ProcessName -like "*node*"} | Stop-Process -Force

# 等待3秒
Start-Sleep -Seconds 3

# 启动后端（在新窗口）
Start-Process powershell -ArgumentList "-NoExit", "-Command", "cd backend; python -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000"

# 等待5秒让后端启动
Start-Sleep -Seconds 5

# 启动前端（在新窗口）
Start-Process powershell -ArgumentList "-NoExit", "-Command", "cd frontend; npm run dev"

Write-Host "服务已重启！"
Write-Host "前端: http://localhost:3000"
Write-Host "后端: http://localhost:8000"
Write-Host "API文档: http://localhost:8000/docs"
```

## 验证修复

修复后，按以下步骤验证：

1. ✅ 访问 http://localhost:3000
2. ✅ 登录成功
3. ✅ 填写自评表
4. ✅ 上传附件（可选）
5. ✅ 提交成功
6. ✅ 自动跳转到主页

## 联系支持

如果问题仍然存在，请提供：
1. 浏览器控制台截图
2. Network标签中失败请求的详细信息
3. 后端error.log文件内容

---

**最后更新**: 2026年2月14日  
**状态**: 已修复CORS配置，需要重启后端服务
