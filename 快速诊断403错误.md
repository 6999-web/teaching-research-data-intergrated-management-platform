# 快速诊断 403 错误

## 快速检查清单

### 1. 检查后端日志

打开后端服务的输出窗口，查看是否有以下日志：

```
RoleChecker: Checking user director1 with role teaching_office against allowed roles ['teaching_office']
RoleChecker: Access granted for user director1
```

**如果看到这些日志，说明权限检查通过了。**

如果看到以下日志，说明权限检查失败：

```
RoleChecker: Access denied for user director1. Role evaluation_team not in ['teaching_office']
```

### 2. 检查浏览器控制台

打开浏览器开发者工具 (F12)，进入 Console 标签页，查看是否有错误信息。

### 3. 检查 Network 标签页

1. 打开 Network 标签页
2. 提交自评表
3. 找到 `/api/teaching-office/self-evaluation` 请求
4. 查看 Response 中的错误信息

**预期的错误信息**:
```json
{
  "detail": "Access denied. Required roles: teaching_office. Your role: evaluation_team"
}
```

这表示用户的角色不是 `teaching_office`。

### 4. 检查 LocalStorage

在浏览器控制台中执行：

```javascript
console.log('Token:', localStorage.getItem('token'));
console.log('User Role:', localStorage.getItem('userRole'));
console.log('User ID:', localStorage.getItem('userId'));
```

**预期结果**:
```
Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
User Role: teaching_office
User ID: 10000000-0000-0000-0000-000000000001
```

### 5. 解码 Token

在浏览器控制台中执行：

```javascript
const token = localStorage.getItem('token');
const parts = token.split('.');
const payload = JSON.parse(atob(parts[1]));
console.log('Token Payload:', payload);
```

**预期结果**:
```
Token Payload: {
  sub: "director1",
  user_id: "10000000-0000-0000-0000-000000000001",
  role: "teaching_office",
  exp: 1739612345
}
```

## 常见问题和解决方案

### 问题 1: Token 中的角色是 `evaluation_team`

**原因**: 用户以错误的角色登录

**解决方案**:
1. 清除 LocalStorage: `localStorage.clear()`
2. 刷新页面
3. 重新登录，确保选择"教研室端"

### 问题 2: 数据库中没有 director1 用户

**原因**: 初始化脚本没有被执行

**解决方案**:
1. 执行初始化脚本: `mysql -u root -p teaching_office_evaluation < backend/init_test_data.sql`
2. 重新登录

### 问题 3: 数据库中的 director1 角色不是 `teaching_office`

**原因**: 用户角色被错误地设置

**解决方案**:
1. 执行 SQL: `UPDATE users SET role = 'teaching_office' WHERE username = 'director1';`
2. 重新登录

## 一键修复脚本

### 修复 1: 清除浏览器缓存

在浏览器控制台中执行：

```javascript
localStorage.clear();
sessionStorage.clear();
location.reload();
```

### 修复 2: 重新初始化数据库

在命令行中执行：

```bash
# 进入 backend 目录
cd backend

# 执行初始化脚本
mysql -u root -p teaching_office_evaluation < init_test_data.sql
```

### 修复 3: 修复用户角色

在 MySQL 中执行：

```sql
USE teaching_office_evaluation;
UPDATE users SET role = 'teaching_office' WHERE username = 'director1';
SELECT username, role FROM users WHERE username = 'director1';
```

## 最终检查

完成以上步骤后，按照以下步骤进行最终检查：

1. **清除浏览器缓存** - `localStorage.clear()`
2. **刷新页面** - `F5`
3. **重新登录** - 使用 director1 / password123
4. **提交自评表** - 填写表单并提交
5. **检查结果** - 应该看到成功提示

如果仍然收到 403 错误，请查看后端日志中的详细信息，并根据错误信息进行相应的修复。
